'use strict';Object.defineProperty(exports,'__esModule',{value:true});exports.Socket=undefined;var _events=require('events');var _events2=_interopRequireDefault(_events);var _net=require('net');var _net2=_interopRequireDefault(_net);var _utils=require('../utils');var _config=require('./config');var _dnsCache=require('./dns-cache');var _balancer=require('./balancer');var _pipe=require('./pipe');var _middleware=require('./middleware');var _defs=require('../presets/defs');var _behaviours=require('../behaviours');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _asyncToGenerator(fn){return function(){var gen=fn.apply(this,arguments);return new Promise(function(resolve,reject){function step(key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{return Promise.resolve(value).then(function(value){step('next',value)},function(err){step('throw',err)})}}return step('next')})}}const MAX_BUFFERED_SIZE=1024*1024;let lastServer=null;function selectServer(){const server=_balancer.Balancer.getFastest();if(lastServer===null||server.id!==lastServer.id){_config.Config.initServer(server);lastServer=server;_utils.logger.info(`[balancer] use: ${server.host}:${server.port}`)}}class Socket extends _events2.default{constructor({socket}){super();this._dnsCache=null;this._isConnectedToDst=false;this._remoteHost='';this._remotePort='';this._bsocket=null;this._fsocket=null;this._pipe=null;this._presets=[];this.onForward=this.onForward.bind(this);this.onBackward=this.onBackward.bind(this);this.onError=this.onError.bind(this);this.onBackwardSocketDrain=this.onBackwardSocketDrain.bind(this);this.onBackwardSocketTimeout=this.onBackwardSocketTimeout.bind(this);this.onBackwardSocketClose=this.onBackwardSocketClose.bind(this);this.onForwardSocketDrain=this.onForwardSocketDrain.bind(this);this.onForwardSocketTimeout=this.onForwardSocketTimeout.bind(this);this.onForwardSocketClose=this.onForwardSocketClose.bind(this);this.onPipeNotified=this.onPipeNotified.bind(this);this.sendForward=this.sendForward.bind(this);this.sendBackward=this.sendBackward.bind(this);this.connect=this.connect.bind(this);this.setPresets=this.setPresets.bind(this);this.destroy=this.destroy.bind(this);this._dnsCache=new _dnsCache.DNSCache({expire:__DNS_EXPIRE__});this._remoteHost=socket.remoteAddress;this._remotePort=socket.remotePort;this._bsocket=socket;this._bsocket.on('error',this.onError);this._bsocket.on('close',this.onBackwardSocketClose);this._bsocket.on('timeout',this.onBackwardSocketTimeout.bind(this,{host:this._remoteHost,port:this._remotePort}));this._bsocket.on('data',this.onForward);this._bsocket.on('drain',this.onBackwardSocketDrain);this._bsocket.setTimeout(__TIMEOUT__);if(__IS_CLIENT__){selectServer()}let presets=__PRESETS__;if(__IS_CLIENT__&&presets[0].name!=='proxy'){presets=[{name:'proxy'}].concat(presets)}if(presets[presets.length-1].name!=='tracker'){presets=presets.concat([{name:'tracker'}])}this._presets=presets;this._pipe=this.createPipe(presets);this._pipe.onBroadcast({type:_defs.CONNECTION_CREATED,payload:{host:this._remoteHost,port:this._remotePort}})}get remote(){return`${this._remoteHost}:${this._remotePort}`}get fsocketWritable(){return this._fsocket&&!this._fsocket.destroyed&&this._fsocket.writable}get bsocketWritable(){return this._bsocket&&!this._bsocket.destroyed&&this._bsocket.writable}onError(err){_utils.logger.warn(`[socket] [${this.remote}] ${err.code} - ${err.message}`)}onForward(buffer){if(this.fsocketWritable||!this._isConnectedToDst){const direction=__IS_CLIENT__?_middleware.MIDDLEWARE_DIRECTION_UPWARD:_middleware.MIDDLEWARE_DIRECTION_DOWNWARD;this._pipe.feed(direction,buffer)}if(this._fsocket&&this._fsocket.bufferSize>=MAX_BUFFERED_SIZE){this._bsocket.pause()}}onForwardSocketDrain(){if(this._bsocket&&!this._bsocket.destroyed){this._bsocket.resume()}}onForwardSocketTimeout({host,port}){_utils.logger.warn(`[socket] [${host}:${port}] timeout: no I/O on the connection for ${__TIMEOUT__/1e3}s`);this.onForwardSocketClose()}onForwardSocketClose(){if(this._fsocket){this._fsocket.destroy();this._fsocket=null}if(this._bsocket){if(this._bsocket.bufferSize>0){this._bsocket.removeListener('drain',this.onBackwardSocketDrain);this._bsocket.on('drain',this.onBackwardSocketClose)}else{this.onBackwardSocketClose()}}}onBackward(buffer){if(this.bsocketWritable){const direction=__IS_CLIENT__?_middleware.MIDDLEWARE_DIRECTION_DOWNWARD:_middleware.MIDDLEWARE_DIRECTION_UPWARD;this._pipe.feed(direction,buffer)}if(this._bsocket&&this._bsocket.bufferSize>=MAX_BUFFERED_SIZE){this._fsocket.pause()}}onBackwardSocketDrain(){if(this._fsocket&&!this._fsocket.destroyed){this._fsocket.resume()}}onBackwardSocketTimeout({host,port}){_utils.logger.warn(`[socket] [${host}:${port}] timeout: no I/O on the connection for ${__TIMEOUT__/1e3}s`);this.onBackwardSocketClose()}onBackwardSocketClose(){if(this._bsocket){this._bsocket.destroy();this._bsocket=null;this._pipe.onBroadcast({type:_defs.CONNECTION_CLOSED,payload:{host:this._remoteHost,port:this._remotePort}});this._pipe.destroy();this._pipe=null;this.emit('close')}if(this._fsocket){if(this._fsocket.bufferSize>0){this._fsocket.removeListener('drain',this.onForwardSocketDrain);this._fsocket.on('drain',this.onForwardSocketClose)}else{this.onForwardSocketClose()}}}sendForward(buffer){if(__IS_CLIENT__){this.fsocketWritable&&this._fsocket.write(buffer)}else{this.bsocketWritable&&this._bsocket.write(buffer)}}sendBackward(buffer){if(__IS_CLIENT__){this.bsocketWritable&&this._bsocket.write(buffer)}else{this.fsocketWritable&&this._fsocket.write(buffer)}}connect({host,port}){var _this=this;return _asyncToGenerator(function*(){if(!(0,_utils.isValidHostname)(host)||!(0,_utils.isValidPort)(port)){_utils.logger.warn(`unexpected host=${host} port=${port}`);_this.onBackwardSocketClose();return}let ip=null;try{ip=yield _this._dnsCache.get(host)}catch(err){_utils.logger.error(`[socket] [${_this.remote}] fail to resolve host ${host}:${port}: ${err.message}`)}_utils.logger.info(`[socket] [${_this.remote}] connecting to: ${host}(${ip}):${port}`);return new Promise(function(resolve){if(_this._fsocket&&!_this._fsocket.destroyed){_this._fsocket.destroy();_this._fsocket=null}_this._fsocket=_net2.default.connect({host:ip,port},function(){return resolve(_this._fsocket)});_this._fsocket.on('error',_this.onError);_this._fsocket.on('close',_this.onForwardSocketClose);_this._fsocket.on('timeout',_this.onForwardSocketTimeout.bind(_this,{host,port}));_this._fsocket.on('data',_this.onBackward);_this._fsocket.on('drain',_this.onForwardSocketDrain);_this._fsocket.setTimeout(__TIMEOUT__)})})()}setPresets(callback){this._presets=callback(this._presets);this._pipe.removeAllListeners();this._pipe.destroy();this._pipe=this.createPipe(this._presets)}createPipe(presets){const middlewares=presets.map(preset=>(0,_middleware.createMiddleware)(preset.name,preset.params||{}));const pipe=new _pipe.Pipe({onNotified:this.onPipeNotified});pipe.setMiddlewares(_middleware.MIDDLEWARE_DIRECTION_UPWARD,middlewares);pipe.on(`next_${_middleware.MIDDLEWARE_DIRECTION_UPWARD}`,this.sendForward);pipe.on(`next_${_middleware.MIDDLEWARE_DIRECTION_DOWNWARD}`,this.sendBackward);return pipe}onPipeNotified(action){var _this2=this;return _asyncToGenerator(function*(){switch(action.type){case _defs.SOCKET_CONNECT_TO_REMOTE:{var _action$payload=action.payload;const host=_action$payload.host,port=_action$payload.port,onConnected=_action$payload.onConnected;if(__IS_SERVER__){yield _this2.connect({host,port})}if(__IS_CLIENT__){_utils.logger.info(`[socket] [${_this2.remote}] request: ${host}:${port}`);selectServer();yield _this2.connect({host:__SERVER_HOST__,port:__SERVER_PORT__})}_this2._isConnectedToDst=true;if(typeof onConnected==='function'){onConnected()}break}case _defs.PROCESSING_FAILED:{const props={remoteHost:_this2._remoteHost,remotePort:_this2._remotePort,onClose:_this2.destroy,connect:_this2.connect,setPresets:_this2.setPresets,action:action};var _action$payload2=action.payload;const name=_action$payload2.name,message=_action$payload2.message;_utils.logger.error(`[socket] [${_this2.remote}] preset "${name}" fail to process: ${message}`);yield __BEHAVIOURS__[_behaviours.BEHAVIOUR_EVENT_ON_PRESET_FAILED].run(props);break}default:break;}})()}destroy(){this.onForwardSocketClose();this.onBackwardSocketClose()}}exports.Socket=Socket;