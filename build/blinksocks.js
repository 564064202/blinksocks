/*!
 * Copyright (c) 2016-present, blinksocks. All rights reserved.
 * 
 * name: blinksocks.js
 * version: v2.6.3
 * hash: e9a54123c103e1822f86
 */
module.exports=function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e['default']}:function(){return e};return t.d(n,'a',n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p='',t(t.s=52)}([function(e,t,n){'use strict';Object.defineProperty(t,'__esModule',{value:!0});var r=n(67);Object.keys(r).forEach(function(e){'default'===e||'__esModule'===e||Object.defineProperty(t,e,{enumerable:!0,get:function(){return r[e]}})});var o=n(68);Object.keys(o).forEach(function(e){'default'===e||'__esModule'===e||Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}})});var a=n(70);Object.keys(a).forEach(function(e){'default'===e||'__esModule'===e||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}})});var s=n(71);Object.keys(s).forEach(function(e){'default'===e||'__esModule'===e||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}})});var i=n(72);Object.keys(i).forEach(function(e){'default'===e||'__esModule'===e||Object.defineProperty(t,e,{enumerable:!0,get:function(){return i[e]}})});var d=n(73);Object.keys(d).forEach(function(e){'default'===e||'__esModule'===e||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}})});var l=n(74);Object.keys(l).forEach(function(e){'default'===e||'__esModule'===e||Object.defineProperty(t,e,{enumerable:!0,get:function(){return l[e]}})})},function(e,t){'use strict';Object.defineProperty(t,'__esModule',{value:!0});const n=t.CONNECTION_CREATED='@action:connection_created',r=t.CONNECTION_CLOSED='@action:connection_closed',o=t.CONNECTION_WILL_CLOSE='@action:connection_will_close',a=t.CONNECT_TO_REMOTE='@action:connect_to_remote',s=t.PRESET_FAILED='@action:preset_failed',i=t.PRESET_CLOSE_CONNECTION='@action:preset_close_connection',d=t.PRESET_PAUSE_RECV='@action:preset_pause_recv',l=t.PRESET_PAUSE_SEND='@action:preset_pause_send',u=t.PRESET_RESUME_RECV='@action:preset_resume_recv',c=t.PRESET_RESUME_SEND='@action:preset_resume_send';class p{static checkParams(){}static onInit(){}onNotified(){return!1}onDestroy(){}beforeOut({buffer:e}){return e}beforeIn({buffer:e}){return e}clientOut({buffer:e}){return e}serverIn({buffer:e}){return e}serverOut({buffer:e}){return e}clientIn({buffer:e}){return e}next(){}broadcast(){}fail(){}}t.IPreset=p;class f extends p{constructor(){if(super(),f.isInstantiated)throw Error(`${this.constructor.name} is singleton and can only be instantiated once`);f.isInstantiated=!0}}t.IPresetStatic=f,f.isInstantiated=!1},function(e){e.exports=require('crypto')},function(e){e.exports=require('events')},function(e){e.exports=require('fs')},function(e){e.exports=require('net')},function(e){e.exports=require('os')},function(e){e.exports=require('util')},function(e){e.exports=require('path')},function(e,t,n){'use strict';function r(e){var n=Array.isArray(e)?[]:{};for(var r in e)Array.isArray(e[r])?n[r]=e[r].slice(0):e[r]instanceof Buffer?n[r]=e[r].slice(0):'function'==typeof e[r]?'function'==typeof e[r]&&(n[r]=e[r]):n[r]=e[r]instanceof Object?t.clone(e[r]):e[r];return n}var o=n(7),a=n(2),s=n(78),i=n(4),d=n(79).StringDecoder,l=n(11).Stream,u=n(23);t.setLevels=function(e,n,r){this;return n&&Object.keys(n).forEach(function(t){delete e[t]}),e.levels=r||u.npm.levels,e.padLevels&&(e.levelLength=t.longestElement(Object.keys(e.levels))),Object.keys(e.levels).forEach(function(t){return'log'===t?void console.warn('Log level named "log" will clash with the method "log". Consider using a different name.'):void(e[t]=function(){var n=[t].concat(Array.prototype.slice.call(arguments));e.log.apply(e,n)})}),e},t.longestElement=function(e){return Math.max.apply(null,e.map(function(e){return e.length}))},t.clone=function(e){if(e instanceof Error){var t={message:e.message};return Object.getOwnPropertyNames(e).forEach(function(n){t[n]=e[n]}),t}return e instanceof Object?e instanceof Date?new Date(e.getTime()):r(s.decycle(e)):e},t.log=function(e){var n='function'==typeof e.timestamp?e.timestamp:t.timestamp,r=e.timestamp?n():null,a=void 0===e.showLevel||e.showLevel,s=null===e.meta||void 0===e.meta||e.meta instanceof Error?e.meta||null:t.clone(e.meta),i;if(e.raw)return'object'!=typeof s&&null!=s&&(s={meta:s}),i=t.clone(s)||{},i.level=e.level,i.message=e.message.stripColors?e.message.stripColors:e.message,JSON.stringify(i);if(e.json||!0===e.logstash){if('object'!=typeof s&&null!=s&&(s={meta:s}),i=t.clone(s)||{},i.level=e.level,i.message=i.message||'',e.label&&(i.label=e.label),e.message&&(i.message=e.message),r&&(i.timestamp=r),!0===e.logstash){var d={};void 0!==i.message&&(d['@message']=i.message,delete i.message),void 0!==i.timestamp&&(d['@timestamp']=i.timestamp,delete i.timestamp),d['@fields']=t.clone(i),i=d}return'function'==typeof e.stringify?e.stringify(i):JSON.stringify(i,function(e,t){return t instanceof Buffer?t.toString('base64'):t})}if('function'==typeof e.formatter)return e.meta=s||e.meta,e.formatter(t.clone(e))+'';if(i=r?r+' - ':'',a&&(i+='all'===e.colorize||'level'===e.colorize||!0===e.colorize?u.colorize(e.level):e.level),i+=e.align?'\t':'',i+=r||a?': ':'',i+=e.label?'['+e.label+'] ':'',i+='all'===e.colorize||'message'===e.colorize?u.colorize(e.level,e.message):e.message,null!==s&&void 0!==s)if(s&&s instanceof Error&&s.stack&&(s=s.stack),'object'!=typeof s)i+=' '+s;else if(0<Object.keys(s).length)if('function'==typeof e.prettyPrint)i+=' '+e.prettyPrint(s);else if(e.prettyPrint)i+=' \n'+o.inspect(s,!1,e.depth||null,e.colorize);else if(e.humanReadableUnhandledException&&5<=Object.keys(s).length&&s.hasOwnProperty('date')&&s.hasOwnProperty('process')&&s.hasOwnProperty('os')&&s.hasOwnProperty('trace')&&s.hasOwnProperty('stack')){var l=s.stack;delete s.stack,delete s.trace,i+=' '+t.serialize(s),l&&(i+='\n'+l.join('\n'))}else i+=' '+t.serialize(s);return i},t.capitalize=function(e){return e&&e[0].toUpperCase()+e.slice(1)},t.hash=function(e){return a.createHash('sha1').update(e).digest('hex')},t.pad=function(e){return 10>e?'0'+e.toString(10):e.toString(10)},t.timestamp=function(){return new Date().toISOString()},t.serialize=function(e,n){if('symbol'==typeof n&&(n=n.toString()),'symbol'==typeof e&&(e=e.toString()),null===e?e='null':void 0===e?e='undefined':!1===e&&(e='false'),'object'!=typeof e)return n?n+'='+e:e;if(e instanceof Buffer)return n?n+'='+e.toString('base64'):e.toString('base64');for(var r='',o=Object.keys(e),a=o.length,s=0;s<a;s++){if(Array.isArray(e[o[s]])){r+=o[s]+'=[';for(var i=0,d=e[o[s]].length;i<d;i++)r+=t.serialize(e[o[s]][i]),i<d-1&&(r+=', ');r+=']'}else r+=e[o[s]]instanceof Date?o[s]+'='+e[o[s]]:t.serialize(e[o[s]],o[s]);s<a-1&&(r+=', ')}return r},t.tailFile=function(e,t){var n=new Buffer(65536),r=new d('utf8'),o=new l,a='',s=0,u=0;return-1===e.start&&delete e.start,o.readable=!0,o.destroy=function(){o.destroyed=!0,o.emit('end'),o.emit('close')},i.open(e.file,'a+','0644',function(d,l){return d?(t?t(d):o.emit('error',d),void o.destroy()):void function d(){return o.destroyed?void i.close(l):i.read(l,n,0,n.length,s,function(c,p){if(c)return t?t(c):o.emit('error',c),void o.destroy();if(!p)return a&&((null==e.start||u>e.start)&&(t?t(null,a):o.emit('line',a)),u++,a=''),setTimeout(d,1e3);var f=r.write(n.slice(0,p));t||o.emit('data',f);for(var f=(a+f).split(/\n+/),_=f.length-1,l=0;l<_;l++)(null==e.start||u>e.start)&&(t?t(null,f[l]):o.emit('line',f[l])),u++;return a=f[_],s+=p,d()})}()}),t?o.destroy:o},t.stringArrayToSet=function(e,t){return'undefined'==typeof t&&(t='Cannot make set from Array with non-string elements'),e.reduce(function(e,n){if(!('string'==typeof n||n instanceof String))throw new Error(t);return e[n]=!0,e},Object.create(null))}},function(e,t,n){'use strict';var r=t;r.version=n(75).version,r.transports=n(76);var o=n(9);r.hash=o.hash,r.clone=o.clone,r.longestElement=o.longestElement,r.exception=n(31),r.config=n(23),r.addColors=r.config.addColors,r.Container=n(98).Container,r.Logger=n(99).Logger,r.Transport=n(15).Transport,r.loggers=new r.Container;var a=new r.Logger({transports:[new r.transports.Console]});o.setLevels(r,null,a.levels),['log','query','stream','add','remove','clear','profile','startTimer','extend','cli','handleExceptions','unhandleExceptions','configure'].forEach(function(e){r[e]=function(){return a[e].apply(a,arguments)}}),r.cli=function(){return r.padLevels=!0,o.setLevels(r,a.levels,r.config.cli.levels),a.setLevels(r.config.cli.levels),r.config.addColors(r.config.cli.colors),a.transports.console&&(a.transports.console.colorize=!0,a.transports.console.timestamp=!1),r},r.setLevels=function(e){o.setLevels(r,a.levels,e),a.setLevels(e)},Object.defineProperty(r,'level',{get:function(){return a.level},set:function(e){a.level=e,Object.keys(a.transports).forEach(function(t){a.transports[t].level=e})}}),['emitErrs','exitOnError','padLevels','levelLength','stripColors'].forEach(function(e){Object.defineProperty(r,e,{get:function(){return a[e]},set:function(t){a[e]=t}})}),Object.defineProperty(r,'default',{get:function(){return{transports:a.transports,exceptionHandlers:a.exceptionHandlers}}})},function(e){e.exports=require('stream')},function(e,t,n){'use strict';function r(e,t){for(var n in e)t[n]=e[n]}function o(e,t,n){return s(e,t,n)}var a=n(35),s=a.Buffer;s.from&&s.alloc&&s.allocUnsafe&&s.allocUnsafeSlow?e.exports=a:(r(a,t),t.Buffer=o),r(s,o),o.from=function(e,t,n){if('number'==typeof e)throw new TypeError('Argument must not be a number');return s(e,t,n)},o.alloc=function(e,t,n){if('number'!=typeof e)throw new TypeError('Argument must be a number');var r=s(e);return void 0===t?r.fill(0):'string'==typeof n?r.fill(t,n):r.fill(t),r},o.allocUnsafe=function(e){if('number'!=typeof e)throw new TypeError('Argument must be a number');return s(e)},o.allocUnsafeSlow=function(e){if('number'!=typeof e)throw new TypeError('Argument must be a number');return a.SlowBuffer(e)}},function(e,t,n){'use strict';Object.defineProperty(t,'__esModule',{value:!0});var r=n(28);Object.keys(r).forEach(function(e){'default'===e||'__esModule'===e||Object.defineProperty(t,e,{enumerable:!0,get:function(){return r[e]}})});var o=n(32);Object.keys(o).forEach(function(e){'default'===e||'__esModule'===e||Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}})});var a=n(38);Object.keys(a).forEach(function(e){'default'===e||'__esModule'===e||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}})});var s=n(118);Object.keys(s).forEach(function(e){'default'===e||'__esModule'===e||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}})});var i=n(51);Object.keys(i).forEach(function(e){'default'===e||'__esModule'===e||Object.defineProperty(t,e,{enumerable:!0,get:function(){return i[e]}})});var d=n(18);Object.keys(d).forEach(function(e){'default'===e||'__esModule'===e||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}})});var l=n(128);Object.keys(l).forEach(function(e){'default'===e||'__esModule'===e||Object.defineProperty(t,e,{enumerable:!0,get:function(){return l[e]}})})},function(e,t,n){'use strict';function r(e){var t=function e(){return o.apply(e,arguments)};return t._styles=e,t.__proto__=f,t}function o(){var e=arguments,t=e.length,n=0!==t&&arguments[0]+'';if(1<t)for(var r=1;r<t;r++)n+=' '+e[r];if(!s.enabled||!n)return n;for(var o=this._styles,a=o.length,i;a--;)i=d[o[a]],n=i.open+n.replace(i.closeRe,i.open)+i.close;return n}function a(e){for(var t in e)(function(t){s[t]=function(n){return s[e[t]](n)}})(t)}var s={};e.exports=s,s.themes={};var d=s.styles=n(81),i=Object.defineProperties;s.supportsColor=n(82),'undefined'==typeof s.enabled&&(s.enabled=s.supportsColor),s.stripColors=s.strip=function(e){return(''+e).replace(/\x1B\[\d+m/g,'')};var l=s.stylize=function(e,t){return d[t].open+e+d[t].close},u=/[|\\{}()[\]^$+*?.]/g,c=function(e){if('string'!=typeof e)throw new TypeError('Expected a string');return e.replace(u,'\\$&')},p=function(){var e={};return d.grey=d.gray,Object.keys(d).forEach(function(t){d[t].closeRe=new RegExp(c(d[t].close),'g'),e[t]={get:function(){return r(this._styles.concat(t))}}}),e}(),f=i(function(){},p);s.setTheme=function(e){if('string'==typeof e)try{return s.themes[e]=!function(){var t=new Error('Cannot find module "."');throw t.code='MODULE_NOT_FOUND',t}(),a(s.themes[e]),s.themes[e]}catch(e){return console.log(e),e}else a(e)};var _=function(e,t){var n=t.split('');return n=n.map(e),n.join('')};for(var m in s.trap=n(84),s.zalgo=n(85),s.maps={},s.maps.america=n(86),s.maps.zebra=n(87),s.maps.rainbow=n(88),s.maps.random=n(89),s.maps)(function(e){s[e]=function(t){return _(s.maps[e],t)}})(m);i(s,function(){var e={};return Object.keys(p).forEach(function(t){e[t]={get:function(){return r([t])}}}),e}())},function(e,t,n){'use strict';var r=n(3),o=n(7),a=t.Transport=function(e){r.EventEmitter.call(this),e=e||{},this.silent=e.silent||!1,this.raw=e.raw||!1,this.name=e.name||this.name,this.formatter=e.formatter,this.level=e.level,this.handleExceptions=e.handleExceptions||!1,this.exceptionsLevel=e.exceptionsLevel||'error',this.humanReadableUnhandledException=e.humanReadableUnhandledException||!1};o.inherits(a,r.EventEmitter),a.prototype.formatQuery=function(e){return e},a.prototype.normalizeQuery=function(e){return e=e||{},e.rows=e.rows||e.limit||10,e.start=e.start||0,e.until=e.until||new Date,'object'!=typeof e.until&&(e.until=new Date(e.until)),e.from=e.from||e.until-86400000,'object'!=typeof e.from&&(e.from=new Date(e.from)),e.order=e.order||'desc',e.fields=e.fields,e},a.prototype.formatResults=function(e){return e},a.prototype.logException=function(e,t,n){function r(){a||(a=!0,o.removeListener('logged',r),o.removeListener('error',r),n())}var o=this,a;return this.silent?n():void(this.once('logged',r),this.once('error',r),this.log(o.exceptionsLevel,e,t,function(){}))}},function(e,t,n){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,'__esModule',{value:!0}),t.legacyPresets=t.presets=t.getPresetClassByName=void 0;var o=Object.assign||function(e){for(var t=1,n;t<arguments.length;t++)for(var r in n=arguments[t],n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r]);return e},a=n(1);Object.keys(a).forEach(function(e){'default'===e||'__esModule'===e||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}})});var s=n(101),i=r(s),d=n(102),l=r(d),u=n(103),c=r(u),p=n(104),f=r(p),_=n(36),m=r(_),g=n(37),h=r(g),y=n(105),b=r(y),v=n(106),k=r(v),x=n(107),E=r(x),S=n(108),w=r(S),C=n(109),T=r(C),P=n(110),O=r(P),B=n(111),I=r(B),R=n(112),N=r(R),L=n(113),M=r(L),D=n(114),A=r(D),z=n(115),j=r(z);const F={tunnel:i.default,stats:l.default,tracker:c.default,"access-control":f.default,"base-with-padding":m.default,"base-auth-stream":h.default,"ss-base":b.default,"ss-stream-cipher":k.default,"ss-aead-cipher":E.default,"v2ray-vmess":w.default,"obfs-random-padding":T.default,"obfs-http":O.default,"obfs-tls1.2-ticket":I.default,"exp-compress":N.default,"aead-random-cipher":M.default},U={"exp-base-with-padding":A.default,"exp-base-auth-stream":j.default},H=Object.keys(F),W=Object.keys(U);t.getPresetClassByName=function(e){const t=o({},F,U)[e];if(t===void 0)throw Error(`cannot find preset: "${e}"`);return t},t.presets=H,t.legacyPresets=W},function(e,t,n){'use strict';function r(e){return e?e.toLowerCase():'ipv4'}var o=t,a=n(35).Buffer,s=n(6);o.toBuffer=function(e,t,n){n=~~n;var r;if(this.isV4Format(e))r=t||new a(n+4),e.split(/\./g).map(function(e){r[n++]=255&parseInt(e,10)});else if(this.isV6Format(e)){var o=e.split(':',8),s;for(s=0;s<o.length;s++){var i=this.isV4Format(o[s]),d;i&&(d=this.toBuffer(o[s]),o[s]=d.slice(0,2).toString('hex')),d&&8>++s&&o.splice(s,0,d.slice(2,4).toString('hex'))}if(''===o[0])for(;8>o.length;)o.unshift('0');else if(''===o[o.length-1])for(;8>o.length;)o.push('0');else if(8>o.length){for(s=0;s<o.length&&''!==o[s];s++);var l=[s,1];for(s=9-o.length;0<s;s--)l.push('0');o.splice.apply(o,l)}for(r=t||new a(n+16),s=0;s<o.length;s++){var u=parseInt(o[s],16);r[n++]=255&u>>8,r[n++]=255&u}}if(!r)throw Error('Invalid ip address: '+e);return r},o.toString=function(e,t,n){t=~~t,n=n||e.length-t;var r=[];if(4===n){for(var o=0;o<n;o++)r.push(e[t+o]);r=r.join('.')}else if(16===n){for(var o=0;o<n;o+=2)r.push(e.readUInt16BE(t+o).toString(16));r=r.join(':'),r=r.replace(/(^|:)0(:0)*:0(:|$)/,'$1::$3'),r=r.replace(/:{3,4}/,'::')}return r};var i=/^(\d{1,3}\.){3,3}\d{1,3}$/,d=/^(::)?(((\d{1,3}\.){3}(\d{1,3}){1})?([0-9a-f]){0,4}:{0,2}){1,8}(::)?$/i;o.isV4Format=function(e){return i.test(e)},o.isV6Format=function(e){return d.test(e)},o.fromPrefixLen=function(e,t){t=32<e?'ipv6':r(t);var s=4;'ipv6'===t&&(s=16);for(var d=new a(s),l=0,i=d.length,n;l<i;++l)n=8,8>e&&(n=e),e-=n,d[l]=255&~(255>>n);return o.toString(d)},o.mask=function(e,t){e=o.toBuffer(e),t=o.toBuffer(t);var n=new a(Math.max(e.length,t.length)),r=0;if(e.length===t.length)for(r=0;r<e.length;r++)n[r]=e[r]&t[r];else if(4===t.length)for(r=0;r<t.length;r++)n[r]=e[e.length-4+r]&t[r];else{for(var r=0;r<n.length-6;r++)n[r]=0;for(n[10]=255,n[11]=255,r=0;r<e.length;r++)n[r+12]=e[r]&t[r+12];r+=12}for(;r<n.length;r++)n[r]=0;return o.toString(n)},o.cidr=function(e){var t=e.split('/'),n=t[0];if(2!==t.length)throw new Error('invalid CIDR subnet: '+n);var r=o.fromPrefixLen(parseInt(t[1],10));return o.mask(n,r)},o.subnet=function(e,t){for(var n=o.toLong(o.mask(e,t)),r=o.toBuffer(t),a=0,s=0;s<r.length;s++)if(255===r[s])a+=8;else for(var i=255&r[s];i;)i=255&i<<1,a++;var d=Math.pow(2,32-a);return{networkAddress:o.fromLong(n),firstAddress:2>=d?o.fromLong(n):o.fromLong(n+1),lastAddress:2>=d?o.fromLong(n+d-1):o.fromLong(n+d-2),broadcastAddress:o.fromLong(n+d-1),subnetMask:t,subnetMaskLength:a,numHosts:2>=d?d:d-2,length:d,contains:function(e){return n===o.toLong(o.mask(e,t))}}},o.cidrSubnet=function(e){var t=e.split('/'),n=t[0];if(2!==t.length)throw new Error('invalid CIDR subnet: '+n);var r=o.fromPrefixLen(parseInt(t[1],10));return o.subnet(n,r)},o.not=function(e){for(var t=o.toBuffer(e),n=0;n<t.length;n++)t[n]=255^t[n];return o.toString(t)},o.or=function(e,t){if(e=o.toBuffer(e),t=o.toBuffer(t),e.length===t.length){for(var n=0;n<e.length;++n)e[n]|=t[n];return o.toString(e)}var r=e,a=t;t.length>e.length&&(r=t,a=e);for(var s=r.length-a.length,n=s;n<r.length;++n)r[n]|=a[n-s];return o.toString(r)},o.isEqual=function(e,n){if(e=o.toBuffer(e),n=o.toBuffer(n),e.length===n.length){for(var r=0;r<e.length;r++)if(e[r]!==n[r])return!1;return!0}if(4===n.length){var a=n;n=e,e=a}for(var r=0;10>r;r++)if(0!==n[r])return!1;var t=n.readUInt16BE(10);if(0!==t&&65535!==t)return!1;for(var r=0;4>r;r++)if(e[r]!==n[r+12])return!1;return!0},o.isPrivate=function(e){return /^(::f{4}:)?10\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(e)||/^(::f{4}:)?192\.168\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(e)||/^(::f{4}:)?172\.(1[6-9]|2\d|30|31)\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(e)||/^(::f{4}:)?127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(e)||/^(::f{4}:)?169\.254\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(e)||/^f[cd][0-9a-f]{2}:/i.test(e)||/^fe80:/i.test(e)||/^::1$/.test(e)||/^::$/.test(e)},o.isPublic=function(e){return!o.isPrivate(e)},o.isLoopback=function(e){return /^(::f{4}:)?127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})/.test(e)||/^fe80::1$/.test(e)||/^::1$/.test(e)||/^::$/.test(e)},o.loopback=function(e){if(e=r(e),'ipv4'!==e&&'ipv6'!==e)throw new Error('family must be ipv4 or ipv6');return'ipv4'===e?'127.0.0.1':'fe80::1'},o.address=function(e,t){var n=s.networkInterfaces(),a;if(t=r(t),e&&'private'!==e&&'public'!==e){var i=n[e].filter(function(e){var n=e.family.toLowerCase();return n===t});return 0===i.length?void 0:i[0].address}var a=Object.keys(n).map(function(r){var a=n[r].filter(function(n){return(n.family=n.family.toLowerCase(),!(n.family!==t||o.isLoopback(n.address)))&&(!e||('public'===e?o.isPrivate(n.address):o.isPublic(n.address)))});return a.length?a[0].address:void 0}).filter(Boolean);return a.length?a[0]:o.loopback(t)},o.toLong=function(e){var t=0;return e.split('.').forEach(function(e){t<<=8,t+=parseInt(e)}),t>>>0},o.fromLong=function(e){return(e>>>24)+'.'+(255&e>>16)+'.'+(255&e>>8)+'.'+(255&e)}},function(e,t,n){'use strict';function r(e,t){let n=l[e.name];return void 0===n&&(e.onInit(t),n=new e(t),l[e.name]=n),n}function o(e,t={}){const n=(0,i.getPresetClassByName)(e);let o=null;return n.__proto__.name===i.IPresetStatic.name?o=r(n,t):(!n.initialized&&(n.onInit(t),n.initialized=!0),o=new n(t)),o}Object.defineProperty(t,'__esModule',{value:!0}),t.Middleware=t.MIDDLEWARE_DIRECTION_DOWNWARD=t.MIDDLEWARE_DIRECTION_UPWARD=void 0,t.createMiddleware=function(e,t={}){try{const n=o(e,t);return new p(n)}catch(e){console.error(e.message),process.exit(-1)}return null},t.cleanup=function(){const e=Object.keys(l);var t=!0,n=!1,r;try{for(var o=e[Symbol.iterator](),a;!(t=(a=o.next()).done);t=!0){const e=a.value;l[e].onDestroy()}}catch(e){n=!0,r=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw r}}},t.reset=function(){l={},__PRESETS__.map(({name:e})=>(0,i.getPresetClassByName)(e)).forEach((e)=>e.initialized=!1)};var a=n(3),s=function(e){return e&&e.__esModule?e:{default:e}}(a),i=n(16),d=n(0);let l={};const u=t.MIDDLEWARE_DIRECTION_UPWARD=1,c=t.MIDDLEWARE_DIRECTION_DOWNWARD=-1;class p extends s.default{constructor(e){super(),this._impl=null,this.onPresetNext=this.onPresetNext.bind(this),this.onPresetBroadcast=this.onPresetBroadcast.bind(this),this.onPresetFail=this.onPresetFail.bind(this),this._impl=e,this._impl.next=this.onPresetNext,this._impl.broadcast=this.onPresetBroadcast,this._impl.fail=this.onPresetFail}get name(){return(0,d.kebabCase)(this._impl.constructor.name).replace(/(.*)-preset/i,'$1')}hasListener(e){return 0<this.listenerCount(e)}notify(e){return this._impl.onNotified(e)}onPresetNext(e,t){this.emit(`next_${e}`,t)}onPresetBroadcast(e){this.emit('broadcast',this.name,e)}onPresetFail(e){this.emit('fail',this.name,e)}onDestroy(){this._impl instanceof i.IPresetStatic||this._impl.onDestroy(),this.removeAllListeners()}write(e,{buffer:t,direct:n}){const r=e===u?'Out':'In',o=this.onPresetBroadcast,a=this.onPresetFail,s=(t,r=!1)=>{const o=this.emit(`next_${r?-e:e}`,t);o||n(t,r)},i=(e)=>{const t={buffer:e,next:s,broadcast:o,direct:n,fail:a},i=__IS_CLIENT__?this._impl[`client${r}`](t):this._impl[`server${r}`](t);i instanceof Buffer&&s(i)},d=this._impl[`before${r}`]({buffer:t,next:i,broadcast:o,direct:n,fail:a});d instanceof Buffer&&i(d)}}t.Middleware=p},function(e){e.exports=require('zlib')},function(e){e.exports=require('http')},function(e){e.exports=require('url')},function(e,t,n){'use strict';const r=n(12),o=n(19),a=n(119),s=n(24),i=r.Buffer,d=i.from([0,0,255,255]),l=i.from([0]);let u;class c{constructor(e,t,n){if(this._maxPayload=0|n,this._options=e||{},this._threshold=void 0===this._options.threshold?1024:this._options.threshold,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!u){const e=void 0===this._options.concurrencyLimit?10:this._options.concurrencyLimit;u=new a({concurrency:e})}}static get extensionName(){return'permessage-deflate'}offer(){const e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(e.client_max_window_bits=!0),e}accept(e){e=this.normalizeParams(e);var t;return t=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params=t,t}cleanup(){this._inflate&&(this._inflate.writeInProgress?this._inflate.pendingClose=!0:(this._inflate.close(),this._inflate=null)),this._deflate&&(this._deflate.writeInProgress?this._deflate.pendingClose=!0:(this._deflate.close(),this._deflate=null))}acceptAsServer(e){const t={},n=e.some((e)=>{if(!(!1===this._options.serverNoContextTakeover&&e.server_no_context_takeover||!1===this._options.serverMaxWindowBits&&e.server_max_window_bits||'number'==typeof this._options.serverMaxWindowBits&&'number'==typeof e.server_max_window_bits&&this._options.serverMaxWindowBits>e.server_max_window_bits||'number'==typeof this._options.clientMaxWindowBits&&!e.client_max_window_bits))return(this._options.serverNoContextTakeover||e.server_no_context_takeover)&&(t.server_no_context_takeover=!0),(this._options.clientNoContextTakeover||!1!==this._options.clientNoContextTakeover&&e.client_no_context_takeover)&&(t.client_no_context_takeover=!0),'number'==typeof this._options.serverMaxWindowBits?t.server_max_window_bits=this._options.serverMaxWindowBits:'number'==typeof e.server_max_window_bits&&(t.server_max_window_bits=e.server_max_window_bits),'number'==typeof this._options.clientMaxWindowBits?t.client_max_window_bits=this._options.clientMaxWindowBits:!1!==this._options.clientMaxWindowBits&&'number'==typeof e.client_max_window_bits&&(t.client_max_window_bits=e.client_max_window_bits),!0});if(!n)throw new Error('Doesn\'t support the offered configuration');return t}acceptAsClient(e){const t=e[0];if(null!=this._options.clientNoContextTakeover&&!1===this._options.clientNoContextTakeover&&t.client_no_context_takeover)throw new Error('Invalid value for "client_no_context_takeover"');if(null!=this._options.clientMaxWindowBits){if(!1===this._options.clientMaxWindowBits&&t.client_max_window_bits)throw new Error('Invalid value for "client_max_window_bits"');if('number'==typeof this._options.clientMaxWindowBits&&(!t.client_max_window_bits||t.client_max_window_bits>this._options.clientMaxWindowBits))throw new Error('Invalid value for "client_max_window_bits"')}return t}normalizeParams(e){return e.map((e)=>(Object.keys(e).forEach((t)=>{var n=e[t];if(1<n.length)throw new Error(`Multiple extension parameters for ${t}`);switch(n=n[0],t){case'server_no_context_takeover':case'client_no_context_takeover':if(!0!==n)throw new Error(`invalid extension parameter value for ${t} (${n})`);e[t]=!0;break;case'server_max_window_bits':case'client_max_window_bits':if('string'==typeof n&&(n=parseInt(n,10),Number.isNaN(n)||n<o.Z_MIN_WINDOWBITS||n>o.Z_MAX_WINDOWBITS))throw new Error(`invalid extension parameter value for ${t} (${n})`);if(!this._isServer&&!0===n)throw new Error(`Missing extension parameter value for ${t}`);e[t]=n;break;default:throw new Error(`Not defined extension parameter (${t})`);}}),e))}decompress(e,t,n){u.push((r)=>{this._decompress(e,t,(e,t)=>{r(),n(e,t)})})}compress(e,t,n){u.push((r)=>{this._compress(e,t,(e,t)=>{r(),n(e,t)})})}_decompress(e,t,n){const r=this._isServer?'client':'server';if(!this._inflate){const e=`${r}_max_window_bits`,t='number'==typeof this.params[e]?this.params[e]:o.Z_DEFAULT_WINDOWBITS;this._inflate=o.createInflateRaw({windowBits:t})}this._inflate.writeInProgress=!0;var a=0;const i=[];var l;const u=(e)=>(a+=e.length,1>this._maxPayload||a<=this._maxPayload?i.push(e):void(l=new Error('max payload size exceeded'),l.closeCode=1009,this._inflate.reset())),c=(e)=>{p(),n(e)},p=()=>{this._inflate&&(this._inflate.removeListener('error',c),this._inflate.removeListener('data',u),this._inflate.writeInProgress=!1,(t&&this.params[`${r}_no_context_takeover`]||this._inflate.pendingClose)&&(this._inflate.close(),this._inflate=null))};this._inflate.on('error',c).on('data',u),this._inflate.write(e),t&&this._inflate.write(d),this._inflate.flush(()=>{p(),l?n(l):n(null,s.concat(i,a))})}_compress(e,t,n){if(!e||0===e.length)return void process.nextTick(n,null,l);const r=this._isServer?'server':'client';if(!this._deflate){const e=`${r}_max_window_bits`,t='number'==typeof this.params[e]?this.params[e]:o.Z_DEFAULT_WINDOWBITS;this._deflate=o.createDeflateRaw({memLevel:this._options.memLevel,level:this._options.level,flush:o.Z_SYNC_FLUSH,windowBits:t})}this._deflate.writeInProgress=!0;var a=0;const i=[],d=(e)=>{a+=e.length,i.push(e)},u=(e)=>{c(),n(e)},c=()=>{this._deflate&&(this._deflate.removeListener('error',u),this._deflate.removeListener('data',d),this._deflate.writeInProgress=!1,(t&&this.params[`${r}_no_context_takeover`]||this._deflate.pendingClose)&&(this._deflate.close(),this._deflate=null))};this._deflate.on('error',u).on('data',d),this._deflate.write(e),this._deflate.flush(o.Z_SYNC_FLUSH,()=>{c();var e=s.concat(i,a);t&&(e=e.slice(0,e.length-4)),n(null,e)})}}e.exports=c},function(e,t,n){'use strict';function r(e){var t=Array.prototype.slice.call(arguments,1);return t.forEach(function(t){for(var n=Object.keys(t),r=0;r<n.length;r++)e[n[r]]=t[n[r]]}),e}var o=n(80);o.enabled=!0;var a=t,s=t.allColors={};a.addColors=function(e){r(s,e)},a.colorize=function(e,t){'undefined'==typeof t&&(t=e);var n=t;if(s[e]instanceof Array)for(var r=0,a=s[e].length;r<a;++r)n=o[s[e][r]](n);else if(s[e].match(/\s/)){for(var i=s[e].split(/\s+/),r=0;r<i.length;++r)n=o[i[r]](n);s[e]=i}else n=o[s[e]](n);return n},a.cli=n(90),a.npm=n(91),a.syslog=n(92),a.addColors(a.cli.colors),a.addColors(a.npm.colors),a.addColors(a.syslog.colors)},function(e,t,n){'use strict';const r=n(12),o=r.Buffer,a=(e,t)=>{const n=o.allocUnsafe(t);for(var r=0,a=0;a<e.length;a++){const t=e[a];t.copy(n,r),r+=t.length}return n};try{const t=n(!function(){var t=new Error('Cannot find module "bufferutil"');throw t.code='MODULE_NOT_FOUND',t}());e.exports=Object.assign({concat:a},t.BufferUtil||t)}catch(t){e.exports={concat:a,mask:(e,t,n,r,o)=>{for(var a=0;a<o;a++)n[r+a]=e[a]^t[3&a]},unmask:(e,t)=>{const n=e.length;for(var r=0;r<n;r++)e[r]^=t[3&r]}}}},function(e,t,n){'use strict';const r=n(12),o=r.Buffer;t.BINARY_TYPES=['nodebuffer','arraybuffer','fragments'],t.GUID='258EAFA5-E914-47DA-95CA-C5AB0DC85B11',t.EMPTY_BUFFER=o.alloc(0),t.NOOP=()=>{}},function(e,t,n){'use strict';function r(e,t){return d(e[0]-t[0],2)+d(e[1]-t[1],2)+d(e[2]-t[2],2)}var o=Math.round,s=Math.PI,a=Math.floor,i=Math.min,d=Math.pow,u=Math.max,l=n(58),c={};for(var p in l)l.hasOwnProperty(p)&&(c[l[p]]=p);var f=e.exports={rgb:{channels:3,labels:'rgb'},hsl:{channels:3,labels:'hsl'},hsv:{channels:3,labels:'hsv'},hwb:{channels:3,labels:'hwb'},cmyk:{channels:4,labels:'cmyk'},xyz:{channels:3,labels:'xyz'},lab:{channels:3,labels:'lab'},lch:{channels:3,labels:'lch'},hex:{channels:1,labels:['hex']},keyword:{channels:1,labels:['keyword']},ansi16:{channels:1,labels:['ansi16']},ansi256:{channels:1,labels:['ansi256']},hcg:{channels:3,labels:['h','c','g']},apple:{channels:3,labels:['r16','g16','b16']},gray:{channels:1,labels:['gray']}};for(var _ in f)if(f.hasOwnProperty(_)){if(!('channels'in f[_]))throw new Error('missing channels property: '+_);if(!('labels'in f[_]))throw new Error('missing channel labels property: '+_);if(f[_].labels.length!==f[_].channels)throw new Error('channel and label counts mismatch: '+_);var m=f[_].channels,g=f[_].labels;delete f[_].channels,delete f[_].labels,Object.defineProperty(f[_],'channels',{value:m}),Object.defineProperty(f[_],'labels',{value:g})}f.rgb.hsl=function(e){var t=e[0]/255,n=e[1]/255,r=e[2]/255,o=i(t,n,r),a=u(t,n,r),d=a-o,c,p,s;return a===o?c=0:t===a?c=(n-r)/d:n===a?c=2+(r-t)/d:r===a&&(c=4+(t-n)/d),c=i(60*c,360),0>c&&(c+=360),s=(o+a)/2,p=a===o?0:0.5>=s?d/(a+o):d/(2-a-o),[c,100*p,100*s]},f.rgb.hsv=function(e){var t=e[0],n=e[1],r=e[2],o=i(t,n,r),a=u(t,n,r),d=a-o,l,c,s;return c=0===a?0:1e3*(d/a)/10,a===o?l=0:t===a?l=(n-r)/d:n===a?l=2+(r-t)/d:r===a&&(l=4+(t-n)/d),l=i(60*l,360),0>l&&(l+=360),s=1e3*(a/255)/10,[l,c,s]},f.rgb.hwb=function(e){var t=e[0],n=e[1],r=e[2],o=f.rgb.hsl(e)[0],a=1/255*i(t,i(n,r));return r=1-1/255*u(t,u(n,r)),[o,100*a,100*r]},f.rgb.cmyk=function(e){var t=e[0]/255,n=e[1]/255,r=e[2]/255,o,a,s,d;return d=i(1-t,1-n,1-r),o=(1-t-d)/(1-d)||0,a=(1-n-d)/(1-d)||0,s=(1-r-d)/(1-d)||0,[100*o,100*a,100*s,100*d]},f.rgb.keyword=function(e){var t=c[e];if(t)return t;var n=Infinity,o;for(var a in l)if(l.hasOwnProperty(a)){var s=l[a],i=r(e,s);i<n&&(n=i,o=a)}return o},f.keyword.rgb=function(e){return l[e]},f.rgb.xyz=function(e){var t=e[0]/255,n=e[1]/255,r=e[2]/255;t=0.04045<t?d((t+0.055)/1.055,2.4):t/12.92,n=0.04045<n?d((n+0.055)/1.055,2.4):n/12.92,r=0.04045<r?d((r+0.055)/1.055,2.4):r/12.92;var o=0.4124*t+0.3576*n+0.1805*r,a=0.2126*t+0.7152*n+0.0722*r,s=0.0193*t+0.1192*n+0.9505*r;return[100*o,100*a,100*s]},f.rgb.lab=function(e){var t=f.rgb.xyz(e),n=t[0],r=t[1],o=t[2],s,i,a;return n/=95.047,r/=100,o/=108.883,n=0.008856<n?d(n,1/3):7.787*n+16/116,r=0.008856<r?d(r,1/3):7.787*r+16/116,o=0.008856<o?d(o,1/3):7.787*o+16/116,s=116*r-16,i=500*(n-r),a=200*(r-o),[s,i,a]},f.hsl.rgb=function(e){var t=e[0]/360,n=e[1]/100,r=e[2]/100,o,a,s,d,l;if(0==n)return l=255*r,[l,l,l];a=0.5>r?r*(1+n):r+n-r*n,o=2*r-a,d=[0,0,0];for(var u=0;3>u;u++)s=t+1/3*-(u-1),0>s&&s++,1<s&&s--,l=1>6*s?o+6*(a-o)*s:1>2*s?a:2>3*s?o+6*((a-o)*(2/3-s)):o,d[u]=255*l;return d},f.hsl.hsv=function(e){var t=e[0],n=e[1]/100,r=e[2]/100,o=n,a=u(r,0.01),s,i;return r*=2,n*=1>=r?r:2-r,o*=1>=a?a:2-a,i=(r+n)/2,s=0==r?2*o/(a+o):2*n/(r+n),[t,100*s,100*i]},f.hsv.rgb=function(e){var n=e[0]/60,r=e[1]/100,o=e[2]/100,s=a(n)%6,i=n-a(n),d=255*o*(1-r),l=255*o*(1-r*i),u=255*o*(1-r*(1-i));return o*=255,0==s?[o,u,d]:1==s?[l,o,d]:2==s?[d,o,u]:3==s?[d,l,o]:4==s?[u,d,o]:5==s?[o,d,l]:void 0},f.hsv.hsl=function(e){var t=e[0],n=e[1]/100,r=e[2]/100,o=u(r,0.01),a,s,i;return i=(2-n)*r,a=(2-n)*o,s=n*o,s/=1>=a?a:2-a,s=s||0,i/=2,[t,100*s,100*i]},f.hwb.rgb=function(e){var t=e[0]/360,o=e[1]/100,s=e[2]/100,d=o+s,l,i,u,c;1<d&&(o/=d,s/=d),l=a(6*t),i=1-s,u=6*t-l,0!=(1&l)&&(u=1-u),c=o+u*(i-o);var n,r,p;switch(l){default:case 6:case 0:n=i,r=c,p=o;break;case 1:n=c,r=i,p=o;break;case 2:n=o,r=i,p=c;break;case 3:n=o,r=c,p=i;break;case 4:n=c,r=o,p=i;break;case 5:n=i,r=o,p=c;}return[255*n,255*r,255*p]},f.cmyk.rgb=function(e){var t=e[0]/100,n=e[1]/100,o=e[2]/100,a=e[3]/100,s,r,d;return s=1-i(1,t*(1-a)+a),r=1-i(1,n*(1-a)+a),d=1-i(1,o*(1-a)+a),[255*s,255*r,255*d]},f.xyz.rgb=function(e){var t=e[0]/100,n=e[1]/100,o=e[2]/100,a,r,s;return a=3.2406*t+-1.5372*n+-0.4986*o,r=-0.9689*t+1.8758*n+0.0415*o,s=0.0557*t+-0.204*n+1.057*o,a=0.0031308<a?1.055*d(a,1/2.4)-0.055:12.92*a,r=0.0031308<r?1.055*d(r,1/2.4)-0.055:12.92*r,s=0.0031308<s?1.055*d(s,1/2.4)-0.055:12.92*s,a=i(u(0,a),1),r=i(u(0,r),1),s=i(u(0,s),1),[255*a,255*r,255*s]},f.xyz.lab=function(e){var t=e[0],n=e[1],r=e[2],o,s,a;return t/=95.047,n/=100,r/=108.883,t=0.008856<t?d(t,1/3):7.787*t+16/116,n=0.008856<n?d(n,1/3):7.787*n+16/116,r=0.008856<r?d(r,1/3):7.787*r+16/116,o=116*n-16,s=500*(t-n),a=200*(n-r),[o,s,a]},f.lab.xyz=function(e){var t=e[0],n=e[1],r=e[2],o,a,s;a=(t+16)/116,o=n/500+a,s=a-r/200;var i=d(a,3),l=d(o,3),u=d(s,3);return a=0.008856<i?i:(a-16/116)/7.787,o=0.008856<l?l:(o-16/116)/7.787,s=0.008856<u?u:(s-16/116)/7.787,o*=95.047,a*=100,s*=108.883,[o,a,s]},f.lab.lch=function(e){var t=e[0],n=e[1],r=e[2],o,a,i;return o=Math.atan2(r,n),a=360*o/2/s,0>a&&(a+=360),i=Math.sqrt(n*n+r*r),[t,i,a]},f.lch.lab=function(e){var t=e[0],n=e[1],r=e[2],o,a,i;return i=2*(r/360)*s,o=n*Math.cos(i),a=n*Math.sin(i),[t,o,a]},f.rgb.ansi16=function(e){var t=e[0],n=e[1],r=e[2],a=1 in arguments?arguments[1]:f.rgb.hsv(e)[2];if(a=o(a/50),0===a)return 30;var s=30+(o(r/255)<<2|o(n/255)<<1|o(t/255));return 2===a&&(s+=60),s},f.hsv.ansi16=function(e){return f.rgb.ansi16(f.hsv.rgb(e),e[2])},f.rgb.ansi256=function(e){var t=e[0],n=e[1],r=e[2];if(t===n&&n===r)return 8>t?16:248<t?231:o(24*((t-8)/247))+232;var a=16+36*o(5*(t/255))+6*o(5*(n/255))+o(5*(r/255));return a},f.ansi16.rgb=function(e){var t=e%10;if(0==t||7==t)return 50<e&&(t+=3.5),t=255*(t/10.5),[t,t,t];var n=0.5*(~~(50<e)+1),o=255*((1&t)*n),r=255*((1&t>>1)*n),a=255*((1&t>>2)*n);return[o,r,a]},f.ansi256.rgb=function(e){if(232<=e){var t=10*(e-232)+8;return[t,t,t]}e-=16;var n=255*(a(e/36)/5),r=255*(a((s=e%36)/6)/5),o=255*(s%6/5),s;return[n,r,o]},f.rgb.hex=function(e){var t=((255&o(e[0]))<<16)+((255&o(e[1]))<<8)+(255&o(e[2])),n=t.toString(16).toUpperCase();return'000000'.substring(n.length)+n},f.hex.rgb=function(e){var t=e.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!t)return[0,0,0];var n=t[0];3===t[0].length&&(n=n.split('').map(function(e){return e+e}).join(''));var r=parseInt(n,16);return[255&r>>16,255&r>>8,255&r]},f.rgb.hcg=function(e){var t=e[0]/255,n=e[1]/255,r=e[2]/255,o=u(u(t,n),r),a=i(i(t,n),r),s=o-a,d,l;return d=1>s?a/(1-s):0,l=0>=s?0:o===t?(n-r)/s%6:o===n?2+(r-t)/s:4+(t-n)/s+4,l/=6,l%=1,[360*l,100*s,100*d]},f.hsl.hcg=function(e){var t=e[1]/100,n=e[2]/100,r=1,o=0;return r=0.5>n?2*t*n:2*t*(1-n),1>r&&(o=(n-0.5*r)/(1-r)),[e[0],100*r,100*o]},f.hsv.hcg=function(e){var t=e[1]/100,n=e[2]/100,r=t*n,o=0;return 1>r&&(o=(n-r)/(1-r)),[e[0],100*r,100*o]},f.hcg.rgb=function(e){var t=e[0]/360,n=e[1]/100,r=e[2]/100;if(0==n)return[255*r,255*r,255*r];var o=[0,0,0],s=6*(t%1),i=s%1,d=1-i,l=0;switch(a(s)){case 0:o[0]=1,o[1]=i,o[2]=0;break;case 1:o[0]=d,o[1]=1,o[2]=0;break;case 2:o[0]=0,o[1]=1,o[2]=i;break;case 3:o[0]=0,o[1]=d,o[2]=1;break;case 4:o[0]=i,o[1]=0,o[2]=1;break;default:o[0]=1,o[1]=0,o[2]=d;}return l=(1-n)*r,[255*(n*o[0]+l),255*(n*o[1]+l),255*(n*o[2]+l)]},f.hcg.hsv=function(e){var t=e[1]/100,n=e[2]/100,r=t+n*(1-t),o=0;return 0<r&&(o=t/r),[e[0],100*o,100*r]},f.hcg.hsl=function(e){var t=e[1]/100,n=e[2]/100,r=n*(1-t)+0.5*t,o=0;return 0<r&&0.5>r?o=t/(2*r):0.5<=r&&1>r&&(o=t/(2*(1-r))),[e[0],100*o,100*r]},f.hcg.hwb=function(e){var t=e[1]/100,n=e[2]/100,r=t+n*(1-t);return[e[0],100*(r-t),100*(1-r)]},f.hwb.hcg=function(e){var t=e[1]/100,n=e[2]/100,r=1-n,o=r-t,a=0;return 1>o&&(a=(r-o)/(1-o)),[e[0],100*o,100*a]},f.apple.rgb=function(e){return[255*(e[0]/65535),255*(e[1]/65535),255*(e[2]/65535)]},f.rgb.apple=function(e){return[65535*(e[0]/255),65535*(e[1]/255),65535*(e[2]/255)]},f.gray.rgb=function(e){return[255*(e[0]/100),255*(e[0]/100),255*(e[0]/100)]},f.gray.hsl=f.gray.hsv=function(e){return[0,0,e[0]]},f.gray.hwb=function(e){return[0,100,e[0]]},f.gray.cmyk=function(e){return[0,0,0,e[0]]},f.gray.lab=function(e){return[e[0],0,0]},f.gray.hex=function(e){var t=255&o(255*(e[0]/100)),n=((t<<16)+(t<<8)+t).toString(16).toUpperCase();return'000000'.substring(n.length)+n},f.rgb.gray=function(e){var t=(e[0]+e[1]+e[2])/3;return[100*(t/255)]}},function(e){e.exports=require('cluster')},function(e,t,n){'use strict';Object.defineProperty(t,'__esModule',{value:!0}),t.Balancer=void 0;var r=Object.assign||function(e){for(var t=1,n;t<arguments.length;t++)for(var r in n=arguments[t],n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r]);return e},o=n(5),a=function(e){return e&&e.__esModule?e:{default:e}}(o),s=n(0);const d=()=>new Date().getTime();class i{static start(e,t=12e4){if(1>e.length)throw Error('servers cannot be empty');this._servers=e.map((e,t)=>r({id:t},e)),this._pings=this._servers.map(()=>0),this._startQuery(t)}static destroy(){this._stopQuery()}static getFastest(){let e=0;const t=this._pings;for(let n=0;n<t.length;++n){const r=t[n];(0<r&&r<t[e]||0>=t[e])&&(e=n)}return this._servers[e]}static _startQuery(e){1<this._servers.length&&(null!==this._timer&&this._stopQuery(),this._timer=setInterval(()=>this._query(),e),this._query())}static _stopQuery(){clearInterval(this._timer),this._timer=null}static _query(){this._servers.map((e,t)=>{const n=`${e.host}:${e.port}`;s.logger.verbose(`[balancer] querying ${n}`);const r=d(),o=a.default.connect({host:e.host,port:e.port},()=>{const e=d()-r;this._pings[t]=e,s.logger.verbose(`[balancer] ${n} = ${e}ms`),o.end()});o.on('error',()=>{this._pings[t]=-1,s.logger.warn(`[balancer] ${n} lost connection`)})})}}t.Balancer=i,i._servers=[],i._pings=[],i._timer=null},function(e,t){'use strict';var n,r;(function(){function o(e){var t=!1;return function(){if(t)throw new Error('Callback was already called.');t=!0,e.apply(i,arguments)}}var a={},s=function(){},i,d;i='object'==typeof window&&this===window?window:'object'==typeof global&&this===global?global:this,null!=i&&(d=i.async),a.noConflict=function(){return i.async=d,a};var l=Object.prototype.toString,u=Array.isArray||function(e){return'[object Array]'===l.call(e)},c=function(e,t){for(var n=-1,r=e.length;++n<r;)t(e[n],n,e)},p=function(e,t){for(var n=-1,r=e.length,o=Array(r);++n<r;)o[n]=t(e[n],n,e);return o},f=function(e,t,n){return c(e,function(e,r,o){n=t(n,e,r,o)}),n},_=function(e,t){c(m(e),function(n){t(e[n],n)})},m=Object.keys||function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t},g=function(e,t){t=t||0;var n=-1,r=e.length;t&&(r-=t,r=0>r?0:r);for(var o=Array(r);++n<r;)o[n]=e[n+t];return o},h;'function'==typeof setImmediate&&(h=setImmediate),'undefined'!=typeof process&&process.nextTick?(a.nextTick=process.nextTick,a.setImmediate=h?function(e){h(e)}:a.nextTick):h?(a.nextTick=function(e){h(e)},a.setImmediate=a.nextTick):(a.nextTick=function(e){setTimeout(e,0)},a.setImmediate=a.nextTick),a.each=function(e,t,n){function r(t){t?(n(t),n=s):(a+=1,a>=e.length&&n())}if(n=n||s,!e.length)return n();var a=0;c(e,function(e){t(e,o(r))})},a.forEach=a.each,a.eachSeries=function(e,t,n){if(n=n||s,!e.length)return n();var r=0;(function o(){t(e[r],function(t){t?(n(t),n=s):(r+=1,r>=e.length?n():o())})})()},a.forEachSeries=a.eachSeries,a.eachLimit=function(e,t,n,r){var o=y(t);o.apply(null,[e,n,r])},a.forEachLimit=a.eachLimit;var y=function(e){return function(t,n,r){if(r=r||s,!t.length||0>=e)return r();var o=0,a=0,i=0;(function d(){if(o>=t.length)return r();for(;i<e&&a<t.length;)a+=1,i+=1,n(t[a-1],function(e){e?(r(e),r=s):(o+=1,i-=1,o>=t.length?r():d())})})()}};a.forEachOf=a.eachOf=function(e,t,n){n=n||function(){};var r=e.length||m(e).length,o=0;return r?void _(e,function(a,s){t(e[s],s,function(e){e?(n(e),n=function(){}):(o+=1,o===r&&n(null))})}):n()},a.forEachOfSeries=a.eachOfSeries=function(e,t,n){n=n||function(){};var r=m(e),o=r.length;if(!o)return n();var s=0;(function i(){var d=!0,l=r[s];t(e[l],l,function(e){e?(n(e),n=function(){}):(s+=1,s>=o?n(null):d?a.nextTick(i):i())}),d=!1})()},a.forEachOfLimit=a.eachOfLimit=function(e,t,n,r){b(t)(e,n,r)};var b=function(e){return function(t,n,r){r=r||function(){};var o=m(t),a=o.length;if(!a||0>=e)return r();var s=0,i=0,d=0;(function l(){if(s>=a)return r();for(;d<e&&i<a;){i+=1,d+=1;var u=o[i-1];n(t[u],u,function(e){e?(r(e),r=function(){}):(s+=1,d-=1,s>=a?r():l())})}})()}},v=function(e){return function(){var t=g(arguments);return e.apply(null,[a.each].concat(t))}},k=function(e,t){return function(){var n=g(arguments);return t.apply(null,[y(e)].concat(n))}},x=function(e){return function(){var t=g(arguments);return e.apply(null,[a.eachSeries].concat(t))}},E=function(e,t,n,r){if(t=p(t,function(e,t){return{index:t,value:e}}),!r)e(t,function(e,t){n(e.value,function(e){t(e)})});else{var o=[];e(t,function(e,t){n(e.value,function(n,r){o[e.index]=r,t(n)})},function(e){r(e,o)})}};a.map=v(E),a.mapSeries=x(E),a.mapLimit=function(e,t,n,r){return S(t)(e,n,r)};var S=function(e){return k(e,E)};a.reduce=function(e,t,n,r){a.eachSeries(e,function(e,r){n(t,e,function(e,n){t=n,r(e)})},function(e){r(e,t)})},a.inject=a.reduce,a.foldl=a.reduce,a.reduceRight=function(e,t,n,r){var o=p(e,function(e){return e}).reverse();a.reduce(o,t,n,r)},a.foldr=a.reduceRight;var w=function(e,t,n,r){var o=[];t=p(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){n(e.value,function(n){n&&o.push(e),t()})},function(){r(p(o.sort(function(e,t){return e.index-t.index}),function(e){return e.value}))})};a.filter=v(w),a.filterSeries=x(w),a.select=a.filter,a.selectSeries=a.filterSeries;var C=function(e,t,n,r){var o=[];t=p(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){n(e.value,function(n){n||o.push(e),t()})},function(){r(p(o.sort(function(e,t){return e.index-t.index}),function(e){return e.value}))})};a.reject=v(C),a.rejectSeries=x(C);var T=function(e,t,n,r){e(t,function(e,t){n(e,function(n){n?(r(e),r=s):t()})},function(){r()})};a.detect=v(T),a.detectSeries=x(T),a.some=function(e,t,n){a.each(e,function(e,r){t(e,function(e){e&&(n(!0),n=s),r()})},function(){n(!1)})},a.any=a.some,a.every=function(e,t,n){a.each(e,function(e,r){t(e,function(e){e||(n(!1),n=s),r()})},function(){n(!0)})},a.all=a.every,a.sortBy=function(e,t,n){a.map(e,function(e,n){t(e,function(t,r){t?n(t):n(null,{value:e,criteria:r})})},function(e,t){if(e)return n(e);n(null,p(t.sort(function(e,t){var n=e.criteria,r=t.criteria;return n<r?-1:n>r?1:0}),function(e){return e.value}))})},a.auto=function(e,t){t=t||s;var n=m(e),r=n.length;if(!r)return t();var o={},d=[],i=function(e){d.unshift(e)},l=function(e){for(var t=0;t<d.length;t+=1)if(d[t]===e)return void d.splice(t,1)},p=function(){r--,c(d.slice(0),function(e){e()})};i(function(){if(!r){var e=t;t=s,e(null,o)}}),c(n,function(n){for(var r=u(e[n])?e[n]:[e[n]],d=function(e){var r=g(arguments,1);if(1>=r.length&&(r=r[0]),e){var i={};c(m(o),function(e){i[e]=o[e]}),i[n]=r,t(e,i),t=s}else o[n]=r,a.setImmediate(p)},_=r.slice(0,Math.abs(r.length-1))||[],h=_.length,y;h--;){if(!(y=e[_[h]]))throw new Error('Has inexistant dependency');if(u(y)&&!!~y.indexOf(n))throw new Error('Has cyclic dependencies')}var b=function(){return f(_,function(e,t){return e&&o.hasOwnProperty(t)},!0)&&!o.hasOwnProperty(n)};if(b())r[r.length-1](d,o);else{var v=function e(){b()&&(l(e),r[r.length-1](d,o))};i(v)}})},a.retry=function(e,t,n){var r=5,o=[];'function'==typeof e&&(n=t,t=e,e=r),e=parseInt(e,10)||r;var s=function(r,s){for(var i=function(e,t){return function(n){e(function(e,r){n(!e||t,{err:e,result:r})},s)}};e;)o.push(i(t,!(e-=1)));a.series(o,function(e,t){t=t[t.length-1],(r||n)(t.err,t.result)})};return n?s():s},a.waterfall=function(e,t){if(t=t||s,!u(e)){var n=new Error('First argument to waterfall must be an array of functions');return t(n)}if(!e.length)return t();(function e(n){return function(r){if(r)t.apply(null,arguments),t=s;else{var o=g(arguments,1),i=n.next();i?o.push(e(i)):o.push(t),a.setImmediate(function(){n.apply(null,o)})}}})(a.iterator(e))()};var P=function(e,t,n){if(n=n||s,u(t))e.map(t,function(e,t){e&&e(function(e){var n=g(arguments,1);1>=n.length&&(n=n[0]),t.call(null,e,n)})},n);else{var r={};e.each(m(t),function(e,n){t[e](function(t){var o=g(arguments,1);1>=o.length&&(o=o[0]),r[e]=o,n(t)})},function(e){n(e,r)})}};a.parallel=function(e,t){P({map:a.map,each:a.each},e,t)},a.parallelLimit=function(e,t,n){P({map:S(t),each:y(t)},e,n)},a.series=function(e,t){if(t=t||s,u(e))a.mapSeries(e,function(e,t){e&&e(function(e){var n=g(arguments,1);1>=n.length&&(n=n[0]),t.call(null,e,n)})},t);else{var n={};a.eachSeries(m(e),function(t,r){e[t](function(e){var o=g(arguments,1);1>=o.length&&(o=o[0]),n[t]=o,r(e)})},function(e){t(e,n)})}},a.iterator=function(e){return function t(n){var r=function t(){return e.length&&e[n].apply(null,arguments),t.next()};return r.next=function(){return n<e.length-1?t(n+1):null},r}(0)},a.apply=function(e){var t=g(arguments,1);return function(){return e.apply(null,t.concat(g(arguments)))}};var O=function(e,t,n,o){var a=[];e(t,function(e,t){n(e,function(e,n){a=a.concat(n||[]),t(e)})},function(e){o(e,a)})};a.concat=v(O),a.concatSeries=x(O),a.whilst=function(e,t,n){e()?t(function(r){return r?n(r):void a.whilst(e,t,n)}):n()},a.doWhilst=function(e,t,n){e(function(r){if(r)return n(r);var o=g(arguments,1);t.apply(null,o)?a.doWhilst(e,t,n):n()})},a.until=function(e,t,n){e()?n():t(function(r){return r?n(r):void a.until(e,t,n)})},a.doUntil=function(e,t,n){e(function(r){if(r)return n(r);var o=g(arguments,1);t.apply(null,o)?n():a.doUntil(e,t,n)})},a.queue=function(e,t){function n(e,t,n,r){return e.started||(e.started=!0),u(t)||(t=[t]),0===t.length?a.setImmediate(function(){e.drain&&e.drain()}):void c(t,function(t){var o={data:t,callback:'function'==typeof r?r:null};n?e.tasks.unshift(o):e.tasks.push(o),e.saturated&&e.tasks.length===e.concurrency&&e.saturated(),a.setImmediate(e.process)})}if(t===void 0)t=1;else if(0===t)throw new Error('Concurrency must not be zero');var r=0,s={tasks:[],concurrency:t,saturated:null,empty:null,drain:null,started:!1,paused:!1,push:function(e,t){n(s,e,!1,t)},kill:function(){s.drain=null,s.tasks=[]},unshift:function(e,t){n(s,e,!0,t)},process:function(){if(!s.paused&&r<s.concurrency&&s.tasks.length){var t=s.tasks.shift();s.empty&&0===s.tasks.length&&s.empty(),r+=1;var n=function(){r-=1,t.callback&&t.callback.apply(t,arguments),s.drain&&0===s.tasks.length+r&&s.drain(),s.process()},a=o(n);e(t.data,a)}},length:function(){return s.tasks.length},running:function(){return r},idle:function(){return 0===s.tasks.length+r},pause:function(){!0===s.paused||(s.paused=!0)},resume:function(){if(!1!==s.paused){s.paused=!1;for(var e=Math.min(s.concurrency,s.tasks.length),t=1;t<=e;t++)a.setImmediate(s.process)}}};return s},a.priorityQueue=function(e,t){function n(e,t){return e.priority-t.priority}function r(e,t,n){for(var r=-1,o=e.length-1,a;r<o;)a=r+(o-r+1>>>1),0<=n(t,e[a])?r=a:o=a-1;return r}function o(e,t,o,s){return e.started||(e.started=!0),u(t)||(t=[t]),0===t.length?a.setImmediate(function(){e.drain&&e.drain()}):void c(t,function(t){var i={data:t,priority:o,callback:'function'==typeof s?s:null};e.tasks.splice(r(e.tasks,i,n)+1,0,i),e.saturated&&e.tasks.length===e.concurrency&&e.saturated(),a.setImmediate(e.process)})}var s=a.queue(e,t);return s.push=function(e,t,n){o(s,e,t,n)},delete s.unshift,s},a.cargo=function(e,t){var n=!1,r=[],o={tasks:r,payload:t,saturated:null,empty:null,drain:null,drained:!0,push:function(e,n){u(e)||(e=[e]),c(e,function(e){r.push({data:e,callback:'function'==typeof n?n:null}),o.drained=!1,o.saturated&&r.length===t&&o.saturated()}),a.setImmediate(o.process)},process:function a(){if(!n){if(0===r.length)return o.drain&&!o.drained&&o.drain(),void(o.drained=!0);var s='number'==typeof t?r.splice(0,t):r.splice(0,r.length),i=p(s,function(e){return e.data});o.empty&&o.empty(),n=!0,e(i,function(){n=!1;var e=arguments;c(s,function(t){t.callback&&t.callback.apply(null,e)}),a()})}},length:function(){return r.length},running:function(){return n}};return o};var B=function(e){return function(t){var n=g(arguments,1);t.apply(null,n.concat([function(t){var n=g(arguments,1);'undefined'!=typeof console&&(t?console.error&&console.error(t):console[e]&&c(n,function(t){console[e](t)}))}]))}};a.log=B('log'),a.dir=B('dir'),a.memoize=function(e,t){var n={},r={};t=t||function(e){return e};var o=function(){var o=g(arguments),s=o.pop(),d=t.apply(null,o);d in n?a.nextTick(function(){s.apply(null,n[d])}):d in r?r[d].push(s):(r[d]=[s],e.apply(null,o.concat([function(){n[d]=g(arguments);var e=r[d];delete r[d];for(var t=0,o=e.length;t<o;t++)e[t].apply(null,arguments)}])))};return o.memo=n,o.unmemoized=e,o},a.unmemoize=function(e){return function(){return(e.unmemoized||e).apply(null,arguments)}},a.times=function(e,t,n){for(var r=[],o=0;o<e;o++)r.push(o);return a.map(r,t,n)},a.timesSeries=function(e,t,n){for(var r=[],o=0;o<e;o++)r.push(o);return a.mapSeries(r,t,n)},a.seq=function(){var e=arguments;return function(){var t=this,n=g(arguments),r=n.pop();a.reduce(e,n,function(e,n,r){n.apply(t,e.concat([function(){var e=arguments[0],t=g(arguments,1);r(e,t)}]))},function(e,n){r.apply(t,[e].concat(n))})}},a.compose=function(){return a.seq.apply(null,Array.prototype.reverse.call(arguments))};var I=function(e,t){var n=function(){var n=this,r=g(arguments),o=r.pop();return e(t,function(e,t){e.apply(n,r.concat([t]))},o)};if(2<arguments.length){var r=g(arguments,2);return n.apply(this,r)}return n};a.applyEach=v(I),a.applyEachSeries=x(I),a.forever=function(e,t){function n(r){if(r){if(t)return t(r);throw r}e(n)}n()},'undefined'!=typeof e&&e.exports?e.exports=a:(n=[],r=function(){return a}.apply(t,n),!(r!==void 0&&(e.exports=r)))})()},function(e){e.exports=require('https')},function(e,t,n){'use strict';var r=n(6),o=n(97),a=t;a.getAllInfo=function(e){return{date:new Date().toString(),process:a.getProcessInfo(),os:a.getOsInfo(),trace:a.getTrace(e),stack:e.stack&&e.stack.split('\n')}},a.getProcessInfo=function(){return{pid:process.pid,uid:process.getuid?process.getuid():null,gid:process.getgid?process.getgid():null,cwd:process.cwd(),execPath:process.execPath,version:process.version,argv:process.argv,memoryUsage:process.memoryUsage()}},a.getOsInfo=function(){return{loadavg:r.loadavg(),uptime:r.uptime()}},a.getTrace=function(e){var t=e?o.parse(e):o.get();return t.map(function(e){return{column:e.getColumnNumber(),file:e.getFileName(),function:e.getFunctionName(),line:e.getLineNumber(),method:e.getMethodName(),native:e.isNative()}})}},function(e,t,n){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}function o(e){return l.default.readFileSync(c.default.resolve(process.cwd(),e))}Object.defineProperty(t,'__esModule',{value:!0}),t.Config=t.AVAILABLE_PROTOCOLS=void 0;var a=function(){function e(e,t){var n=[],r=!0,o=!1,a;try{for(var s=e[Symbol.iterator](),i;!(r=(i=s.next()).done)&&(n.push(i.value),!(t&&n.length===t));r=!0);}catch(e){o=!0,a=e}finally{try{!r&&s['return']&&s['return']()}finally{if(o)throw a}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError('Invalid attempt to destructure non-iterable instance')}}(),s=n(33),i=r(s),d=n(4),l=r(d),u=n(8),c=r(u),p=n(6),f=r(p),_=n(5),m=r(_),g=n(21),h=r(g),y=n(10),b=r(y),v=n(100),k=r(v),x=n(16),E=n(0),S=n(38);const w=t.AVAILABLE_PROTOCOLS=['tcp','socks','socks5','socks4','socks4a','http','https','ws','tls'];class C{static init(e){if(this._validate(e),void 0===e.servers?(global.__IS_CLIENT__=!1,global.__IS_SERVER__=!0,this.initServer(e)):(global.__SERVERS__=e.servers.filter((e)=>e.enabled),global.__IS_CLIENT__=!0,global.__IS_SERVER__=!1),void 0!==e.service){var t=h.default.parse(e.service);const n=t.protocol,r=t.hostname,o=t.port;global.__LOCAL_PROTOCOL__=n.slice(0,-1),global.__LOCAL_HOST__=r,global.__LOCAL_PORT__=o}else global.__LOCAL_PROTOCOL__=__IS_CLIENT__?'socks5':__TRANSPORT__,global.__LOCAL_HOST__=e.host,global.__LOCAL_PORT__=e.port;global.__TIMEOUT__=void 0===e.timeout?600000:1e3*e.timeout,global.__REDIRECT__=''===e.redirect?null:e.redirect,global.__WORKERS__=void 0===e.workers?0:e.workers,global.__DNS_EXPIRE__=void 0===e.dns_expire?S.DNS_DEFAULT_EXPIRE:1e3*e.dns_expire,void 0!==e.dns&&0<e.dns.length&&(global.__DNS__=e.dns,i.default.setServers(e.dns));const r=c.default.resolve(process.cwd(),e.log_path||'.');let o=!1;l.default.existsSync(r)?o=l.default.statSync(r).isFile():''!==c.default.extname(r)&&(o=!0),global.__LOG_PATH__=o?r:c.default.join(r,`bs-${__IS_CLIENT__?'client':'server'}.log`),global.__LOG_LEVEL__=void 0===e.log_level?'info':e.log_level,global.__LOG_MAX_DAYS__=void 0===e.log_max_days?0:e.log_max_days,E.logger.configure({level:__LOG_LEVEL__,transports:[new b.default.transports.Console({colorize:!0,prettyPrint:!0}),new(n(116))({filename:__LOG_PATH__,level:__LOG_LEVEL__,maxDays:__LOG_MAX_DAYS__})]})}static initServer(e){if(e.service!==void 0){var t=h.default.parse(e.service);const n=t.protocol,r=t.hostname,o=t.port;global.__TRANSPORT__=n.slice(0,-1),global.__SERVER_HOST__=r,global.__SERVER_PORT__=o}else global.__TRANSPORT__=e.transport||'tcp',global.__SERVER_HOST__=e.host,global.__SERVER_PORT__=e.port;'tls'===__TRANSPORT__&&(E.logger.info(`[config] loading ${e.tls_cert}`),global.__TLS_CERT__=o(e.tls_cert),__IS_SERVER__&&(E.logger.info(`[config] loading ${e.tls_key}`),global.__TLS_KEY__=o(e.tls_key))),global.__KEY__=e.key,global.__PRESETS__=e.presets}static _validate(e){if(!(0,k.default)(e))throw Error('invalid configuration file');if(void 0!==e.service)C._validateService(e);else{if(!(0,E.isValidHostname)(e.host))throw Error('\'host\' is invalid');if(!(0,E.isValidPort)(e.port))throw Error('\'port\' is invalid')}if(void 0!==e.servers){if(!Array.isArray(e.servers))throw Error('\'servers\' must be provided as an array');const t=e.servers.filter((e)=>!0===e.enabled);if(1>t.length)throw Error('\'servers\' must have at least one enabled item');t.forEach(this._validateServer)}else this._validateServer(e);if(void 0!==e.timeout){if('number'!=typeof e.timeout)throw Error('\'timeout\' must be a number');if(1>e.timeout)throw Error('\'timeout\' must be greater than 0');60>e.timeout&&console.warn(`==> [config] 'timeout' is too short, is ${e.timeout}s expected?`)}if(void 0!==e.redirect&&''!==e.redirect){if('string'!=typeof e.redirect)throw Error('\'redirect\' must be a string');const n=e.redirect.split(':');if(2!==n.length)throw Error('\'redirect\' must be "<host or ip>:<port>"');var t=a(n,2);const r=t[0],o=t[1];if(!(0,E.isValidHostname)(r)&&!m.default.isIP(r))throw Error('\'redirect\' host is invalid');if(!(0,E.isValidPort)(+o))throw Error('\'redirect\' port is invalid')}if(void 0!==e.log_path&&'string'!=typeof e.log_path)throw Error('\'log_path\' must be a string');if(void 0!==e.log_level){const t=['error','warn','info','verbose','debug','silly'];if(!t.includes(e.log_level))throw Error(`'log_level' must be one of [${t.toString()}]`)}if(void 0!==e.log_max_days){if('number'!=typeof e.log_max_days)throw Error('\'log_max_days\' must a number');if(1>e.log_max_days)throw Error('\'log_max_days\' must be greater than 0')}if(void 0!==e.workers){if('number'!=typeof e.workers)throw Error('\'workers\' must be a number');if(0>e.workers)throw Error('\'workers\' must be an integer');e.workers>f.default.cpus().length&&console.warn(`==> [config] 'workers' is greater than the number of cpus, is ${e.workers} workers expected?`)}if(void 0!==e.dns){if(!Array.isArray(e.dns))throw Error('\'dns\' must be an array');var n=!0,r=!1,o;try{for(var s=e.dns[Symbol.iterator](),i;!(n=(i=s.next()).done);n=!0){const e=i.value;if(!m.default.isIP(e))throw Error(`"${e}" is not an ip address`)}}catch(e){r=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw o}}}if(void 0!==e.dns_expire){if('number'!=typeof e.dns_expire)throw Error('\'dns_expire\' must be a number');if(0>e.dns_expire)throw Error('\'dns_expire\' must be greater or equal to 0');86400<e.dns_expire&&console.warn(`==> [config] 'dns_expire' is too long, is ${e.dns_expire}s expected?`)}}static _validateServer(e){if(e.transport!==void 0){if(!['tcp','tls','ws'].includes(e.transport))throw Error('\'server.transport\' must be "tcp", "tls" or "ws"');if('tls'===e.transport){if('string'!=typeof e.tls_cert)throw Error('\'server.tls_key\' must be a string');if(''===e.tls_cert)throw Error('\'server.tls_cert\' cannot be empty')}}if(void 0!==e.service)C._validateService(e);else{if(!(0,E.isValidHostname)(e.host))throw Error('\'server.host\' is invalid');if(!(0,E.isValidPort)(e.port))throw Error('\'server.port\' is invalid')}if('string'!=typeof e.key||''===e.key)throw Error('\'server.key\' must be a non-empty string');if(!Array.isArray(e.presets))throw Error('\'server.presets\' must be an array');if(1>e.presets.length)throw Error('\'server.presets\' must contain at least one preset');var t=!0,n=!1,r;try{for(var o=e.presets[Symbol.iterator](),a;!(t=(a=o.next()).done);t=!0){const e=a.value,t=e.name,n=e.params;if('string'!=typeof t)throw Error('\'server.presets[].name\' must be a string');if(''===t)throw Error('\'server.presets[].name\' cannot be empty');if(void 0!==n&&!(0,k.default)(n))throw Error('\'server.presets[].params\' must be an plain object');const r=(0,x.getPresetClassByName)(e.name);r.checkParams(e.params||{})}}catch(e){n=!0,r=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw r}}}static _validateService(e){var t=h.default.parse(e.service);const n=t.protocol,r=t.hostname,o=t.port;if('string'!=typeof n)throw Error('service protocol is invalid');const a=n.slice(0,-1);if(!w.includes(a))throw Error(`service protocol must be: ${w.join(', ')}`);if('tls'===a){if('string'!=typeof e.tls_cert||''===e.tls_cert)throw Error('\'tls_cert\' must be set');if(void 0!==e.tls_key&&'string'!=typeof e.tls_key)throw Error('\'tls_key\' must be set')}if(!(0,E.isValidHostname)(r))throw Error('service host is invalid');if(!(0,E.isValidPort)(+o))throw Error('service port is invalid')}}t.Config=C},function(e){e.exports=require('dns')},function(e){e.exports=require('readline')},function(e){e.exports=require('buffer')},function(e,t,n){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,'__esModule',{value:!0});var o=n(5),a=r(o),s=n(17),i=r(s),d=n(0),l=n(1);class u extends l.IPreset{constructor(...e){var t;return t=super(...e),this._isHandshakeDone=!1,this._isBroadCasting=!1,this._staging=Buffer.alloc(0),this._host=null,this._port=null,t}static checkParams({salt:e}){if('string'!=typeof e||''===e)throw Error('\'salt\' must be a non-empty string')}static onInit({salt:e}){u.padding=(0,d.hash)('sha256',e).slice(0,15)}onDestroy(){this._staging=null,this._host=null,this._port=null}onNotified(e){if(__IS_CLIENT__&&e.type===l.CONNECT_TO_REMOTE){var t=e.payload;const n=t.host,r=t.port;this._host=Buffer.from(n),this._port=(0,d.numberToBuffer)(r)}}clientOut({buffer:e}){return this._isHandshakeDone?e:(this._isHandshakeDone=!0,Buffer.concat([(0,d.numberToBuffer)(this._host.length,1),u.padding,this._host,this._port,e]))}serverIn({buffer:e,next:t,broadcast:n,fail:r}){if(!this._isHandshakeDone){if(this._isBroadCasting)return void(this._staging=Buffer.concat([this._staging,e]));if(20>e.length)return r(`unexpected buffer length: ${e.length}, buffer=${e.toString('hex')}`);if(!e.slice(1,16).equals(u.padding))return r(`unexpected padding=${u.padding.toString('hex')}`);const o=e[0];if(e.length<=o+18)return r(`unexpected buffer length: ${e.length}, buffer=${e.toString('hex')}`);let s=e.slice(16,16+o);if((0,d.isValidHostname)(s.toString()))s=s.toString();else if(a.default.isIP(s))s=i.default.toString(s);else return r(`invalid addr: (${s.toString()})`);const c=e.slice(o+16,o+18).readUInt16BE(0),p=e.slice(o+18);this._isBroadCasting=!0,n({type:l.CONNECT_TO_REMOTE,payload:{host:s,port:c,onConnected:()=>{t(Buffer.concat([p,this._staging])),this._isHandshakeDone=!0,this._isBroadCasting=!1,this._staging=null}}})}else return e}}t.default=u,u.padding=null},function(e,t,n){'use strict';Object.defineProperty(t,'__esModule',{value:!0});var r=n(2),o=function(e){return e&&e.__esModule?e:{default:e}}(r),a=n(0),s=n(1);const i=16,d=16,l=['aes-128-ctr','aes-192-ctr','aes-256-ctr','aes-128-cfb','aes-192-cfb','aes-256-cfb','camellia-128-cfb','camellia-192-cfb','camellia-256-cfb'];class u extends s.IPreset{constructor(...e){var t;return t=super(...e),this._isHandshakeDone=!1,this._isBroadCasting=!1,this._staging=Buffer.alloc(0),this._host=null,this._port=null,this._cipher=null,this._decipher=null,t}static checkParams({method:e}){if(!l.includes(e))throw Error(`'method' must be one of [${l}]`)}static onInit({method:e}){u.cipherName=e,u.key=(0,a.EVP_BytesToKey)(__KEY__,e.split('-')[1]/8,i)}onDestroy(){this._staging=null,this._host=null,this._port=null,this._cipher=null,this._decipher=null}onNotified(e){if(__IS_CLIENT__&&e.type===s.CONNECT_TO_REMOTE){var t=e.payload;const n=t.host,r=t.port;this._host=Buffer.from(n),this._port=(0,a.numberToBuffer)(r)}}clientOut({buffer:e}){if(!this._isHandshakeDone){this._isHandshakeDone=!0;const t=o.default.randomBytes(i),n=u.key,r=(0,a.xor)(t,n.slice(0,i));this._cipher=o.default.createCipheriv(u.cipherName,n,t),this._decipher=o.default.createDecipheriv(u.cipherName,n,t);const s=this.encrypt(Buffer.concat([(0,a.numberToBuffer)(this._host.length,1),this._host,this._port,e])),l=(0,a.hmac)('sha1',r,s.slice(0,-e.length)).slice(0,d);return Buffer.concat([t,l,s])}return this.encrypt(e)}serverIn({buffer:e,next:t,broadcast:n,fail:r}){if(!this._isHandshakeDone){if(this._isBroadCasting)return void(this._staging=Buffer.concat([this._staging,e]));if(37>e.length)return r(`unexpected buffer length_1: ${e.length}, buffer=${e.toString('hex')}`);const l=e.slice(0,i),c=u.key;this._cipher=o.default.createCipheriv(u.cipherName,c,l),this._decipher=o.default.createDecipheriv(u.cipherName,c,l);const p=this.decrypt(e.slice(32)),f=e.slice(16,32),_=p[0];if(e.length<=35+_)return r(`unexpected buffer length_2: ${e.length}, buffer=${e.toString('hex')}`);const m=(0,a.xor)(l,c.slice(0,i)),g=(0,a.hmac)('sha1',m,e.slice(32,35+_)).slice(0,d);if(!g.equals(f))return r(`unexpected HMAC-SHA1=${f.toString('hex')} want=${g.toString('hex')}`);const h=p.slice(1,_+1).toString(),y=p.slice(_+1,_+3).readUInt16BE(0),b=p.slice(_+3);this._isBroadCasting=!0,n({type:s.CONNECT_TO_REMOTE,payload:{host:h,port:y,onConnected:()=>{t(Buffer.concat([b,this._staging])),this._isHandshakeDone=!0,this._isBroadCasting=!1,this._staging=null}}})}else return this.decrypt(e)}serverOut({buffer:e}){return this.encrypt(e)}clientIn({buffer:e}){return this.decrypt(e)}encrypt(e){return this._cipher.update(e)}decrypt(e){return this._decipher.update(e)}}t.default=u,u.cipherName='',u.key=null},function(e,t,n){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}function o(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){function r(o,a){try{var s=t[o](a),i=s.value}catch(e){return void n(e)}return s.done?void e(i):Promise.resolve(i).then(function(e){r('next',e)},function(e){r('throw',e)})}return r('next')})}}Object.defineProperty(t,'__esModule',{value:!0}),t.DNSCache=t.DNS_DEFAULT_EXPIRE=void 0;var a=function(){function e(e,t){var n=[],r=!0,o=!1,a;try{for(var s=e[Symbol.iterator](),i;!(r=(i=s.next()).done)&&(n.push(i.value),!(t&&n.length===t));r=!0);}catch(e){o=!0,a=e}finally{try{!r&&s['return']&&s['return']()}finally{if(o)throw a}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError('Invalid attempt to destructure non-iterable instance')}}(),s=n(33),i=r(s),d=n(5),l=r(d),u=n(0);const c=t.DNS_DEFAULT_EXPIRE=3.6e6;class p{constructor({expire:e}={}){this._expire=c,e!==void 0&&(this._expire=e)}_now(){return new Date().getTime()}_lookup(e){return o(function*(){return new Promise(function(t,n){i.default.lookup(e,function(e,r){e?n(e):t(r)})})})()}_put(e,t){if(0<this._expire){const n=this._now()+this._expire;p._pool[e]=[t,n]}}get(e){var t=this;return o(function*(){if(l.default.isIP(e))return e;let n=null;if(p._pool[e]===void 0)n=yield t._lookup(e),t._put(e,n);else{var r=a(p._pool[e],2);const o=r[0],s=r[1],i=t._now();i>=s&&delete p._pool[e],u.logger.verbose(`[dns-cache] hit: hostname=${e} resolved=${o} ttl=${s-i}ms`),n=o}return n})()}clear(){p._pool={}}}t.DNSCache=p,p._pool={}},function(e){e.exports=require('tls')},function(e,t,n){'use strict';const r=n(41);r.Server=n(122),r.Receiver=n(44),r.Sender=n(46),e.exports=r},function(e,t,n){'use strict';function r(e,t,n){this.protocolVersion=n.protocolVersion,this._maxPayload=n.maxPayload,this.extensions=n.extensions,this.protocol=n.protocol,this._isServer=!0,this.setSocket(e,t)}function o(e,t,n){if(n=Object.assign({protocolVersion:h[1],protocol:t.join(','),perMessageDeflate:!0,handshakeTimeout:null,localAddress:null,headers:null,family:null,origin:null,agent:null,host:null,checkServerIdentity:null,rejectUnauthorized:null,passphrase:null,ciphers:null,cert:null,key:null,pfx:null,ca:null},n),-1===h.indexOf(n.protocolVersion))throw new Error(`unsupported protocol version: ${n.protocolVersion} `+`(supported versions: ${h.join(', ')})`);this.protocolVersion=n.protocolVersion,this._isServer=!1,this.url=e;const r=u.parse(e),o='ws+unix:'===r.protocol;if(!r.host&&(!o||!r.path))throw new Error('invalid url');const a='wss:'===r.protocol||'https:'===r.protocol,i=s.randomBytes(16).toString('base64'),p=a?d:l,m={};var g;n.perMessageDeflate&&(g=new c(!0===n.perMessageDeflate?{}:n.perMessageDeflate,!1),m[c.extensionName]=g.offer());const b={port:r.port||(a?443:80),host:r.hostname,path:'/',headers:{"Sec-WebSocket-Version":n.protocolVersion,"Sec-WebSocket-Key":i,Connection:'Upgrade',Upgrade:'websocket'}};if(n.headers&&Object.assign(b.headers,n.headers),Object.keys(m).length&&(b.headers['Sec-WebSocket-Extensions']=f.format(m)),n.protocol&&(b.headers['Sec-WebSocket-Protocol']=n.protocol),n.origin&&(13>n.protocolVersion?b.headers['Sec-WebSocket-Origin']=n.origin:b.headers.Origin=n.origin),n.host&&(b.headers.Host=n.host),r.auth&&(b.auth=r.auth),n.localAddress&&(b.localAddress=n.localAddress),n.family&&(b.family=n.family),o){const e=r.path.split(':');b.socketPath=e[0],b.path=e[1]}else r.path&&(b.path='/'===r.path.charAt(0)?r.path:`/${r.path}`);var v=n.agent;(null!=n.rejectUnauthorized||n.checkServerIdentity||n.passphrase||n.ciphers||n.cert||n.key||n.pfx||n.ca)&&(n.passphrase&&(b.passphrase=n.passphrase),n.ciphers&&(b.ciphers=n.ciphers),n.cert&&(b.cert=n.cert),n.key&&(b.key=n.key),n.pfx&&(b.pfx=n.pfx),n.ca&&(b.ca=n.ca),n.checkServerIdentity&&(b.checkServerIdentity=n.checkServerIdentity),null!=n.rejectUnauthorized&&(b.rejectUnauthorized=n.rejectUnauthorized),!v&&(v=new p.Agent(b))),v&&(b.agent=v),this._req=p.get(b),n.handshakeTimeout&&this._req.setTimeout(n.handshakeTimeout,()=>{this._req.abort(),this.emit('error',new Error('opening handshake has timed out')),this.finalize(!0)}),this._req.on('error',(e)=>{this._req.aborted||(this._req=null,this.emit('error',e),this.finalize(!0))}),this._req.on('response',(e)=>{this.emit('unexpected-response',this._req,e)||(this._req.abort(),this.emit('error',new Error(`unexpected server response (${e.statusCode})`)),this.finalize(!0))}),this._req.on('upgrade',(e,t,r)=>{if(this.emit('headers',e.headers,e),this.readyState===y.CONNECTING){this._req=null;const a=s.createHash('sha1').update(i+_.GUID,'binary').digest('base64');if(e.headers['sec-websocket-accept']!==a)return t.destroy(),this.emit('error',new Error('invalid server key')),this.finalize(!0);const d=e.headers['sec-websocket-protocol'],l=(n.protocol||'').split(/, */);var o;if(!n.protocol&&d?o='server sent a subprotocol even though none requested':n.protocol&&!d?o='server sent no subprotocol even though requested':d&&-1===l.indexOf(d)&&(o='server responded with an invalid protocol'),o)return t.destroy(),this.emit('error',new Error(o)),this.finalize(!0);d&&(this.protocol=d);const u=f.parse(e.headers['sec-websocket-extensions']);if(g&&u[c.extensionName]){try{g.accept(u[c.extensionName])}catch(e){return t.destroy(),this.emit('error',new Error('invalid extension parameter')),this.finalize(!0)}this.extensions[c.extensionName]=g}this.setSocket(t,r)}})}const a=n(3),s=n(2),i=n(42),d=n(30),l=n(20),u=n(21),c=n(22),p=n(120),f=n(43),_=n(25),m=n(44),g=n(46),h=[8,13];class y extends a{constructor(e,t,n){super(),t?'string'==typeof t?t=[t]:!Array.isArray(t)&&(n=t,t=[]):t=[],this.readyState=y.CONNECTING,this.bytesReceived=0,this.extensions={},this.protocol='',this._binaryType=_.BINARY_TYPES[0],this._finalize=this.finalize.bind(this),this._finalizeCalled=!1,this._closeMessage=null,this._closeTimer=null,this._closeCode=null,this._receiver=null,this._sender=null,this._socket=null,this._ultron=null,Array.isArray(e)?r.call(this,e[0],e[1],n):o.call(this,e,t,n)}get CONNECTING(){return y.CONNECTING}get CLOSING(){return y.CLOSING}get CLOSED(){return y.CLOSED}get OPEN(){return y.OPEN}get bufferedAmount(){var e=0;return this._socket&&(e=this._socket.bufferSize+this._sender._bufferedBytes),e}get binaryType(){return this._binaryType}set binaryType(e){0>_.BINARY_TYPES.indexOf(e)||(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}setSocket(e,t){e.setTimeout(0),e.setNoDelay(),this._receiver=new m(this.extensions,this._maxPayload,this.binaryType),this._sender=new g(e,this.extensions),this._ultron=new i(e),this._socket=e,this._ultron.on('close',this._finalize),this._ultron.on('error',this._finalize),this._ultron.on('end',this._finalize),0<t.length&&e.unshift(t),this._ultron.on('data',(e)=>{this.bytesReceived+=e.length,this._receiver.add(e)}),this._receiver.onmessage=(e)=>this.emit('message',e),this._receiver.onping=(e)=>{this.pong(e,!this._isServer,!0),this.emit('ping',e)},this._receiver.onpong=(e)=>this.emit('pong',e),this._receiver.onclose=(e,t)=>{this._closeMessage=t,this._closeCode=e,this.close(e,t)},this._receiver.onerror=(e,t)=>{this.close(t,''),this.emit('error',e)},this._sender.onerror=(e)=>{this.close(1002,''),this.emit('error',e)},this.readyState=y.OPEN,this.emit('open')}finalize(e){this._finalizeCalled||(this.readyState=y.CLOSING,this._finalizeCalled=!0,clearTimeout(this._closeTimer),this._closeTimer=null,e&&(this._closeCode=1006),this._socket&&(this._ultron.destroy(),this._socket.on('error',function(){this.destroy()}),e?this._socket.destroy():this._socket.end(),this._socket=null,this._ultron=null),this._sender&&(this._sender=this._sender.onerror=null),this._receiver?(this._receiver.cleanup(()=>this.emitClose()),this._receiver=null):this.emitClose())}emitClose(){this.readyState=y.CLOSED,this.emit('close',this._closeCode||1006,this._closeMessage||''),this.extensions[c.extensionName]&&this.extensions[c.extensionName].cleanup(),this.extensions=null,this.removeAllListeners(),this.on('error',_.NOOP)}pause(){if(this.readyState!==y.OPEN)throw new Error('not opened');this._socket.pause()}resume(){if(this.readyState!==y.OPEN)throw new Error('not opened');this._socket.resume()}close(e,t){return this.readyState===y.CLOSED?void 0:this.readyState===y.CONNECTING?void(this._req&&!this._req.aborted&&(this._req.abort(),this.emit('error',new Error('closed before the connection is established')),this.finalize(!0))):this.readyState===y.CLOSING?void(this._closeCode&&this._socket&&this._socket.end()):void(this.readyState=y.CLOSING,this._sender.close(e,t,!this._isServer,(e)=>{e&&this.emit('error',e),this._socket&&(this._closeCode&&this._socket.end(),clearTimeout(this._closeTimer),this._closeTimer=setTimeout(this._finalize,30000,!0))}))}ping(e,t,n){if(this.readyState!==y.OPEN){if(n)return;throw new Error('not opened')}'number'==typeof e&&(e=e.toString()),t===void 0&&(t=!this._isServer),this._sender.ping(e||_.EMPTY_BUFFER,t)}pong(e,t,n){if(this.readyState!==y.OPEN){if(n)return;throw new Error('not opened')}'number'==typeof e&&(e=e.toString()),t===void 0&&(t=!this._isServer),this._sender.pong(e||_.EMPTY_BUFFER,t)}send(e,t,n){if('function'==typeof t&&(n=t,t={}),this.readyState!==y.OPEN){if(n)n(new Error('not opened'));else throw new Error('not opened');return}'number'==typeof e&&(e=e.toString());const r=Object.assign({binary:'string'!=typeof e,mask:!this._isServer,compress:!0,fin:!0},t);this.extensions[c.extensionName]||(r.compress=!1),this._sender.send(e||_.EMPTY_BUFFER,r,n)}terminate(){return this.readyState===y.CLOSED?void 0:this.readyState===y.CONNECTING?void(this._req&&!this._req.aborted&&(this._req.abort(),this.emit('error',new Error('closed before the connection is established')),this.finalize(!0))):void this.finalize(!0)}}y.CONNECTING=0,y.OPEN=1,y.CLOSING=2,y.CLOSED=3,['open','error','close','message'].forEach((e)=>{Object.defineProperty(y.prototype,`on${e}`,{get(){const t=this.listeners(e);for(var n=0;n<t.length;n++)if(t[n]._listener)return t[n]._listener},set(t){const n=this.listeners(e);for(var r=0;r<n.length;r++)n[r]._listener&&this.removeListener(e,n[r]);this.addEventListener(e,t)}})}),y.prototype.addEventListener=p.addEventListener,y.prototype.removeEventListener=p.removeEventListener,e.exports=y},function(e){'use strict';function t(e){return this instanceof t?void(this.id=r++,this.ee=e):new t(e)}var n=Object.prototype.hasOwnProperty,r=0;t.prototype.on=function(e,t,n){return t.__ultron=this.id,this.ee.on(e,t,n),this},t.prototype.once=function(e,t,n){return t.__ultron=this.id,this.ee.once(e,t,n),this},t.prototype.remove=function(){var e=arguments,t=this.ee,r;if(1===e.length&&'string'==typeof e[0])e=e[0].split(/[, ]+/);else if(!e.length)if(t.eventNames)e=t.eventNames();else if(t._events){for(r in e=[],t._events)n.call(t._events,r)&&e.push(r);Object.getOwnPropertySymbols&&(e=e.concat(Object.getOwnPropertySymbols(t._events)))}for(var o=0,a;o<e.length;o++){a=t.listeners(e[o]);for(var s=0;s<a.length;s++){if(r=a[s],r.listener){if(r.listener.__ultron!==this.id)continue;delete r.listener.__ultron}else{if(r.__ultron!==this.id)continue;delete r.__ultron}t.removeListener(e[o],r)}}return this},t.prototype.destroy=function(){return!!this.ee&&(this.remove(),this.ee=null,!0)},e.exports=t},function(e){'use strict';e.exports={format:(e)=>Object.keys(e).map((t)=>{var n=e[t];return Array.isArray(n)||(n=[n]),n.map((e)=>[t].concat(Object.keys(e).map((t)=>{var n=e[t];return Array.isArray(n)||(n=[n]),n.map((e)=>!0===e?t:`${t}=${e}`).join('; ')})).join('; ')).join(', ')}).join(', '),parse:(e)=>{e=e||'';const t={};return e.split(',').forEach((e)=>{const n=e.split(';'),r=n.shift().trim(),o=t[r]=t[r]||[],a={};n.forEach((e)=>{const t=e.trim().split('='),n=t[0];var r=t[1];void 0===r?r=!0:('"'===r[0]&&(r=r.slice(1)),'"'===r[r.length-1]&&(r=r.slice(0,r.length-1))),(a[n]=a[n]||[]).push(r)}),o.push(a)}),t}}},function(e,t,n){'use strict';function r(e,t){return 1===e.length?e[0]:1<e.length?d.concat(e,t):u.EMPTY_BUFFER}function o(e){return 0===e.byteOffset&&e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}const a=n(12),s=n(22),i=n(121),d=n(24),l=n(45),u=n(25),c=a.Buffer,p=0,f=1,_=2,m=3,g=4,h=5;e.exports=class{constructor(e,t,n){this._binaryType=n||u.BINARY_TYPES[0],this._extensions=e||{},this._maxPayload=0|t,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._fragmented=0,this._masked=!1,this._fin=!1,this._mask=null,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._cleanupCallback=null,this._hadError=!1,this._dead=!1,this._loop=!1,this.onmessage=null,this.onclose=null,this.onerror=null,this.onping=null,this.onpong=null,this._state=p}readBuffer(e){var t=0,n,r;if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length)return n=this._buffers[0].slice(0,e),this._buffers[0]=this._buffers[0].slice(e),n;for(n=c.allocUnsafe(e);0<e;)r=this._buffers[0].length,e>=r?(this._buffers[0].copy(n,t),t+=r,this._buffers.shift()):(this._buffers[0].copy(n,t,0,e),this._buffers[0]=this._buffers[0].slice(e)),e-=r;return n}hasBufferedBytes(e){return!!(this._bufferedBytes>=e)||(this._loop=!1,this._dead&&this.cleanup(this._cleanupCallback),!1)}add(e){this._dead||(this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop())}startLoop(){for(this._loop=!0;this._loop;)switch(this._state){case p:this.getInfo();break;case f:this.getPayloadLength16();break;case _:this.getPayloadLength64();break;case m:this.getMask();break;case g:this.getData();break;default:this._loop=!1;}}getInfo(){if(this.hasBufferedBytes(2)){const e=this.readBuffer(2);if(0!=(48&e[0]))return void this.error(new Error('RSV2 and RSV3 must be clear'),1002);const t=64==(64&e[0]);if(t&&!this._extensions[s.extensionName])return void this.error(new Error('RSV1 must be clear'),1002);if(this._fin=128==(128&e[0]),this._opcode=15&e[0],this._payloadLength=127&e[1],0===this._opcode){if(t)return void this.error(new Error('RSV1 must be clear'),1002);if(!this._fragmented)return void this.error(new Error(`invalid opcode: ${this._opcode}`),1002);this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented)return void this.error(new Error(`invalid opcode: ${this._opcode}`),1002);this._compressed=t}else if(7<this._opcode&&11>this._opcode){if(!this._fin)return void this.error(new Error('FIN must be set'),1002);if(t)return void this.error(new Error('RSV1 must be clear'),1002);if(125<this._payloadLength)return void this.error(new Error('invalid payload length'),1002)}else return void this.error(new Error(`invalid opcode: ${this._opcode}`),1002);this._fin||this._fragmented||(this._fragmented=this._opcode),this._masked=128==(128&e[1]),126===this._payloadLength?this._state=f:127===this._payloadLength?this._state=_:this.haveLength()}}getPayloadLength16(){this.hasBufferedBytes(2)&&(this._payloadLength=this.readBuffer(2).readUInt16BE(0,!0),this.haveLength())}getPayloadLength64(){if(this.hasBufferedBytes(8)){const e=this.readBuffer(8),t=e.readUInt32BE(0,!0);return 2097151<t?void this.error(new Error('max payload size exceeded'),1009):void(this._payloadLength=4294967296*t+e.readUInt32BE(4,!0),this.haveLength())}}haveLength(){8>this._opcode&&this.maxPayloadExceeded(this._payloadLength)||(this._masked?this._state=m:this._state=g)}getMask(){this.hasBufferedBytes(4)&&(this._mask=this.readBuffer(4),this._state=g)}getData(){var e=u.EMPTY_BUFFER;if(this._payloadLength){if(!this.hasBufferedBytes(this._payloadLength))return;e=this.readBuffer(this._payloadLength),this._masked&&d.unmask(e,this._mask)}7<this._opcode?this.controlMessage(e):this._compressed?(this._state=h,this.decompress(e)):this.pushFragment(e)&&this.dataMessage()}decompress(e){const t=this._extensions[s.extensionName];t.decompress(e,this._fin,(e,t)=>e?void this.error(e,1009===e.closeCode?1009:1007):void(this.pushFragment(t)&&this.dataMessage(),this.startLoop()))}dataMessage(){if(this._fin){const t=this._messageLength,n=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],2===this._opcode){var e;e='nodebuffer'===this._binaryType?r(n,t):'arraybuffer'===this._binaryType?o(r(n,t)):n,this.onmessage(e)}else{const e=r(n,t);if(!i(e))return void this.error(new Error('invalid utf8 sequence'),1007);this.onmessage(e.toString())}}this._state=p}controlMessage(e){if(8===this._opcode){if(0===e.length)this.onclose(1e3,''),this._loop=!1,this.cleanup(this._cleanupCallback);else if(1===e.length)this.error(new Error('invalid payload length'),1002);else{const t=e.readUInt16BE(0,!0);if(!l.isValidErrorCode(t))return void this.error(new Error(`invalid status code: ${t}`),1002);const n=e.slice(2);if(!i(n))return void this.error(new Error('invalid utf8 sequence'),1007);this.onclose(t,n.toString()),this._loop=!1,this.cleanup(this._cleanupCallback)}return}9===this._opcode?this.onping(e):this.onpong(e),this._state=p}error(e,t){this.onerror(e,t),this._hadError=!0,this._loop=!1,this.cleanup(this._cleanupCallback)}maxPayloadExceeded(e){if(0===e||1>this._maxPayload)return!1;const t=this._totalPayloadLength+e;return t<=this._maxPayload?(this._totalPayloadLength=t,!1):(this.error(new Error('max payload size exceeded'),1009),!0)}pushFragment(e){if(0===e.length)return!0;const t=this._messageLength+e.length;return 1>this._maxPayload||t<=this._maxPayload?(this._messageLength=t,this._fragments.push(e),!0):(this.error(new Error('max payload size exceeded'),1009),!1)}cleanup(e){this._dead=!0,!this._hadError&&(this._loop||this._state===h)?this._cleanupCallback=e:(this._extensions=null,this._fragments=null,this._buffers=null,this._mask=null,this._cleanupCallback=null,this.onmessage=null,this.onclose=null,this.onerror=null,this.onping=null,this.onpong=null,e&&e())}}},function(e){'use strict';e.exports={isValidErrorCode:function(e){return 1e3<=e&&1013>=e&&1004!==e&&1005!==e&&1006!==e||3e3<=e&&4999>=e},1e3:'normal',1001:'going away',1002:'protocol error',1003:'unsupported data',1004:'reserved',1005:'reserved for extensions',1006:'reserved for extensions',1007:'inconsistent or invalid data',1008:'policy violation',1009:'message too big',1010:'extension handshake missing',1011:'an unexpected condition prevented the request from being fulfilled',1012:'service restart',1013:'try again later'}},function(e,t,n){'use strict';function r(e){const t=l.from(e.buffer);return e.byteLength===e.buffer.byteLength?t:t.slice(e.byteOffset,e.byteOffset+e.byteLength)}const o=n(12),a=n(2),s=n(22),i=n(24),d=n(45),l=o.Buffer;class u{constructor(e,t){this._extensions=t||{},this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._deflating=!1,this._queue=[],this.onerror=null}static frame(e,t){const n=1024>e.length||t.mask&&t.readOnly;var r=t.mask?6:2,o=e.length;65536<=e.length?(r+=8,o=127):125<e.length&&(r+=2,o=126);const s=l.allocUnsafe(n?e.length+r:r);if(s[0]=t.fin?128|t.opcode:t.opcode,t.rsv1&&(s[0]|=64),126===o?s.writeUInt16BE(e.length,2,!0):127===o&&(s.writeUInt32BE(0,2,!0),s.writeUInt32BE(e.length,6,!0)),!t.mask)return s[1]=o,n?(e.copy(s,r),[s]):[s,e];const d=a.randomBytes(4);return(s[1]=128|o,s[r-4]=d[0],s[r-3]=d[1],s[r-2]=d[2],s[r-1]=d[3],n)?(i.mask(e,d,s,r,e.length),[s]):(i.mask(e,d,e,0,e.length),[s,e])}close(e,t,n,r){if(e!==void 0&&('number'!=typeof e||!d.isValidErrorCode(e)))throw new Error('first argument must be a valid error code number');const o=l.allocUnsafe(2+(t?l.byteLength(t):0));o.writeUInt16BE(e||1e3,0,!0),2<o.length&&o.write(t,2),this._deflating?this.enqueue([this.doClose,o,n,r]):this.doClose(o,n,r)}doClose(e,t,n){this.sendFrame(u.frame(e,{fin:!0,rsv1:!1,opcode:8,mask:t,readOnly:!1}),n)}ping(e,t){var n=!0;l.isBuffer(e)||(e instanceof ArrayBuffer?e=l.from(e):ArrayBuffer.isView(e)?e=r(e):(e=l.from(e),n=!1)),this._deflating?this.enqueue([this.doPing,e,t,n]):this.doPing(e,t,n)}doPing(e,t,n){this.sendFrame(u.frame(e,{fin:!0,rsv1:!1,opcode:9,mask:t,readOnly:n}))}pong(e,t){var n=!0;l.isBuffer(e)||(e instanceof ArrayBuffer?e=l.from(e):ArrayBuffer.isView(e)?e=r(e):(e=l.from(e),n=!1)),this._deflating?this.enqueue([this.doPong,e,t,n]):this.doPong(e,t,n)}doPong(e,t,n){this.sendFrame(u.frame(e,{fin:!0,rsv1:!1,opcode:10,mask:t,readOnly:n}))}send(e,t,n){var o=t.binary?2:1,a=t.compress,i=!0;l.isBuffer(e)||(e instanceof ArrayBuffer?e=l.from(e):ArrayBuffer.isView(e)?e=r(e):(e=l.from(e),i=!1));const d=this._extensions[s.extensionName];if(this._firstFragment?(this._firstFragment=!1,a&&d&&(a=e.length>=d._threshold),this._compress=a):(a=!1,o=0),t.fin&&(this._firstFragment=!0),d){const r={fin:t.fin,rsv1:a,opcode:o,mask:t.mask,readOnly:i};this._deflating?this.enqueue([this.dispatch,e,this._compress,r,n]):this.dispatch(e,this._compress,r,n)}else this.sendFrame(u.frame(e,{fin:t.fin,rsv1:!1,opcode:o,mask:t.mask,readOnly:i}),n)}dispatch(e,t,n,r){if(!t)return void this.sendFrame(u.frame(e,n),r);const o=this._extensions[s.extensionName];this._deflating=!0,o.compress(e,n.fin,(e,t)=>e?void(r?r(e):this.onerror(e)):void(n.readOnly=!1,this.sendFrame(u.frame(t,n),r),this._deflating=!1,this.dequeue()))}dequeue(){for(;!this._deflating&&this._queue.length;){const e=this._queue.shift();this._bufferedBytes-=e[1].length,e[0].apply(this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[1].length,this._queue.push(e)}sendFrame(e,t){2===e.length?(this._socket.write(e[0]),this._socket.write(e[1],t)):this._socket.write(e[0],t)}}e.exports=u},function(e,t,n){'use strict';Object.defineProperty(t,'__esModule',{value:!0});var r=function(){function e(e,t){var n=[],r=!0,o=!1,a;try{for(var s=e[Symbol.iterator](),i;!(r=(i=s.next()).done)&&(n.push(i.value),!(t&&n.length===t));r=!0);}catch(e){o=!0,a=e}finally{try{!r&&s['return']&&s['return']()}finally{if(o)throw a}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError('Invalid attempt to destructure non-iterable instance')}}();t.createRelay=function(e,t){var n=__IS_CLIENT__?[i.TcpInbound,u[e][1]]:[u[e][0],i.TcpOutbound],o=r(n,2);const d=o[0],l=o[1],c=new s.Relay({context:t,Inbound:d,Outbound:l});return c.id=(0,a.default)(`${e}_`),c};var o=n(123),a=function(e){return e&&e.__esModule?e:{default:e}}(o),s=n(13),i=n(48),d=n(124),l=n(125);const u={tcp:[i.TcpInbound,i.TcpOutbound],tls:[d.TlsInbound,d.TlsOutbound],ws:[l.WsInbound,l.WsOutbound]}},function(e,t,n){'use strict';function r(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){function r(o,a){try{var s=t[o](a),i=s.value}catch(e){return void n(e)}return s.done?void e(i):Promise.resolve(i).then(function(e){r('next',e)},function(e){r('throw',e)})}return r('next')})}}Object.defineProperty(t,'__esModule',{value:!0}),t.TcpOutbound=t.TcpInbound=void 0;var o=function(){function e(e,t){var n=[],r=!0,o=!1,a;try{for(var s=e[Symbol.iterator](),i;!(r=(i=s.next()).done)&&(n.push(i.value),!(t&&n.length===t));r=!0);}catch(e){o=!0,a=e}finally{try{!r&&s['return']&&s['return']()}finally{if(o)throw a}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError('Invalid attempt to destructure non-iterable instance')}}(),a=n(5),s=function(e){return e&&e.__esModule?e:{default:e}}(a),i=n(49),d=n(13),l=n(0),u=n(1);const c=524288;class p extends i.Inbound{constructor(e){super(e),this._socket=null,this._isConnectedToRemote=!1;const t=e.context;this.onError=this.onError.bind(this),this.onReceive=this.onReceive.bind(this),this.onTimeout=this.onTimeout.bind(this),this.destroy=this.destroy.bind(this),this._socket=t,this._socket.on('error',this.onError),this._socket.on('data',this.onReceive),this._socket.on('drain',()=>this.emit('drain')),this._socket.on('timeout',this.onTimeout),this._socket.on('end',this.destroy),this._socket.on('close',this.destroy),this._socket.setTimeout(__TIMEOUT__)}onError(e){l.logger.warn(`[tcp:inbound] [${this.remote}] ${e.code||''} - ${e.message}`)}onReceive(e){if(this._outbound.writable||!this._isConnectedToRemote){const t=__IS_CLIENT__?d.MIDDLEWARE_DIRECTION_UPWARD:d.MIDDLEWARE_DIRECTION_DOWNWARD;this._pipe.feed(t,e)}this._outbound.bufferSize>=c&&(l.logger.debug(`[tcp:inbound] recv paused due to outbound.bufferSize=${this._outbound.bufferSize} > ${c}`),this._socket.pause(),this._outbound.once('drain',()=>{this._socket&&!this._socket.destroyed&&(l.logger.debug('[tcp:inbound] resume to recv'),this._socket.resume())}))}onTimeout(){l.logger.warn(`[tcp:inbound] [${this.remote}] timeout: no I/O on the connection for ${__TIMEOUT__/1e3}s`),this.destroy()}get bufferSize(){return this._socket?this._socket.bufferSize:0}get writable(){return this._socket&&!this._socket.destroyed&&this._socket.writable}write(e){this.writable&&this._socket.write(e)}destroy(){if(this._socket){const e={host:this.remoteHost,port:this.remotePort};this.broadcast({type:u.CONNECTION_WILL_CLOSE,payload:e}),this._socket.destroy(),this._socket=null,this.emit('close'),this.broadcast({type:u.CONNECTION_CLOSED,payload:e})}this._outbound&&!this._outbound.destroying&&(this._outbound.destroying=!0,0<this._outbound.bufferSize?this._outbound.once('drain',()=>this._outbound.destroy()):(this._outbound.destroy(),this._outbound=null))}onBroadcast(e){switch(e.type){case u.PRESET_FAILED:this.onPresetFailed(e);break;case u.PRESET_CLOSE_CONNECTION:this.onPresetCloseConnection();break;case u.PRESET_PAUSE_RECV:this.onPresetPauseRecv();break;case u.PRESET_RESUME_RECV:this.onPresetResumeRecv();break;default:}}onPresetFailed(e){var t=this;return r(function*(){var n=e.payload;const r=n.name,a=n.message;if(l.logger.error(`[tcp:inbound] [${t.remote}] preset "${r}" fail to process: ${a}`),__IS_CLIENT__&&(l.logger.warn(`[tcp:inbound] [${t.remote}] connection closed`),t.destroy()),__IS_SERVER__)if(__REDIRECT__){const n=e.payload.orgData;var s=__REDIRECT__.split(':'),i=o(s,2);const r=i[0],a=i[1];l.logger.warn(`[tcp:inbound] [${t.remote}] connection is redirecting to: ${r}:${a}`),t.setPresets(function(){return[{name:'tracker'}]}),yield t._outbound.connect({host:r,port:+a}),t._outbound.writable&&t._outbound.write(n)}else{t._socket&&t._socket.pause();const e=(0,l.getRandomInt)(10,40);l.logger.warn(`[tcp:inbound] [${t.remote}] connection will be closed in ${e}s...`),setTimeout(t.destroy,1e3*e)}})()}onPresetCloseConnection(){l.logger.info(`[tcp:inbound] [${this.remote}] preset request to close connection`),this.destroy()}onPresetPauseRecv(){__IS_SERVER__&&this._socket&&this._socket.pause()}onPresetResumeRecv(){__IS_SERVER__&&this._socket&&this._socket.resume()}}t.TcpInbound=p;class f extends i.Outbound{constructor(e){super(e),this._socket=null,this.destroy=this.destroy.bind(this),this.onError=this.onError.bind(this),this.onReceive=this.onReceive.bind(this),this.onTimeout=this.onTimeout.bind(this)}onError(e){l.logger.warn(`[tcp:outbound] [${this.remote}] ${e.code||''} - ${e.message}`)}onReceive(e){if(this._inbound.writable){const t=__IS_CLIENT__?d.MIDDLEWARE_DIRECTION_DOWNWARD:d.MIDDLEWARE_DIRECTION_UPWARD;this._pipe.feed(t,e)}this._inbound.bufferSize>=c&&(l.logger.debug(`[tcp:outbound] recv paused due to inbound.bufferSize=${this._inbound.bufferSize} > ${c}`),this._socket.pause(),this._inbound.once('drain',()=>{this._socket&&!this._socket.destroyed&&(l.logger.debug('[tcp:outbound] resume to recv'),this._socket.resume())}))}onTimeout(){l.logger.warn(`[tcp:outbound] [${this.remote}] timeout: no I/O on the connection for ${__TIMEOUT__/1e3}s`),this.destroy()}get bufferSize(){return this._socket?this._socket.bufferSize:0}get writable(){return this._socket&&!this._socket.destroyed&&this._socket.writable}write(e){this.writable&&this._socket.write(e)}destroy(){this._socket&&(this._socket.destroy(),this._socket=null),this._inbound&&!this._inbound.destroying&&(this._inbound.destroying=!0,0<this._inbound.bufferSize?this._inbound.once('drain',()=>this._inbound.destroy()):(this._inbound.destroy(),this._inbound=null))}onBroadcast(e){switch(e.type){case u.CONNECT_TO_REMOTE:this.onConnectToRemote(e);break;case u.PRESET_PAUSE_SEND:this.onPresetPauseSend();break;case u.PRESET_RESUME_SEND:this.onPresetResumeSend();break;default:}}onConnectToRemote(e){var t=this;return r(function*(){var n=e.payload;const r=n.host,o=n.port,a=n.onConnected;try{__IS_SERVER__&&(yield t.connect({host:r,port:o})),__IS_CLIENT__&&(l.logger.info(`[tcp:outbound] [${t.remote}] request: ${r}:${o}`),yield t.connect({host:__SERVER_HOST__,port:__SERVER_PORT__})),t._inbound._isConnectedToRemote=!0,'function'==typeof a&&a(t._inbound.onReceive)}catch(e){l.logger.warn(`[tcp:outbound] [${t.remote}] fail to connect to ${r}:${o} err=${e.message}`),t._inbound.destroy()}})()}onPresetPauseSend(){__IS_SERVER__&&this._socket&&this._socket.pause()}onPresetResumeSend(){__IS_SERVER__&&this._socket&&this._socket.resume()}connect({host:e,port:t}){var n=this;return r(function*(){n._socket&&!n._socket.destroyed&&(n._socket.destroy(),n._socket=null),n._socket=yield n._connect({host:e,port:t}),n._socket.on('error',n.onError),n._socket.on('end',n.destroy),n._socket.on('close',n.destroy),n._socket.on('timeout',n.onTimeout),n._socket.on('data',n.onReceive),n._socket.on('drain',function(){return n.emit('drain')}),n._socket.setTimeout(__TIMEOUT__)})()}_connect({host:e,port:t}){var n=this;return r(function*(){const r=yield n._dnsCache.get(e);return l.logger.info(`[tcp:outbound] [${n.remote}] connecting to: ${e}(${r}):${t}`),s.default.connect({host:r,port:t})})()}}t.TcpOutbound=f},function(e,t,n){'use strict';Object.defineProperty(t,'__esModule',{value:!0}),t.Outbound=t.Inbound=void 0;var r=n(3),o=function(e){return e&&e.__esModule?e:{default:e}}(r),a=n(13);class s extends o.default{get bufferSize(){return 0}get writable(){return!0}onBroadcast(){}write(){}destroy(){}setPresets(){}}class i extends s{constructor({context:e,pipe:t}){super(),this._outbound=null,this._pipe=null,this._pipe=t,this._remoteHost=e.remoteAddress,this._remotePort=e.remotePort}get remote(){return`${this._remoteHost}:${this._remotePort}`}get remoteHost(){return this._remoteHost}get remotePort(){return this._remotePort}setOutbound(e){this._outbound=e}broadcast(e){this._pipe.destroyed||this._pipe.broadcast('pipe',e)}}t.Inbound=i;class d extends s{constructor({inbound:e,pipe:t}){super(),this._inbound=null,this._pipe=null,this._dnsCache=null,this._inbound=e,this._pipe=t,this._dnsCache=new a.DNSCache({expire:__DNS_EXPIRE__})}get remote(){return this._inbound.remote}broadcast(e){this._pipe.destroyed||this._pipe.broadcast('pipe',e)}}t.Outbound=d},function(e,t,n){'use strict';function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}Object.defineProperty(t,'__esModule',{value:!0}),t.socks=t.http=void 0;var o=n(126),a=r(o),s=n(127),i=r(s);t.http=a,t.socks=i},function(e,t,n){'use strict';Object.defineProperty(t,'__esModule',{value:!0}),t.Pipe=void 0;var r=n(3),o=function(e){return e&&e.__esModule?e:{default:e}}(r),a=n(18),s=n(1);class i extends o.default{get destroyed(){return this._destroyed}constructor(){super(),this._upstream_middlewares=[],this._downstream_middlewares=[],this._cacheBuffer=null,this._destroyed=!1,this.broadcast=this.broadcast.bind(this)}broadcast(e,t){const n=this.getMiddlewares(),r=[];var o=!0,a=!1,s;try{for(var i=n[Symbol.iterator](),d;!(o=(d=i.next()).done);o=!0){const n=d.value;n.name!==e&&r.push(n.notify(t))}}catch(e){a=!0,s=e}finally{try{!o&&i.return&&i.return()}finally{if(a)throw s}}'pipe'!==e&&r.every((e)=>!1==!!e)&&this.emit('broadcast',t)}setMiddlewares(e){var t=!0,n=!1,r;try{for(var o=e[Symbol.iterator](),a;!(t=(a=o.next()).done);t=!0){const e=a.value;e.setMaxListeners(4),e.on('broadcast',this.broadcast),e.on('fail',(e,t)=>void this.broadcast(e,{type:s.PRESET_FAILED,payload:{name:e,message:t,orgData:this._cacheBuffer}}))}}catch(e){n=!0,r=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw r}}this._upstream_middlewares=e,this._downstream_middlewares=[].concat(e).reverse()}getMiddlewares(e=a.MIDDLEWARE_DIRECTION_UPWARD){return e===a.MIDDLEWARE_DIRECTION_UPWARD?this._upstream_middlewares:this._downstream_middlewares}feed(e,t){this._cacheBuffer=t;const n=`pre_${e}`;0<this.listenerCount(n)?this.emit(n,t,(t)=>this._feed(e,t)):this._feed(e,t)}destroy(){const e=this.getMiddlewares();var t=!0,n=!1,r;try{for(var o=e[Symbol.iterator](),a;!(t=(a=o.next()).done);t=!0){const e=a.value;e.onDestroy()}}catch(e){n=!0,r=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw r}}this._upstream_middlewares=null,this._downstream_middlewares=null,this._cacheBuffer=null,this._destroyed=!0,this.removeAllListeners()}_feed(e,t){const n=this.getMiddlewares(e),r=(t,n=!1)=>this.emit(n?`post_${-e}`:`post_${e}`,t),o=`next_${e}`,a=n[0];if(!a.hasListener(o)){const t=n.reduce((t,n)=>(t.on(o,(t)=>n.write(e,{buffer:t,direct:r})),n));t.on(o,r)}a.write(e,{buffer:t,direct:r})}}t.Pipe=i},function(e,t,n){'use strict';function r(e){return-1!==m.indexOf(e)}function o(e){const t=m.indexOf(e);return-1===t?void 0:m[t+1]}const a=n(4),s=n(8),i=n(6),d=n(53),l=n(63),u=n(64),c=n(65),p='2.6.3',f=`
  ${d.bold.underline(`blinksocks v${p}`)}

  Usage: blinksocks [command] [options] ...

  Commands:

    init    generate configuration pair

  Options:

    -h, --help          output usage information
    -v, --version       output blinksocks version
    -c, --config        file json file with configuration
    -m, --minimal       generate minimal json files
    --list-presets      list all built-in presets

  Examples:

${[['Generate json file with minimal options','$ blinksocks init --minimal'],['Start blinksocks client','$ blinksocks --config blinksocks.client.json'],['Start blinksocks server','$ blinksocks --config blinksocks.server.json'],['List all built-in presets','$ blinksocks --list-presets']].map(([e,t])=>`  ${d.gray('-')} ${e}${i.EOL}    ${d.blue(t)}`).join(i.EOL)}

  About & Help: ${d.underline('https://github.com/blinksocks/blinksocks')}
`,_=process.argv,m=_.slice(2);(function(){if(3>_.length)return console.log(f);const e=m[0],t=s.resolve(process.cwd(),e);if(a.existsSync(t)&&'.json'===s.extname(t))return u(t,c);if('init'===m[0]){const e=r('-m')||r('--minimal');return l({isMinimal:e})}if(r('-h')||r('--help'))return console.log(f);if(r('-v')||r('--version'))return console.log(p);if(r('-c')||r('--config')){let e=o('-c')||o('--config');return void 0===e?console.log(d.red('config file must be provided')):(e=s.resolve(process.cwd(),e),a.existsSync(e)?u(e,c):console.log(d.red('config file is not found')))}return r('--list-presets')?(console.log(c.presets.join(i.EOL)),void console.log(c.legacyPresets.map((e)=>`${d.gray(e)} -> ${e.substr(4)}`).join(i.EOL))):void console.log(f)})()},function(e,t,n){'use strict';function r(e,t){t=t||{};const n=u?u.level:0;e.level=t.level===void 0?n:t.level,e.enabled='enabled'in t?t.enabled:0<e.level}function o(e){if(!this||!(this instanceof o)||this.template){const t={};return r(t,e),t.template=function(){const e=[].slice.call(arguments);return i.apply(null,[t.template].concat(e))},Object.setPrototypeOf(t,o.prototype),Object.setPrototypeOf(t.template,t),t.template.constructor=o,t.template}r(this,e)}function a(e,t){const n=function e(){return s.apply(e,arguments)};n._styles=e;const r=this;return Object.defineProperty(n,'level',{enumerable:!0,get(){return r.level},set(e){r.level=e}}),Object.defineProperty(n,'enabled',{enumerable:!0,get(){return r.enabled},set(e){r.enabled=e}}),n.hasGrey=this.hasGrey||'gray'===t||'grey'===t,n.__proto__=I,n}function s(){const e=arguments,t=e.length;let n=arguments[0]+'';if(0===t)return'';if(1<t)for(let r=1;r<t;r++)n+=' '+e[r];if(!this.enabled||0>=this.level||!n)return n;const r=l.dim.open;p&&this.hasGrey&&(l.dim.open='');var o=!0,a=!1,s;try{for(var i=this._styles.slice().reverse()[Symbol.iterator](),d;!(o=(d=i.next()).done);o=!0){const e=d.value;n=e.open+n.replace(e.closeRe,e.open)+e.close,n=n.replace(/\r?\n/g,`${e.close}$&${e.open}`)}}catch(e){a=!0,s=e}finally{try{!o&&i.return&&i.return()}finally{if(a)throw s}}return l.dim.open=r,n}function i(e,t){if(!Array.isArray(t))return[].slice.call(arguments,1).join(' ');const n=[].slice.call(arguments,2),r=[t.raw[0]];for(let o=1;o<t.length;o++)r.push((n[o-1]+'').replace(/[{}\\]/g,'\\$&')),r.push(t.raw[o]+'');return c(e,r.join(''))}const d=n(54),l=n(55),u=n(60),c=n(62),p='win32'===process.platform&&!(process.env.TERM||'').toLowerCase().startsWith('xterm'),f=['ansi','ansi','ansi256','ansi16m'],_=new Set(['gray']),m=Object.create(null);p&&(l.blue.open='\x1B[94m');var g=!0,h=!1,y;try{for(var b=Object.keys(l)[Symbol.iterator](),v;!(g=(v=b.next()).done);g=!0){const e=v.value;l[e].closeRe=new RegExp(d(l[e].close),'g'),m[e]={get(){const t=l[e];return a.call(this,this._styles?this._styles.concat(t):[t],e)}}}}catch(e){h=!0,y=e}finally{try{!g&&b.return&&b.return()}finally{if(h)throw y}}l.color.closeRe=new RegExp(d(l.color.close),'g');var k=!0,x=!1,E;try{for(var S=Object.keys(l.color.ansi)[Symbol.iterator](),w;!(k=(w=S.next()).done);k=!0){const e=w.value;_.has(e)||(m[e]={get(){const t=this.level;return function(){const n=l.color[f[t]][e].apply(null,arguments),r={open:n,close:l.color.close,closeRe:l.color.closeRe};return a.call(this,this._styles?this._styles.concat(r):[r],e)}}})}}catch(e){x=!0,E=e}finally{try{!k&&S.return&&S.return()}finally{if(x)throw E}}l.bgColor.closeRe=new RegExp(d(l.bgColor.close),'g');var C=!0,T=!1,P;try{for(var O=Object.keys(l.bgColor.ansi)[Symbol.iterator](),B;!(C=(B=O.next()).done);C=!0){const e=B.value;if(_.has(e))continue;const t='bg'+e[0].toUpperCase()+e.slice(1);m[t]={get(){const t=this.level;return function(){const n=l.bgColor[f[t]][e].apply(null,arguments),r={open:n,close:l.bgColor.close,closeRe:l.bgColor.closeRe};return a.call(this,this._styles?this._styles.concat(r):[r],e)}}}}}catch(e){T=!0,P=e}finally{try{!C&&O.return&&O.return()}finally{if(T)throw P}}const I=Object.defineProperties(()=>{},m);Object.defineProperties(o.prototype,m),e.exports=o(),e.exports.supportsColor=u},function(e){'use strict';var t=/[|\\{}()[\]^$+*?.]/g;e.exports=function(e){if('string'!=typeof e)throw new TypeError('Expected a string');return e.replace(t,'\\$&')}},function(e,t,n){'use strict';(function(e){const t=n(57),r=(e,n)=>function(){const r=e.apply(t,arguments);return`\u001B[${r+n}m`},o=(e,n)=>function(){const r=e.apply(t,arguments);return`\u001B[${38+n};5;${r}m`},a=(e,n)=>function(){const r=e.apply(t,arguments);return`\u001B[${38+n};2;${r[0]};${r[1]};${r[2]}m`};Object.defineProperty(e,'exports',{enumerable:!0,get:function(){const e=new Map,n={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],gray:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};n.color.grey=n.color.gray;var s=!0,i=!1,d;try{for(var l=Object.keys(n)[Symbol.iterator](),u;!(s=(u=l.next()).done);s=!0){const t=u.value,r=n[t];var c=!0,p=!1,f=void 0;try{for(var _=Object.keys(r)[Symbol.iterator](),m;!(c=(m=_.next()).done);c=!0){const t=m.value,o=r[t];n[t]={open:`\u001B[${o[0]}m`,close:`\u001B[${o[1]}m`},r[t]=n[t],e.set(o[0],o[1])}}catch(e){p=!0,f=e}finally{try{!c&&_.return&&_.return()}finally{if(p)throw f}}Object.defineProperty(n,t,{value:r,enumerable:!1}),Object.defineProperty(n,'codes',{value:e,enumerable:!1})}}catch(e){i=!0,d=e}finally{try{!s&&l.return&&l.return()}finally{if(i)throw d}}const g=(e,t,n)=>[e,t,n];n.color.close='\x1B[39m',n.bgColor.close='\x1B[49m',n.color.ansi={},n.color.ansi256={},n.color.ansi16m={rgb:a(g,0)},n.bgColor.ansi={},n.bgColor.ansi256={},n.bgColor.ansi16m={rgb:a(g,10)};var h=!0,y=!1,b;try{for(var v=Object.keys(t)[Symbol.iterator](),k;!(h=(k=v.next()).done);h=!0){const e=k.value;if('object'!=typeof t[e])continue;const s=t[e];'ansi16'in s&&(n.color.ansi[e]=r(s.ansi16,0),n.bgColor.ansi[e]=r(s.ansi16,10)),'ansi256'in s&&(n.color.ansi256[e]=o(s.ansi256,0),n.bgColor.ansi256[e]=o(s.ansi256,10)),'rgb'in s&&(n.color.ansi16m[e]=a(s.rgb,0),n.bgColor.ansi16m[e]=a(s.rgb,10))}}catch(e){y=!0,b=e}finally{try{!h&&v.return&&v.return()}finally{if(y)throw b}}return n}})}).call(t,n(56)(e))},function(e){'use strict';e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],!e.children&&(e.children=[]),Object.defineProperty(e,'loaded',{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,'id',{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t,n){'use strict';function r(e){var t=function(t){return void 0===t||null===t?t:(1<arguments.length&&(t=Array.prototype.slice.call(arguments)),e(t))};return'conversion'in e&&(t.conversion=e.conversion),t}function o(e){var t=function(t){if(void 0===t||null===t)return t;1<arguments.length&&(t=Array.prototype.slice.call(arguments));var n=e(t);if('object'==typeof n)for(var r=n.length,o=0;o<r;o++)n[o]=Math.round(n[o]);return n};return'conversion'in e&&(t.conversion=e.conversion),t}var a=n(26),s=n(59),i={},d=Object.keys(a);d.forEach(function(e){i[e]={},Object.defineProperty(i[e],'channels',{value:a[e].channels}),Object.defineProperty(i[e],'labels',{value:a[e].labels});var t=s(e),n=Object.keys(t);n.forEach(function(n){var a=t[n];i[e][n]=o(a),i[e][n].raw=r(a)})}),e.exports=i},function(e){'use strict';e.exports={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]}},function(e,t,n){'use strict';function r(){for(var e={},t=l.length,n=0;n<t;n++)e[l[n]]={distance:-1,parent:null};return e}function o(e){var t=r(),n=[e];for(t[e].distance=0;n.length;)for(var o=n.pop(),a=Object.keys(d[o]),s=a.length,l=0;l<s;l++){var i=a[l],u=t[i];-1===u.distance&&(u.distance=t[o].distance+1,u.parent=o,n.unshift(i))}return t}function a(e,t){return function(n){return t(e(n))}}function s(e,t){for(var n=[t[e].parent,e],r=d[t[e].parent][e],o=t[e].parent;t[o].parent;)n.unshift(t[o].parent),r=a(d[t[o].parent][o],r),o=t[o].parent;return r.conversion=n,r}var d=n(26),l=Object.keys(d);e.exports=function(e){for(var t=o(e),n={},r=Object.keys(t),a=r.length,d=0;d<a;d++){var i=r[d],l=t[i];null!==l.parent&&(n[i]=s(i,t))}return n}},function(e,t,n){'use strict';const r=n(6),o=n(61),a=process.env;let s=(()=>{if(o('no-color')||o('no-colors')||o('color=false'))return 0;if(o('color=16m')||o('color=full')||o('color=truecolor'))return 3;if(o('color=256'))return 2;if(o('color')||o('colors')||o('color=true')||o('color=always'))return 1;if(process.stdout&&!process.stdout.isTTY)return 0;if('win32'===process.platform){const e=r.release().split('.');return 8<=+process.versions.node.split('.')[0]&&10<=+e[0]&&10586<=+e[2]?2:1}if('CI'in a)return['TRAVIS','CIRCLECI','APPVEYOR','GITLAB_CI'].some((e)=>e in a)||'codeship'===a.CI_NAME?1:0;if('TEAMCITY_VERSION'in a)return /^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(a.TEAMCITY_VERSION)?1:0;if('TERM_PROGRAM'in a){const e=parseInt((a.TERM_PROGRAM_VERSION||'').split('.')[0],10);switch(a.TERM_PROGRAM){case'iTerm.app':return 3<=e?3:2;case'Hyper':return 3;case'Apple_Terminal':return 2;}}return /-256(color)?$/i.test(a.TERM)?2:/^screen|^xterm|^vt100|color|ansi|cygwin|linux/i.test(a.TERM)?1:'COLORTERM'in a?1:'dumb'===a.TERM?0:0})();'FORCE_COLOR'in a&&(s=0===parseInt(a.FORCE_COLOR,10)?0:s||1),e.exports=process&&((e)=>0!==e&&{level:e,hasBasic:!0,has256:2<=e,has16m:3<=e})(s)},function(e){'use strict';e.exports=function(e,t){t=t||process.argv;var n=t.indexOf('--'),r=/^-{1,2}/.test(e)?'':'--',o=t.indexOf(r+e);return-1!==o&&(!(-1!==n)||o<n)}},function(e){'use strict';function t(e){return'u'===e[0]&&5===e.length||'x'===e[0]&&3===e.length?String.fromCharCode(parseInt(e.slice(1),16)):l[e]||e}function n(e,n){const r=[],o=n.trim().split(/\s*,\s*/g);let a;var s=!0,l=!1,u;try{for(var c=o[Symbol.iterator](),p;!(s=(p=c.next()).done);s=!0){const n=p.value;if(!isNaN(n))r.push(+n);else if(a=n.match(i))r.push(a[2].replace(d,(e,n,r)=>n?t(n):r));else throw new Error(`Invalid Chalk template style argument: ${n} (in style '${e}')`)}}catch(e){l=!0,u=e}finally{try{!s&&c.return&&c.return()}finally{if(l)throw u}}return r}function r(e){s.lastIndex=0;const t=[];for(let r;null!==(r=s.exec(e));){const e=r[1];if(r[2]){const o=n(e,r[2]);t.push([e].concat(o))}else t.push([e])}return t}function o(e,t){const n={};var r=!0,o=!1,a;try{for(var s=t[Symbol.iterator](),i;!(r=(i=s.next()).done);r=!0){const e=i.value;var d=!0,l=!1,u=void 0;try{for(var c=e.styles[Symbol.iterator](),p;!(d=(p=c.next()).done);d=!0){const t=p.value;n[t[0]]=e.inverse?null:t.slice(1)}}catch(e){l=!0,u=e}finally{try{!d&&c.return&&c.return()}finally{if(l)throw u}}}}catch(e){o=!0,a=e}finally{try{!r&&s.return&&s.return()}finally{if(o)throw a}}let f=e;var _=!0,m=!1,g;try{for(var h=Object.keys(n)[Symbol.iterator](),y;!(_=(y=h.next()).done);_=!0){const e=y.value;if(Array.isArray(n[e])){if(!(e in f))throw new Error(`Unknown Chalk style: ${e}`);f=0<n[e].length?f[e].apply(f,n[e]):f[e]}}}catch(e){m=!0,g=e}finally{try{!_&&h.return&&h.return()}finally{if(m)throw g}}return f}const a=/(?:\\(u[a-f0-9]{4}|x[a-f0-9]{2}|.))|(?:\{(~)?(\w+(?:\([^)]*\))?(?:\.\w+(?:\([^)]*\))?)*)(?:[ \t]|(?=\r?\n)))|(\})|((?:.|[\r\n\f])+?)/gi,s=/(?:^|\.)(\w+)(?:\(([^)]*)\))?/g,i=/^(['"])((?:\\.|(?!\1)[^\\])*)\1$/,d=/\\(u[0-9a-f]{4}|x[0-9a-f]{2}|.)|([^\\])/gi,l={n:'\n',r:'\r',t:'\t',b:'\b',f:'\f',v:'\x0B',0:'\0',"\\":'\\',e:'\x1B',a:'\x07'};e.exports=(e,n)=>{const s=[],i=[];let d=[];if(n.replace(a,(n,a,l,u,c,p)=>{if(a)d.push(t(a));else if(u){const t=d.join('');d=[],i.push(0===s.length?t:o(e,s)(t)),s.push({inverse:l,styles:r(u)})}else if(c){if(0===s.length)throw new Error('Found extraneous } in Chalk template literal');i.push(o(e,s)(d.join(''))),d=[],s.pop()}else d.push(p)}),i.push(d.join('')),0<s.length){const e=`Chalk template literal is missing ${s.length} closing bracket${1===s.length?'':'s'} (\`}\`)`;throw new Error(e)}return i.join('')}},function(e,t,n){'use strict';function r(e,t){const n=e.length,r=i.randomBytes(t).toJSON().data;return r.map((t)=>e[t%n]).join('')}function o(e,t){return e=a(e),t=a(t),Math.floor(i.randomBytes(1)[0]/255*(t-e+1))+e}var a=Math.ceil;const s=n(4),i=n(2);e.exports=function({isMinimal:e}){const t=r('abcdefghjkmnpqrstuvwxyz23456789!@#$%^&*()_+<>?:|{}-=[];,./ABCDEFGHJKLMNPQRSTUVWXYZ',16),n=o(1024,65535),a=o(200,1e3),i={service:'socks5://127.0.0.1:1080',servers:[{enabled:!0,service:`tcp://127.0.0.1:${n}`,key:t,presets:[{name:'ss-base'},{name:'ss-aead-cipher',params:{method:'aes-256-gcm'}}],tls_cert:'cert.pem'}],dns:[],dns_expire:3600,timeout:a,workers:0,log_path:'bs-client.log',log_level:'info',log_max_days:30};e&&(delete i.servers[0].tls_cert,delete i.dns,delete i.dns_expire,delete i.timeout,delete i.workers,delete i.log_path,delete i.log_level,delete i.log_max_days);const d={service:`tcp://0.0.0.0:${n}`,key:t,presets:[{name:'ss-base'},{name:'ss-aead-cipher',params:{method:'aes-256-gcm'}}],tls_key:'key.pem',tls_cert:'cert.pem',dns:[],dns_expire:3600,timeout:a,redirect:'',workers:0,log_path:'bs-server.log',log_level:'info',log_max_days:30};e&&(delete d.tls_key,delete d.tls_cert,delete d.dns,delete d.dns_expire,delete d.timeout,delete d.redirect,delete d.workers,delete d.log_path,delete d.log_level,delete d.log_max_days),s.writeFileSync('blinksocks.client.json',JSON.stringify(i,null,'  ')),s.writeFileSync('blinksocks.server.json',JSON.stringify(d,null,'  ')),console.log('> Generate Done. For help please see:'),console.log('> https://github.com/blinksocks/blinksocks/tree/master/docs/config/README.md')}},function(e,t,n){'use strict';function r(e){let t;try{const n=a.readFileSync(e);t=JSON.parse(n)}catch(t){throw Error(`fail to load/parse your '${e}': ${t.message}`)}return t}const o=n(27),a=n(4);e.exports=function(e,{core:{Hub:t,Config:n}}){try{if(n.init(r(e)),o.isMaster&&0<__WORKERS__){for(let e=0;e<__WORKERS__;++e)o.fork();console.log(`==> [bootstrap] started ${__WORKERS__} workers`)}else{const e=new t;e.on('close',()=>process.exit(0)),e.run(),process.on('SIGINT',()=>e.terminate())}}catch(e){console.error(e),process.exit(-1)}}},function(e,t,n){'use strict';e.exports=n(66)},function(e,t,n){'use strict';function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}Object.defineProperty(t,'__esModule',{value:!0}),t.utils=t.transports=t.proxies=t.presets=t.core=void 0;var o=n(13),a=r(o),s=n(16),i=r(s),d=n(50),l=r(d),u=n(47),c=r(u),p=n(0),f=r(p);t.core=a,t.presets=i,t.proxies=l,t.transports=c,t.utils=f},function(e,t,n){'use strict';function r(e,t){return e=o(e),t=o(t),Math.floor(s.default.randomBytes(1)[0]/255*(t-e))+e}var o=Math.ceil;Object.defineProperty(t,'__esModule',{value:!0}),t.BYTE_ORDER_LE=t.BYTE_ORDER_BE=void 0,t.numberToBuffer=function(e,t=2,n=i){if(1>t)throw Error('len must be greater than 0');const r=e>parseInt(`0x${'ff'.repeat(t)}`);if(r)throw Error(`Number ${e} is too big to put into a ${t} byte(s) size buffer`);const o=Buffer.alloc(t);return n===i?o.writeUIntBE(e,0,t):o.writeUIntLE(e,0,t),o},t.getRandomInt=r,t.getRandomChunks=function(e,t,n){const o=e.length,a=[];let s=0;for(;s<o-1;){const o=r(t,n);a.push(e.slice(s,s+o)),s+=o}return s<o&&a.push(e.slice(s)),a},t.getChunks=function(e,t){const n=e.length,r=[];let o=0;for(;o<n-1;)r.push(e.slice(o,o+t)),o+=t;return o<n&&r.push(e.slice(o)),r},t.generateMutexId=function(e=[],t=255){const n=Array.from(Array(t).keys());for(let r=0;r<e.length;++r)n.splice(e[r]-r,1);return 0<n.length?n[s.default.randomBytes(1)[0]%n.length]:-1};var a=n(2),s=function(e){return e&&e.__esModule?e:{default:e}}(a);const i=t.BYTE_ORDER_BE=0,d=t.BYTE_ORDER_LE=1},function(e,t,n){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}function o(e,t){const n=i.default.createHash(e);return n.update(t),n.digest()}function a(e,t,n){const r=i.default.createHmac(e,t);return r.update(n).digest()}Object.defineProperty(t,'__esModule',{value:!0}),t.hash=o,t.hmac=a,t.shake128=function(e){let t=[],r=0;return{nextBytes:function(o){if(r+o>t.length){const n=l.default.shake128.create(8*t.length+512);n.update(e),t=Buffer.from(n.arrayBuffer())}const n=t.slice(r,r+o);return r+=o,n}}},t.fnv1a=function(e){let t=2166136261;for(let n=0;n<e.length;++n)t^=e[n],t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24);const n=Buffer.alloc(4);return n.writeUIntBE(t>>>0,0,4),n},t.xor=function(e,t){if(e.length===t.length){const n=[];for(let r=0;r<e.length;++r)n[r]=e[r]^t[r];return e instanceof Buffer?Buffer.from(n):n}return null},t.EVP_BytesToKey=function(e,t,n){let r=Buffer.from(e),a=0;const s=[];for(;Buffer.concat(s).length<t+n;)0<a&&(r=Buffer.concat([s[a-1],Buffer.from(e)])),s.push(o('md5',r)),a+=1;return Buffer.concat(s).slice(0,t)},t.HKDF=function(e,n,r,o,s){const d=a(e,n,r);let l=Buffer.alloc(0),t=Buffer.alloc(0);for(let u=0;u<Math.ceil(s/d.length);++u)l=a(e,d,Buffer.concat([l,o,Buffer.alloc(1,u+1)])),t=Buffer.concat([t,l]);return t.slice(0,s)};var s=n(2),i=r(s),d=n(69),l=r(d)},function(e){'use strict';/**
 * [js-sha3]{@link https://github.com/emn178/js-sha3}
 *
 * @version 0.6.1
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2015-2017
 * @license MIT
 */(function(){function t(e,t,n){this.blocks=[],this.s=[],this.padding=t,this.outputBits=n,this.reset=!0,this.block=0,this.start=0,this.blockCount=1600-(e<<1)>>5,this.byteCount=this.blockCount<<2,this.outputBlocks=n>>5,this.extraBytes=(31&n)>>3;for(var r=0;50>r;++r)this.s[r]=0}function n(e,n,r){t.call(this,e,n,r)}var r='object'==typeof window?window:{},o=!r.JS_SHA3_NO_NODE_JS&&'object'==typeof process&&process.versions&&process.versions.node;o&&(r=global);var a=!r.JS_SHA3_NO_COMMON_JS&&'object'==typeof e&&e.exports,d=!r.JS_SHA3_NO_ARRAY_BUFFER&&'undefined'!=typeof ArrayBuffer,l=['0','1','2','3','4','5','6','7','8','9','a','b','c','d','e','f'],s=[31,7936,2031616,520093696],u=[4,1024,262144,67108864],c=[1,256,65536,16777216],p=[6,1536,393216,100663296],_=[0,8,16,24],m=[1,0,32898,0,32906,2147483648,2147516416,2147483648,32907,0,2147483649,0,2147516545,2147483648,32777,2147483648,138,0,136,0,2147516425,0,2147483658,0,2147516555,0,139,2147483648,32905,2147483648,32771,2147483648,32770,2147483648,128,2147483648,32778,0,2147483658,2147483648,2147516545,2147483648,32896,2147483648,2147483649,0,2147516424,2147483648],g=[224,256,384,512],h=[128,256],y=['hex','buffer','arrayBuffer','array'],b={128:168,256:136};(r.JS_SHA3_NO_NODE_JS||!Array.isArray)&&(Array.isArray=function(e){return'[object Array]'===Object.prototype.toString.call(e)});for(var v=function(e,n,r){return function(o){return new t(e,n,e).update(o)[r]()}},k=function(e,n,r){return function(o,a){return new t(e,n,a).update(o)[r]()}},x=function(e,t,r){return function(t,o,a,n){return B['cshake'+e].update(t,o,a,n)[r]()}},E=function(e,t,n){return function(t,r,o,a){return B['kmac'+e].update(t,r,o,a)[n]()}},S=function(e,t,n,r){for(var o=0,a;o<y.length;++o)a=y[o],e[a]=t(n,r,a);return e},w=function(e,n){var r=v(e,n,'hex');return r.create=function(){return new t(e,n,e)},r.update=function(e){return r.create().update(e)},S(r,v,e,n)},C=function(e,n){var r=k(e,n,'hex');return r.create=function(r){return new t(e,n,r)},r.update=function(e,t){return r.create(t).update(e)},S(r,k,e,n)},T=function(e,r){var o=b[e],a=x(e,r,'hex');return a.create=function(a,i,n){return i||n?new t(e,r,a).bytepad([i,n],o):B['shake'+e].create(a)},a.update=function(e,t,r,n){return a.create(t,r,n).update(e)},S(a,x,e,r)},P=function(e,t){var r=b[e],o=E(e,t,'hex');return o.create=function(o,a,i){return new n(e,t,a).bytepad(['KMAC',i],r).bytepad([o],r)},o.update=function(e,t,n,r){return o.create(e,n,r).update(t)},S(o,E,e,t)},O=[{name:'keccak',padding:c,bits:g,createMethod:w},{name:'sha3',padding:p,bits:g,createMethod:w},{name:'shake',padding:s,bits:h,createMethod:C},{name:'cshake',padding:u,bits:h,createMethod:T},{name:'kmac',padding:u,bits:h,createMethod:P}],B={},I=[],R=0;R<O.length;++R)for(var i=O[R],N=i.bits,L=0,M;L<N.length;++L)if(M=i.name+'_'+N[L],I.push(M),B[M]=i.createMethod(N[L],i.padding),'sha3'!==i.name){var D=i.name+N[L];I.push(D),B[D]=B[M]}t.prototype.update=function(e){var t='string'!=typeof e;t&&e.constructor===r.ArrayBuffer&&(e=new Uint8Array(e));var n=e.length;if(t&&('number'!=typeof n||!Array.isArray(e)&&!(d&&ArrayBuffer.isView(e))))throw'input is invalid type';for(var o=this.blocks,a=this.byteCount,l=this.blockCount,u=0,c=this.s,s,i;u<n;){if(this.reset)for(this.reset=!1,o[0]=this.block,s=1;s<l+1;++s)o[s]=0;if(t)for(s=this.start;u<n&&s<a;++u)o[s>>2]|=e[u]<<_[3&s++];else for(s=this.start;u<n&&s<a;++u)i=e.charCodeAt(u),128>i?o[s>>2]|=i<<_[3&s++]:2048>i?(o[s>>2]|=(192|i>>6)<<_[3&s++],o[s>>2]|=(128|63&i)<<_[3&s++]):55296>i||57344<=i?(o[s>>2]|=(224|i>>12)<<_[3&s++],o[s>>2]|=(128|63&i>>6)<<_[3&s++],o[s>>2]|=(128|63&i)<<_[3&s++]):(i=65536+((1023&i)<<10|1023&e.charCodeAt(++u)),o[s>>2]|=(240|i>>18)<<_[3&s++],o[s>>2]|=(128|63&i>>12)<<_[3&s++],o[s>>2]|=(128|63&i>>6)<<_[3&s++],o[s>>2]|=(128|63&i)<<_[3&s++]);if(this.lastByteIndex=s,s>=a){for(this.start=s-a,this.block=o[l],s=0;s<l;++s)c[s]^=o[s];A(c),this.reset=!0}else this.start=s}return this},t.prototype.encode=function(e,t){var r=255&e,o=1,n=[r];for(e>>=8,r=255&e;0<r;)n.unshift(r),e>>=8,r=255&e,++o;return t?n.push(o):n.unshift(o),this.update(n),n.length},t.prototype.encodeString=function(e){e=e||'';var t='string'!=typeof e;t&&e.constructor===r.ArrayBuffer&&(e=new Uint8Array(e));var n=e.length;if(t&&('number'!=typeof n||!Array.isArray(e)&&!(d&&ArrayBuffer.isView(e))))throw'input is invalid type';var o=0;if(t)o=n;else for(var a=0,s;a<e.length;++a)s=e.charCodeAt(a),128>s?o+=1:2048>s?o+=2:55296>s||57344<=s?o+=3:(s=65536+((1023&s)<<10|1023&e.charCodeAt(++a)),o+=4);return o+=this.encode(8*o),this.update(e),o},t.prototype.bytepad=function(e,t){for(var n=this.encode(t),r=0;r<e.length;++r)n+=this.encodeString(e[r]);var o=t-n%t,a=[];return a.length=o,this.update(a),this},t.prototype.finalize=function(){var e=this.blocks,t=this.lastByteIndex,n=this.blockCount,r=this.s;if(e[t>>2]|=this.padding[3&t],this.lastByteIndex===this.byteCount)for(e[0]=e[n],t=1;t<n+1;++t)e[t]=0;for(e[n-1]|=2147483648,t=0;t<n;++t)r[t]^=e[t];A(r)},t.prototype.toString=t.prototype.hex=function(){this.finalize();for(var e=this.blockCount,t=this.s,n=this.outputBlocks,r=this.extraBytes,o=0,a=0,s='',i;a<n;){for(o=0;o<e&&a<n;++o,++a)i=t[o],s+=l[15&i>>4]+l[15&i]+l[15&i>>12]+l[15&i>>8]+l[15&i>>20]+l[15&i>>16]+l[15&i>>28]+l[15&i>>24];0==a%e&&(A(t),o=0)}return r&&(i=t[o],0<r&&(s+=l[15&i>>4]+l[15&i]),1<r&&(s+=l[15&i>>12]+l[15&i>>8]),2<r&&(s+=l[15&i>>20]+l[15&i>>16])),s},t.prototype.arrayBuffer=function(){this.finalize();var e=this.blockCount,t=this.s,n=this.outputBlocks,r=this.extraBytes,o=0,a=0,s=this.outputBits>>3,i;i=r?new ArrayBuffer(n+1<<2):new ArrayBuffer(s);for(var d=new Uint32Array(i);a<n;){for(o=0;o<e&&a<n;++o,++a)d[a]=t[o];0==a%e&&A(t)}return r&&(d[o]=t[o],i=i.slice(0,s)),i},t.prototype.buffer=t.prototype.arrayBuffer,t.prototype.digest=t.prototype.array=function(){this.finalize();for(var e=this.blockCount,t=this.s,n=this.outputBlocks,r=this.extraBytes,o=0,a=0,s=[],i,d;a<n;){for(o=0;o<e&&a<n;++o,++a)i=a<<2,d=t[o],s[i]=255&d,s[i+1]=255&d>>8,s[i+2]=255&d>>16,s[i+3]=255&d>>24;0==a%e&&A(t)}return r&&(i=a<<2,d=t[o],0<r&&(s[i]=255&d),1<r&&(s[i+1]=255&d>>8),2<r&&(s[i+2]=255&d>>16)),s},n.prototype=new t,n.prototype.finalize=function(){return this.encode(this.outputBits,!0),t.prototype.finalize.call(this)};var A=function(e){var t,r,o,n,a,s,i,d,l,u,c,p,f,_,g,h,y,b,v,k,x,E,S,w,C,T,P,O,B,I,R,N,L,M,D,A,z,j,F,U,H,W,V,q,K,G,Y,$,Q,J,Z,X,ee,te,ne,re,oe,ae,se,ie,de,le,ue;for(o=0;48>o;o+=2)n=e[0]^e[10]^e[20]^e[30]^e[40],a=e[1]^e[11]^e[21]^e[31]^e[41],s=e[2]^e[12]^e[22]^e[32]^e[42],i=e[3]^e[13]^e[23]^e[33]^e[43],d=e[4]^e[14]^e[24]^e[34]^e[44],l=e[5]^e[15]^e[25]^e[35]^e[45],u=e[6]^e[16]^e[26]^e[36]^e[46],c=e[7]^e[17]^e[27]^e[37]^e[47],p=e[8]^e[18]^e[28]^e[38]^e[48],f=e[9]^e[19]^e[29]^e[39]^e[49],t=p^(s<<1|i>>>31),r=f^(i<<1|s>>>31),e[0]^=t,e[1]^=r,e[10]^=t,e[11]^=r,e[20]^=t,e[21]^=r,e[30]^=t,e[31]^=r,e[40]^=t,e[41]^=r,t=n^(d<<1|l>>>31),r=a^(l<<1|d>>>31),e[2]^=t,e[3]^=r,e[12]^=t,e[13]^=r,e[22]^=t,e[23]^=r,e[32]^=t,e[33]^=r,e[42]^=t,e[43]^=r,t=s^(u<<1|c>>>31),r=i^(c<<1|u>>>31),e[4]^=t,e[5]^=r,e[14]^=t,e[15]^=r,e[24]^=t,e[25]^=r,e[34]^=t,e[35]^=r,e[44]^=t,e[45]^=r,t=d^(p<<1|f>>>31),r=l^(f<<1|p>>>31),e[6]^=t,e[7]^=r,e[16]^=t,e[17]^=r,e[26]^=t,e[27]^=r,e[36]^=t,e[37]^=r,e[46]^=t,e[47]^=r,t=u^(n<<1|a>>>31),r=c^(a<<1|n>>>31),e[8]^=t,e[9]^=r,e[18]^=t,e[19]^=r,e[28]^=t,e[29]^=r,e[38]^=t,e[39]^=r,e[48]^=t,e[49]^=r,_=e[0],g=e[1],G=e[11]<<4|e[10]>>>28,Y=e[10]<<4|e[11]>>>28,O=e[20]<<3|e[21]>>>29,B=e[21]<<3|e[20]>>>29,ie=e[31]<<9|e[30]>>>23,de=e[30]<<9|e[31]>>>23,W=e[40]<<18|e[41]>>>14,V=e[41]<<18|e[40]>>>14,M=e[2]<<1|e[3]>>>31,D=e[3]<<1|e[2]>>>31,h=e[13]<<12|e[12]>>>20,y=e[12]<<12|e[13]>>>20,$=e[22]<<10|e[23]>>>22,Q=e[23]<<10|e[22]>>>22,I=e[33]<<13|e[32]>>>19,R=e[32]<<13|e[33]>>>19,le=e[42]<<2|e[43]>>>30,ue=e[43]<<2|e[42]>>>30,te=e[5]<<30|e[4]>>>2,ne=e[4]<<30|e[5]>>>2,A=e[14]<<6|e[15]>>>26,z=e[15]<<6|e[14]>>>26,b=e[25]<<11|e[24]>>>21,v=e[24]<<11|e[25]>>>21,J=e[34]<<15|e[35]>>>17,Z=e[35]<<15|e[34]>>>17,N=e[45]<<29|e[44]>>>3,L=e[44]<<29|e[45]>>>3,w=e[6]<<28|e[7]>>>4,C=e[7]<<28|e[6]>>>4,re=e[17]<<23|e[16]>>>9,oe=e[16]<<23|e[17]>>>9,j=e[26]<<25|e[27]>>>7,F=e[27]<<25|e[26]>>>7,k=e[36]<<21|e[37]>>>11,x=e[37]<<21|e[36]>>>11,X=e[47]<<24|e[46]>>>8,ee=e[46]<<24|e[47]>>>8,q=e[8]<<27|e[9]>>>5,K=e[9]<<27|e[8]>>>5,T=e[18]<<20|e[19]>>>12,P=e[19]<<20|e[18]>>>12,ae=e[29]<<7|e[28]>>>25,se=e[28]<<7|e[29]>>>25,U=e[38]<<8|e[39]>>>24,H=e[39]<<8|e[38]>>>24,E=e[48]<<14|e[49]>>>18,S=e[49]<<14|e[48]>>>18,e[0]=_^~h&b,e[1]=g^~y&v,e[10]=w^~T&O,e[11]=C^~P&B,e[20]=M^~A&j,e[21]=D^~z&F,e[30]=q^~G&$,e[31]=K^~Y&Q,e[40]=te^~re&ae,e[41]=ne^~oe&se,e[2]=h^~b&k,e[3]=y^~v&x,e[12]=T^~O&I,e[13]=P^~B&R,e[22]=A^~j&U,e[23]=z^~F&H,e[32]=G^~$&J,e[33]=Y^~Q&Z,e[42]=re^~ae&ie,e[43]=oe^~se&de,e[4]=b^~k&E,e[5]=v^~x&S,e[14]=O^~I&N,e[15]=B^~R&L,e[24]=j^~U&W,e[25]=F^~H&V,e[34]=$^~J&X,e[35]=Q^~Z&ee,e[44]=ae^~ie&le,e[45]=se^~de&ue,e[6]=k^~E&_,e[7]=x^~S&g,e[16]=I^~N&w,e[17]=R^~L&C,e[26]=U^~W&M,e[27]=H^~V&D,e[36]=J^~X&q,e[37]=Z^~ee&K,e[46]=ie^~le&te,e[47]=de^~ue&ne,e[8]=E^~_&h,e[9]=S^~g&y,e[18]=N^~w&T,e[19]=L^~C&P,e[28]=W^~M&A,e[29]=V^~D&z,e[38]=X^~q&G,e[39]=ee^~K&Y,e[48]=le^~te&re,e[49]=ue^~ne&oe,e[0]^=m[o],e[1]^=m[o+1]};if(a)e.exports=B;else for(var R=0;R<I.length;++R)r[I[R]]=B[I[R]]})()},function(e,t){'use strict';Object.defineProperty(t,'__esModule',{value:!0}),t.getCurrentTimestampInt=function(){return Math.floor(new Date().getTime()/1e3)}},function(e,t){'use strict';Object.defineProperty(t,'__esModule',{value:!0}),t.kebabCase=function(e){const t=[];for(let n=0;n<e.length;++n){const r=e[n];'A'<=r&&'Z'>=r?(0<n&&t.push('-'),t.push(r.toLowerCase())):t.push(r)}return t.join('')}},function(e,t){'use strict';Object.defineProperty(t,'__esModule',{value:!0}),t.isValidHostname=function(e){return!('string'!=typeof e)&&(1>e.length||253<e.length?!1:!1!==/^([a-z\d](-*[a-z\d])*)(\.([a-z\d](-*[a-z\d])*))*$/i.test(e)&&!1!==/^[^.]{1,63}(\.[^.]{1,63})*$/.test(e))},t.isValidPort=function(e){return!!Number.isInteger(e)&&!(0>=e||65535<=e)}},function(e,t,n){'use strict';Object.defineProperty(t,'__esModule',{value:!0}),t.AdvancedBuffer=void 0;var r=n(3),o=function(e){return e&&e.__esModule?e:{default:e}}(r);class a extends o.default{constructor(e={}){if(super(),this._buffer=Buffer.alloc(0),this._getPacketLength=null,this._nextLength=0,'function'!=typeof e.getPacketLength)throw Error('options.getPacketLength should be a function');this._getPacketLength=e.getPacketLength}put(e,...t){if(!(e instanceof Buffer))throw Error('chunk must be a Buffer');this._buffer=this._digest(Buffer.concat([this._buffer,e]),...t)}final(){return this._buffer}clear(){this._buffer=Buffer.alloc(0)}_digest(e,...t){const n=this._nextLength||this._getPacketLength(e,...t);if(n instanceof Buffer)return this._digest(n,...t);return 0===n||void 0===n?e:0>n?Buffer.alloc(0):e.length===n?(this.emit('data',e,...t),this._nextLength=0,Buffer.alloc(0)):e.length<n?(this._nextLength=n,e):e.length>n?(this.emit('data',e.slice(0,n),...t),this._nextLength=0,this._digest(e.slice(n),...t)):void 0}}t.AdvancedBuffer=a},function(e,t,n){'use strict';Object.defineProperty(t,'__esModule',{value:!0}),t.logger=void 0;var r=n(10),o=function(e){return e&&e.__esModule?e:{default:e}}(r);t.logger=new o.default.Logger},function(e){e.exports={name:'winston',description:'A multi-transport async logging library for Node.js',version:'2.4.0',author:'Charlie Robbins <charlie.robbins@gmail.com>',maintainers:['Jarrett Cruger <jcrugzz@gmail.com>','Alberto Pose <albertopose@gmail.com>'],repository:{type:'git',url:'https://github.com/winstonjs/winston.git'},keywords:['winston','logging','sysadmin','tools'],dependencies:{async:'~1.0.0',colors:'1.0.x',cycle:'1.0.x',eyes:'0.1.x',isstream:'0.1.x',"stack-trace":'0.0.x'},devDependencies:{"cross-spawn-async":'^2.0.0',hock:'1.x.x',"std-mocks":'~1.0.0',vows:'0.7.x'},main:'./lib/winston',scripts:{test:'vows --spec --isolate'},engines:{node:'>= 0.10.0'},license:'MIT'}},function(e,t,n){'use strict';Object.defineProperty(t,'Console',{configurable:!0,enumerable:!0,get:function(){return n(77).Console}}),Object.defineProperty(t,'File',{configurable:!0,enumerable:!0,get:function(){return n(93).File}}),Object.defineProperty(t,'Http',{configurable:!0,enumerable:!0,get:function(){return n(95).Http}}),Object.defineProperty(t,'Memory',{configurable:!0,enumerable:!0,get:function(){return n(96).Memory}})},function(e,t,n){'use strict';var r=n(3),o=n(6),a=n(7),s=n(9),i=n(15).Transport,d=t.Console=function(e){i.call(this,e),e=e||{},this.json=e.json||!1,this.colorize=e.colorize||!1,this.prettyPrint=e.prettyPrint||!1,this.timestamp='undefined'!=typeof e.timestamp&&e.timestamp,this.showLevel=!(e.showLevel!==void 0)||e.showLevel,this.label=e.label||null,this.logstash=e.logstash||!1,this.depth=e.depth||null,this.align=e.align||!1,this.stderrLevels=function(e,t){var n='Cannot have non-string elements in stderrLevels Array';if(t){if(e)throw new Error('Cannot set debugStdout and stderrLevels together');return s.stringArrayToSet(['error'],n)}if(!e)return s.stringArrayToSet(['error','debug'],n);if(!Array.isArray(e))throw new Error('Cannot set stderrLevels to type other than Array');return s.stringArrayToSet(e,n)}(e.stderrLevels,e.debugStdout),this.eol=e.eol||o.EOL,this.json&&(this.stringify=e.stringify||function(e){return JSON.stringify(e,null,2)})};a.inherits(d,i),d.prototype.name='console',d.prototype.log=function(e,t,n,r){if(this.silent)return r(null,!0);var o=this,a;a=s.log({colorize:this.colorize,json:this.json,level:e,message:t,meta:n,stringify:this.stringify,timestamp:this.timestamp,showLevel:this.showLevel,prettyPrint:this.prettyPrint,raw:this.raw,label:this.label,logstash:this.logstash,depth:this.depth,formatter:this.formatter,align:this.align,humanReadableUnhandledException:this.humanReadableUnhandledException}),this.stderrLevels[e]?process.stderr.write(a+this.eol):process.stdout.write(a+this.eol),o.emit('logged'),r(null,!0)}},function(e,t,n){'use strict';var r=t;r.decycle=function(e){var t=[],n=[];return function e(r,o){var a,s,i;if('object'==typeof r&&null!==r&&!(r instanceof Boolean)&&!(r instanceof Date)&&!(r instanceof Number)&&!(r instanceof RegExp)&&!(r instanceof String)){for(a=0;a<t.length;a+=1)if(t[a]===r)return{$ref:n[a]};if(t.push(r),n.push(o),'[object Array]'===Object.prototype.toString.apply(r))for(i=[],a=0;a<r.length;a+=1)i[a]=e(r[a],o+'['+a+']');else for(s in i={},r)Object.prototype.hasOwnProperty.call(r,s)&&(i[s]=e(r[s],o+'['+JSON.stringify(s)+']'));return i}return r}(e,'$')},r.retrocycle=function(e){var t=/^\$(?:\[(?:\d+|\"(?:[^\\\"\u0000-\u001f]|\\([\\\"\/bfnrt]|u[0-9a-zA-Z]{4}))*\")\])*$/;return function e(n){var r,o,a,s;if(n&&'object'==typeof n)if('[object Array]'===Object.prototype.toString.apply(n))for(r=0;r<n.length;r+=1)o=n[r],o&&'object'==typeof o&&(s=o.$ref,'string'==typeof s&&t.test(s)?n[r]=eval(s):e(o));else for(a in n)'object'==typeof n[a]&&(o=n[a],o&&(s=o.$ref,'string'==typeof s&&t.test(s)?n[a]=eval(s):e(o)))}(e),e}},function(e){e.exports=require('string_decoder')},function(e,t,n){'use strict';var r=n(14);e.exports=r},function(e){'use strict';var t={};e.exports=t;var n={reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],inverse:[7,27],hidden:[8,28],strikethrough:[9,29],black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],gray:[90,39],grey:[90,39],bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],blackBG:[40,49],redBG:[41,49],greenBG:[42,49],yellowBG:[43,49],blueBG:[44,49],magentaBG:[45,49],cyanBG:[46,49],whiteBG:[47,49]};Object.keys(n).forEach(function(e){var r=n[e],o=t[e]=[];o.open='\x1B['+r[0]+'m',o.close='\x1B['+r[1]+'m'})},function(e){'use strict';var t=process.argv;e.exports=function(){return-1!==t.indexOf('--no-color')||-1!==t.indexOf('--color=false')?!1:-1!==t.indexOf('--color')||-1!==t.indexOf('--color=true')||-1!==t.indexOf('--color=always')||(process.stdout&&!process.stdout.isTTY?!1:!('win32'!==process.platform)||!!('COLORTERM'in process.env)||'dumb'!==process.env.TERM&&!!/^screen|^xterm|^vt100|color|ansi|cygwin|linux/i.test(process.env.TERM))}()},function(e){function t(e){throw new Error('Cannot find module \''+e+'\'.')}t.keys=function(){return[]},t.resolve=t,e.exports=t,t.id=83},function(e){'use strict';e.exports=function(e){var t='';e=e||'Run the trap, drop the bass',e=e.split('');var n={a:['@','\u0104','\u023A','\u0245','\u0394','\u039B','\u0414'],b:['\xDF','\u0181','\u0243','\u026E','\u03B2','\u0E3F'],c:['\xA9','\u023B','\u03FE'],d:['\xD0','\u018A','\u0500','\u0501','\u0502','\u0503'],e:['\xCB','\u0115','\u018E','\u0258','\u03A3','\u03BE','\u04BC','\u0A6C'],f:['\u04FA'],g:['\u0262'],h:['\u0126','\u0195','\u04A2','\u04BA','\u04C7','\u050A'],i:['\u0F0F'],j:['\u0134'],k:['\u0138','\u04A0','\u04C3','\u051E'],l:['\u0139'],m:['\u028D','\u04CD','\u04CE','\u0520','\u0521','\u0D69'],n:['\xD1','\u014B','\u019D','\u0376','\u03A0','\u048A'],o:['\xD8','\xF5','\xF8','\u01FE','\u0298','\u047A','\u05DD','\u06DD','\u0E4F'],p:['\u01F7','\u048E'],q:['\u09CD'],r:['\xAE','\u01A6','\u0210','\u024C','\u0280','\u042F'],s:['\xA7','\u03DE','\u03DF','\u03E8'],t:['\u0141','\u0166','\u0373'],u:['\u01B1','\u054D'],v:['\u05D8'],w:['\u0428','\u0460','\u047C','\u0D70'],x:['\u04B2','\u04FE','\u04FC','\u04FD'],y:['\xA5','\u04B0','\u04CB'],z:['\u01B5','\u0240']};return e.forEach(function(e){e=e.toLowerCase();var r=n[e]||[' '],o=Math.floor(Math.random()*r.length);t+='undefined'==typeof n[e]?e:n[e][o]}),t}},function(e){'use strict';e.exports=function(e){function t(e){var t=Math.floor(Math.random()*e);return t}function n(e){var t=!1;return o.filter(function(n){t=n===e}),t}e=e||'   he is here   ';var r={up:['\u030D','\u030E','\u0304','\u0305','\u033F','\u0311','\u0306','\u0310','\u0352','\u0357','\u0351','\u0307','\u0308','\u030A','\u0342','\u0313','\u0308','\u034A','\u034B','\u034C','\u0303','\u0302','\u030C','\u0350','\u0300','\u0301','\u030B','\u030F','\u0312','\u0313','\u0314','\u033D','\u0309','\u0363','\u0364','\u0365','\u0366','\u0367','\u0368','\u0369','\u036A','\u036B','\u036C','\u036D','\u036E','\u036F','\u033E','\u035B','\u0346','\u031A'],down:['\u0316','\u0317','\u0318','\u0319','\u031C','\u031D','\u031E','\u031F','\u0320','\u0324','\u0325','\u0326','\u0329','\u032A','\u032B','\u032C','\u032D','\u032E','\u032F','\u0330','\u0331','\u0332','\u0333','\u0339','\u033A','\u033B','\u033C','\u0345','\u0347','\u0348','\u0349','\u034D','\u034E','\u0353','\u0354','\u0355','\u0356','\u0359','\u035A','\u0323'],mid:['\u0315','\u031B','\u0300','\u0301','\u0358','\u0321','\u0322','\u0327','\u0328','\u0334','\u0335','\u0336','\u035C','\u035D','\u035E','\u035F','\u0360','\u0362','\u0338','\u0337','\u0361',' \u0489']},o=[].concat(r.up,r.down,r.mid),a={};return function(e,o){var a='',s,u;for(u in o=o||{},o.up=o.up||!0,o.mid=o.mid||!0,o.down=o.down||!0,o.size=o.size||'maxi',e=e.split(''),e)if(!n(u)){switch(a+=e[u],s={up:0,down:0,mid:0},o.size){case'mini':s.up=t(8),s.min=t(2),s.down=t(8);break;case'maxi':s.up=t(16)+3,s.min=t(4)+1,s.down=t(64)+3;break;default:s.up=t(8)+1,s.mid=t(6)/2,s.down=t(8)+1;}var l=['up','mid','down'];for(var c in l)for(var d=l[c],p=0;p<=s[d];p++)o[d]&&(a+=r[d][t(r[d].length)])}return a}(e)}},function(e,t,n){'use strict';var r=n(14);e.exports=function(){return function(e,t){if(' '===e)return e;switch(t%3){case 0:return r.red(e);case 1:return r.white(e);case 2:return r.blue(e);}}}()},function(e,t,n){'use strict';var r=n(14);e.exports=function(e,t){return 0==t%2?e:r.inverse(e)}},function(e,t,n){'use strict';var r=n(14);e.exports=function(){var e=['red','yellow','green','blue','magenta'];return function(t,n){return' '===t?t:r[e[n++%e.length]](t)}}()},function(e,t,n){'use strict';var r=n(14);e.exports=function(){var e=['underline','inverse','grey','yellow','red','green','blue','white','cyan','magenta'];return function(t){return' '===t?t:r[e[Math.round(Math.random()*(e.length-1))]](t)}}()},function(e,t){'use strict';var n=t;n.levels={error:0,warn:1,help:2,data:3,info:4,debug:5,prompt:6,verbose:7,input:8,silly:9},n.colors={error:'red',warn:'yellow',help:'cyan',data:'grey',info:'green',debug:'blue',prompt:'grey',verbose:'cyan',input:'grey',silly:'magenta'}},function(e,t){'use strict';var n=t;n.levels={error:0,warn:1,info:2,verbose:3,debug:4,silly:5},n.colors={error:'red',warn:'yellow',info:'green',verbose:'cyan',debug:'blue',silly:'magenta'}},function(e,t){'use strict';var n=t;n.levels={emerg:0,alert:1,crit:2,error:3,warning:4,notice:5,info:6,debug:7},n.colors={emerg:'red',alert:'yellow',crit:'red',error:'red',warning:'red',notice:'yellow',info:'green',debug:'blue'}},function(e,t,n){'use strict';var r=n(3),o=n(4),a=n(8),s=n(7),i=n(29),d=n(19),l=n(9),u=n(15).Transport,c=n(94).isWritable,p=n(11).Stream,f=n(6),_=t.File=function(e){function t(t){Array.prototype.slice.call(arguments,1).forEach(function(n){if(e[n])throw new Error('Cannot set '+n+' and '+t+'together')})}var n=this;if(u.call(this,e),e.filename||e.dirname)t('filename or dirname','stream'),this._basename=this.filename=e.filename?a.basename(e.filename):'winston.log',this.dirname=e.dirname||a.dirname(e.filename),this.options=e.options||{flags:'a'},this.options.highWaterMark=this.options.highWaterMark||24;else if(e.stream)t('stream','filename','maxsize'),this._stream=e.stream,this._isStreams2=c(this._stream),this._stream.on('error',function(e){n.emit('error',e)}),this._stream.setMaxListeners(Infinity);else throw new Error('Cannot log to file without filename or stream.');this.json=!1!==e.json,this.logstash=e.logstash||!1,this.colorize=e.colorize||!1,this.maxsize=e.maxsize||null,this.rotationFormat=e.rotationFormat||!1,this.zippedArchive=e.zippedArchive||!1,this.maxFiles=e.maxFiles||null,this.prettyPrint=e.prettyPrint||!1,this.label=e.label||null,this.timestamp=null==e.timestamp||e.timestamp,this.eol=e.eol||f.EOL,this.tailable=e.tailable||!1,this.depth=e.depth||null,this.showLevel=void 0===e.showLevel||e.showLevel,this.maxRetries=e.maxRetries||2,this.json&&(this.stringify=e.stringify),this._size=0,this._created=0,this._buffer=[],this._draining=!1,this._opening=!1,this._failures=0,this._archive=null};s.inherits(_,u),_.prototype.name='file',_.prototype.log=function(e,t,n,r){if(this.silent)return r(null,!0);if(this._failures>=this.maxRetries)return r(new Error('Transport is in a failed state.'));var o=this;'string'!=typeof t&&(t=''+t);var a=l.log({level:e,message:t,meta:n,json:this.json,logstash:this.logstash,colorize:this.colorize,prettyPrint:this.prettyPrint,timestamp:this.timestamp,showLevel:this.showLevel,stringify:this.stringify,label:this.label,depth:this.depth,formatter:this.formatter,humanReadableUnhandledException:this.humanReadableUnhandledException});'string'==typeof a&&(a+=this.eol),this.filename?this.open(function(e){return e?o._buffer.push([a,r]):void(o._write(a,r),o._size+=a.length,o._lazyDrain())}):(this._write(a,r),this._size+=a.length,this._lazyDrain())},_.prototype._write=function(e,t){if(this._isStreams2)return this._stream.write(e),t&&process.nextTick(function(){t(null,!0)});var n=this._stream.write(e);return t?!1===n?this._stream.once('drain',function(){t(null,!0)}):void process.nextTick(function(){t(null,!0)}):void 0},_.prototype.query=function(e,t){function n(e,t){try{var n=JSON.parse(e);s(n)&&r(n)}catch(n){t||c.emit('error',n)}}function r(t){if(e.rows&&l.length>=e.rows&&'desc'!=e.order)return void(c.readable&&c.destroy());if(e.fields){var n={};e.fields.forEach(function(e){n[e]=t[e]}),t=n}'desc'===e.order&&l.length>=e.rows&&l.shift(),l.push(t)}function s(t){if(t&&'object'==typeof t){var n=new Date(t.timestamp);return e.from&&n<e.from||e.until&&n>e.until||e.level&&e.level!==t.level?void 0:!0}}'function'==typeof e&&(t=e,e={});var i=a.join(this.dirname,this.filename),e=this.normalizeQuery(e),d='',l=[],u=0,c=o.createReadStream(i,{encoding:'utf8'});c.on('error',function(e){return c.readable&&c.destroy(),t?'ENOENT'===e.code?t(null,l):t(e):void 0}),c.on('data',function(t){for(var t=(d+t).split(/\n+/),r=t.length-1,o=0;o<r;o++)(!e.start||u>=e.start)&&n(t[o]),u++;d=t[r]}),c.on('close',function(){d&&n(d,!0),'desc'===e.order&&(l=l.reverse()),t&&t(null,l)})},_.prototype.stream=function(e){var t=a.join(this.dirname,this.filename),e=e||{},n=new p,r={file:t,start:e.start};return n.destroy=l.tailFile(r,function(e,t){if(e)return n.emit('error',e);try{n.emit('data',t),t=JSON.parse(t),n.emit('log',t)}catch(t){n.emit('error',t)}}),n},_.prototype.open=function(e){if(this.opening)return e(!0);return!this._stream||this.maxsize&&this._size>=this.maxsize?(e(!0),this._createStream()):void(this._archive=this.zippedArchive?this._stream.path:null,e())},_.prototype.close=function(){var e=this;this._stream&&(this._stream.end(),this._stream.destroySoon(),this._stream.once('finish',function(){e.emit('flush'),e.emit('closed')}))},_.prototype.flush=function(){var e=this;return this._buffer.length?void(this._buffer.forEach(function(t){var n=t[0],r=t[1];process.nextTick(function(){e._write(n,r),e._size+=n.length})}),e._buffer.length=0,e._stream.once('drain',function(){e.emit('flush'),e.emit('logged')})):e.emit('flush')},_.prototype._createStream=function(){var e=this;this.opening=!0,function t(n){function r(t){e._stream&&(e._stream.end(),e._stream.destroySoon()),e._size=t,e.filename=n,e._stream=o.createWriteStream(i,e.options),e._isStreams2=c(e._stream),e._stream.on('error',function(t){e._failures<e.maxRetries?(e._createStream(),e._failures++):e.emit('error',t)}),e._stream.setMaxListeners(Infinity),e.once('flush',function(){e.flush(),e.opening=!1,e.emit('open',i)}),e.flush(),s()}function s(){if(e._archive){var t=d.createGzip(),n=o.createReadStream(e._archive+''),r=o.createWriteStream(e._archive+'.gz');n.pipe(t).pipe(r),o.unlink(e._archive+'',function(){}),e._archive=''}}var i=a.join(e.dirname,n);o.stat(i,function(n,o){return n?'ENOENT'===n.code?r(0):e.emit('error',n):!o||e.maxsize&&o.size>=e.maxsize?e._incFile(function(){t(e._getFile())}):void r(o.size)})}(this._getFile())},_.prototype._incFile=function(e){var t=a.extname(this._basename),n=a.basename(this._basename,t);this.tailable?this._checkMaxFilesTailable(t,n,e):(this._created+=1,this._checkMaxFilesIncrementing(t,n,e))},_.prototype._getFile=function(){var e=a.extname(this._basename),t=a.basename(this._basename,e);return!this.tailable&&this._created?t+(this.rotationFormat?this.rotationFormat():this._created)+e:t+e},_.prototype._checkMaxFilesIncrementing=function(e,t,n){var r=this,s,i;return r.zippedArchive&&(r._archive=a.join(r.dirname,t+(1===r._created?'':r._created-1)+e)),!r.maxFiles||r._created<r.maxFiles?n():void(s=r._created-r.maxFiles,i=a.join(r.dirname,t+(0===s?'':s)+e+(r.zippedArchive?'.gz':'')),o.unlink(i,n))},_.prototype._checkMaxFilesTailable=function(e,t,n){var r=[],s=this;if(this.maxFiles){for(var d=this.maxFiles-1;0<d;d--)r.push(function(n){return function(r){var i=a.join(s.dirname,t+(n-1)+e+(s.zippedArchive?'.gz':''));o.exists(i,function(d){return d?void o.rename(i,a.join(s.dirname,t+n+e+(s.zippedArchive?'.gz':'')),r):r(null)})}}(d));s.zippedArchive&&(s._archive=a.join(s.dirname,t+1+e)),i.series(r,function(){o.rename(a.join(s.dirname,t+e),a.join(s.dirname,t+1+e),n)})}},_.prototype._lazyDrain=function(){var e=this;!this._draining&&this._stream&&(this._draining=!0,this._stream.once('drain',function(){e._draining=!1,e.emit('logged')}))}},function(e,t,n){'use strict';function r(e){return e instanceof s.Stream}function o(e){return r(e)&&'function'==typeof e._read&&'object'==typeof e._readableState}function a(e){return r(e)&&'function'==typeof e._write&&'object'==typeof e._writableState}var s=n(11);e.exports=r,e.exports.isReadable=o,e.exports.isWritable=a,e.exports.isDuplex=function(e){return o(e)&&a(e)}},function(e,t,n){'use strict';var r=n(7),o=n(10),a=n(20),s=n(30),i=n(11).Stream,d=n(15).Transport,l=t.Http=function(e){d.call(this,e),e=e||{},this.name='http',this.ssl=!!e.ssl,this.host=e.host||'localhost',this.port=e.port,this.auth=e.auth,this.path=e.path||'',this.agent=e.agent,this.port||(this.port=this.ssl?443:80)};r.inherits(l,o.Transport),l.prototype.name='http',l.prototype._request=function(e,t){e=e||{};var n=e.auth||this.auth,r=e.path||this.path||'',o;delete e.auth,delete e.path,o=(this.ssl?s:a).request({host:this.host,port:this.port,path:'/'+r.replace(/^\//,''),method:'POST',headers:{"Content-Type":'application/json'},agent:this.agent,auth:n?n.username+':'+n.password:''}),o.on('error',t),o.on('response',function(e){var n='';e.on('data',function(e){n+=e}),e.on('end',function(){t(null,e,n)}),e.resume()}),o.end(new Buffer(JSON.stringify(e),'utf8'))},l.prototype.log=function(e,t,n,r){var o=this;'function'==typeof n&&(r=n,n={});var a={method:'collect',params:{level:e,message:t,meta:n}};n&&(n.path&&(a.path=n.path,delete n.path),n.auth&&(a.auth=n.auth,delete n.auth)),this._request(a,function(e,t){return t&&200!==t.statusCode&&(e=new Error('HTTP Status Code: '+t.statusCode)),e?r(e):void(o.emit('logged'),r&&r(null,!0))})},l.prototype.query=function(e,t){'function'==typeof e&&(t=e,e={});var n=this,e=this.normalizeQuery(e);e={method:'query',params:e},e.params.path&&(e.path=e.params.path,delete e.params.path),e.params.auth&&(e.auth=e.params.auth,delete e.params.auth),this._request(e,function(e,n,r){if(n&&200!==n.statusCode&&(e=new Error('HTTP Status Code: '+n.statusCode)),e)return t(e);if('string'==typeof r)try{r=JSON.parse(r)}catch(n){return t(n)}t(null,r)})},l.prototype.stream=function(e){e=e||{};var t=this,n=new i,r,o;return n.destroy=function(){r.destroy()},e={method:'stream',params:e},e.params.path&&(e.path=e.params.path,delete e.params.path),e.params.auth&&(e.auth=e.params.auth,delete e.params.auth),r=this._request(e),o='',r.on('data',function(e){for(var e=(o+e).split(/\n+/),t=e.length-1,r=0;r<t;r++)try{n.emit('log',JSON.parse(e[r]))}catch(t){n.emit('error',t)}o=e[t]}),r.on('error',function(e){n.emit('error',e)}),n}},function(e,t,n){'use strict';var r=n(3),o=n(7),a=n(9),s=n(15).Transport,i=t.Memory=function(e){s.call(this,e),e=e||{},this.errorOutput=[],this.writeOutput=[],this.json=e.json||!1,this.colorize=e.colorize||!1,this.prettyPrint=e.prettyPrint||!1,this.timestamp='undefined'!=typeof e.timestamp&&e.timestamp,this.showLevel=!(e.showLevel!==void 0)||e.showLevel,this.label=e.label||null,this.depth=e.depth||null,this.json&&(this.stringify=e.stringify||function(e){return JSON.stringify(e,null,2)})};o.inherits(i,s),i.prototype.name='memory',i.prototype.log=function(e,t,n,r){if(this.silent)return r(null,!0);var o=this,s;s=a.log({colorize:this.colorize,json:this.json,level:e,message:t,meta:n,stringify:this.stringify,timestamp:this.timestamp,prettyPrint:this.prettyPrint,raw:this.raw,label:this.label,depth:this.depth,formatter:this.formatter,humanReadableUnhandledException:this.humanReadableUnhandledException}),'error'===e||'debug'===e?this.errorOutput.push(s):this.writeOutput.push(s),o.emit('logged'),r(null,!0)},i.prototype.clearLogs=function(){this.errorOutput=[],this.writeOutput=[]}},function(e,t){'use strict';function n(e){for(var t in e)this[t]=e[t]}t.get=function(e){var n=Error.stackTraceLimit;Error.stackTraceLimit=Infinity;var r={},o=Error.prepareStackTrace;Error.prepareStackTrace=function(e,t){return t},Error.captureStackTrace(r,e||t.get);var a=r.stack;return Error.prepareStackTrace=o,Error.stackTraceLimit=n,a},t.parse=function(e){if(!e.stack)return[];var t=this,n=e.stack.split('\n').slice(1);return n.map(function(e){if(e.match(/^\s*[-]{4,}$/))return t._createParsedCallSite({fileName:e,lineNumber:null,functionName:null,typeName:null,methodName:null,columnNumber:null,native:null});var n=e.match(/at (?:(.+)\s+\()?(?:(.+?):(\d+)(?::(\d+))?|([^)]+))\)?/);if(n){var r=null,o=null,a=null,s=null,i=null,d='native'===n[5];if(n[1]){a=n[1];var l=a.lastIndexOf('.');if('.'==a[l-1]&&l--,0<l){r=a.substr(0,l),o=a.substr(l+1);var u=r.indexOf('.Module');0<u&&(a=a.substr(u+1),r=r.substr(0,u))}s=null}o&&(s=r,i=o),'<anonymous>'===o&&(i=null,a=null);var c={fileName:n[2]||null,lineNumber:parseInt(n[3],10)||null,functionName:a,typeName:s,methodName:i,columnNumber:parseInt(n[4],10)||null,native:d};return t._createParsedCallSite(c)}}).filter(function(e){return!!e})};['this','typeName','functionName','methodName','fileName','lineNumber','columnNumber','function','evalOrigin'].forEach(function(e){n.prototype[e]=null,n.prototype['get'+e[0].toUpperCase()+e.substr(1)]=function(){return this[e]}}),['topLevel','eval','native','constructor'].forEach(function(e){n.prototype[e]=!1,n.prototype['is'+e[0].toUpperCase()+e.substr(1)]=function(){return this[e]}}),t._createParsedCallSite=function(e){return new n(e)}},function(e,t,n){'use strict';var r=n(9),o=n(10),a=n(7)._extend,s=t.Container=function(e){this.loggers={},this.options=e||{},this.default={transports:[new o.transports.Console({level:'silly',colorize:!1})]}};s.prototype.get=s.prototype.add=function(e,t){var n=this,s;return this.loggers[e]||(t=a({},t||this.options||this.default),s=t.transports||this.options.transports,t.transports=s?s.slice():[],0===t.transports.length&&(!t||!t.console)&&t.transports.push(this.default.transports[0]),Object.keys(t).forEach(function(n){if('transports'!==n&&'filters'!==n&&'rewriters'!==n){var a=r.capitalize(n);if(!o.transports[a])throw new Error('Cannot add unknown transport: '+a);var s=t[n];s.id=e,t.transports.push(new o.transports[a](s))}}),t.id=e,this.loggers[e]=new o.Logger(t),this.loggers[e].on('close',function(){n._delete(e)})),this.loggers[e]},s.prototype.has=function(e){return!!this.loggers[e]},s.prototype.close=function(e){function t(e){n.loggers[e]&&(n.loggers[e].close(),n._delete(e))}var n=this;return e?t(e):Object.keys(this.loggers).forEach(function(e){t(e)})},s.prototype._delete=function(e){delete this.loggers[e]}},function(e,t,n){'use strict';function r(e){this.logger=e,this.start=Date.now()}var o=n(3),a=n(7),s=n(29),i=n(23),d=n(9),l=n(31),u=n(11).Stream,c=/%[sdj%]/g,p=t.Logger=function(e){o.EventEmitter.call(this),this.configure(e)};a.inherits(p,o.EventEmitter),p.prototype.configure=function(e){var t=this;Array.isArray(this._names)&&this._names.length&&this.clear(),e=e||{},this.transports={},this._names=[],e.transports&&e.transports.forEach(function(e){t.add(e,null,!0)}),this.padLevels=e.padLevels||!1,this.setLevels(e.levels),e.colors&&i.addColors(e.colors),this.id=e.id||null,this.level=e.level||'info',this.emitErrs=e.emitErrs||!1,this.stripColors=e.stripColors||!1,this.exitOnError=!('undefined'!=typeof e.exitOnError)||e.exitOnError,this.exceptionHandlers={},this.profilers={},['rewriters','filters'].forEach(function(n){t[n]=Array.isArray(e[n])?e[n]:[]}),e.exceptionHandlers&&this.handleExceptions(e.exceptionHandlers)},p.prototype.log=function(e){function t(e){i?i(e):o.emitErrs&&o.emit('error',e)}function n(t){if(i){if(t)return i(t);i(null,e,m,l)}i=null,t||o.emit('logged',e,m,l)}for(var r=Array.prototype.slice.call(arguments,1),o=this;null===r[r.length-1];)r.pop();var i='function'==typeof r[r.length-1]?r.pop():null;if(0===this._names.length)return t(new Error('Cannot log with no transports.'));if('undefined'==typeof o.levels[e])return t(new Error('Unknown log level: '+e));var d=this._names.filter(function(t){var n=o.transports[t];return n.level&&o.levels[n.level]>=o.levels[e]||!n.level&&o.levels[o.level]>=o.levels[e]});if(!d.length)return void(i&&i());var l={},u=!1,p=r&&r[0]&&r[0].match&&null!==r[0].match(c),f=p?r[0].match(c):[],_=f.filter(function(e){return'%%'===e}),m;if(0<r.length-1-(f.length-_.length)||1===r.length){l=r[r.length-1]||r;var g=Object.prototype.toString.call(l);u='[object Object]'===g||'[object Error]'===g||'[object Array]'===g,l=u?r.pop():{}}if(m=a.format.apply(null,r),this.padLevels&&(m=Array(this.levelLength-e.length+1).join(' ')+m),this.rewriters.forEach(function(t){l=t(e,m,l,o)}),this.filters.forEach(function(t){var n=t(e,m,l,o);'string'==typeof n?m=n:(m=n.msg,l=n.meta)}),this.stripColors){var h=/\u001b\[(\d+(;\d+)*)?m/g;m=(''+m).replace(h,'')}return s.forEach(d,function(t,r){var a=o.transports[t];a.log(e,m,l,function(t){return t?(t.transport=a,n(t),r()):void(o.emit('logging',a,e,m,l),r())})},n),this},p.prototype.query=function(e,t){function n(t,n){e.query&&(e.query=t.formatQuery(a)),t.query(e,function(r,o){return r?n(r):void n(null,t.formatResults(o,e.format))})}'function'==typeof e&&(t=e,e={});var r=this,e=e||{},o={},a=d.clone(e.query)||{},i;return e.transport?(e.transport=e.transport.toLowerCase(),n(this.transports[e.transport],t)):void(i=this._names.map(function(e){return r.transports[e]}).filter(function(e){return!!e.query}),s.forEach(i,function(e,t){n(e,function(n,r){t&&(r=n||r,r&&(o[e.name]=r),t()),t=null})},function(){t(null,o)}))},p.prototype.stream=function(e){var t=this,e=e||{},n=new u,r=[],o;if(e.transport){var a=this.transports[e.transport];if(delete e.transport,a&&a.stream)return a.stream(e)}return n._streams=r,n.destroy=function(){for(var e=r.length;e--;)r[e].destroy()},o=this._names.map(function(e){return t.transports[e]}).filter(function(e){return!!e.stream}),o.forEach(function(t){var o=t.stream(e);o&&(r.push(o),o.on('log',function(e){e.transport=e.transport||[],e.transport.push(t.name),n.emit('log',e)}),o.on('error',function(e){e.transport=e.transport||[],e.transport.push(t.name),n.emit('error',e)}))}),n},p.prototype.close=function(){var e=this;this._names.forEach(function(t){var n=e.transports[t];n&&n.close&&n.close()}),this.emit('close')},p.prototype.handleExceptions=function(){var e=Array.prototype.slice.call(arguments),t=[],n=this;e.forEach(function(e){Array.isArray(e)?t=t.concat(e):t.push(e)}),this.exceptionHandlers=this.exceptionHandlers||{},t.forEach(function(e){n.exceptionHandlers[e.name]=e}),this._hnames=Object.keys(n.exceptionHandlers),this.catchExceptions||(this.catchExceptions=this._uncaughtException.bind(this),process.on('uncaughtException',this.catchExceptions))},p.prototype.unhandleExceptions=function(){var e=this;this.catchExceptions&&(Object.keys(this.exceptionHandlers).forEach(function(t){var n=e.exceptionHandlers[t];n.close&&n.close()}),this.exceptionHandlers={},Object.keys(this.transports).forEach(function(t){var n=e.transports[t];n.handleExceptions&&(n.handleExceptions=!1)}),process.removeListener('uncaughtException',this.catchExceptions),this.catchExceptions=!1)},p.prototype.add=function(e,t,n){var r=n?e:new e(t);if(!r.name&&!r.log)throw new Error('Unknown transport with no log() method');else if(this.transports[r.name])throw new Error('Transport already attached: '+r.name+', assign a different name');return this.transports[r.name]=r,this._names=Object.keys(this.transports),r._onError=this._onError.bind(this,r),n||r.on('error',r._onError),r.handleExceptions&&!this.catchExceptions&&this.handleExceptions(),this},p.prototype.clear=function(){Object.keys(this.transports).forEach(function(e){this.remove({name:e})},this)},p.prototype.remove=function(e){var t='string'==typeof e?e:e.name||e.prototype.name;if(!this.transports[t])throw new Error('Transport '+t+' not attached to this instance');var n=this.transports[t];return delete this.transports[t],this._names=Object.keys(this.transports),n.close&&n.close(),n._onError&&n.removeListener('error',n._onError),this},p.prototype.startTimer=function(){return new r(this)},p.prototype.profile=function(e){var t=Date.now(),n,r,o,a,s;return this.profilers[e]?(n=this.profilers[e],delete this.profilers[e],r=Array.prototype.slice.call(arguments),s='function'==typeof r[r.length-1]?r.pop():null,a='object'==typeof r[r.length-1]?r.pop():{},o=2===r.length?r[1]:e,a.durationMs=t-n,this.info(o,a,s)):(this.profilers[e]=t,this)},p.prototype.setLevels=function(e){return d.setLevels(this,this.levels,e)},p.prototype.cli=function(){return this.padLevels=!0,this.setLevels(i.cli.levels),i.addColors(i.cli.colors),this.transports.console&&(this.transports.console.colorize=this.transports.console.colorize||!0,this.transports.console.timestamp=this.transports.console.timestamp||!1),this},p.prototype._uncaughtException=function(e){function t(){d&&!r&&(clearTimeout(i),r=!0,process.exit(1))}var n=this,r=!1,o=l.getAllInfo(e),a=this._getExceptionHandlers(),i,d;return d='function'==typeof this.exitOnError?this.exitOnError(e):this.exitOnError,a&&0!==a.length?void(s.forEach(a,function(t,n){t.logException('uncaughtException: '+(e.message||e),o,n,e)},t),d&&(i=setTimeout(t,3e3))):t()},p.prototype._getExceptionHandlers=function(){var e=this;return this._hnames.map(function(t){return e.exceptionHandlers[t]}).concat(this._names.map(function(t){return e.transports[t].handleExceptions&&e.transports[t]})).filter(Boolean)},p.prototype._onError=function(e,t){this.emitErrs&&this.emit('error',t,e)},r.prototype.done=function(e){var t=Array.prototype.slice.call(arguments),n='function'==typeof t[t.length-1]?t.pop():null,r='object'==typeof t[t.length-1]?t.pop():{};return r.duration=Date.now()-this.start+'ms',this.logger.info(e,r,n)}},function(e){'use strict';function t(e){var t=!1;if(null!=e&&'function'!=typeof e.toString)try{t=!!(e+'')}catch(t){}return t}function n(e){return!!e&&'object'==typeof e}var r=Function.prototype,o=Object.prototype,a=r.toString,s=o.hasOwnProperty,i=a.call(Object),d=o.toString,l=function(e,t){return function(n){return e(t(n))}}(Object.getPrototypeOf,Object);e.exports=function(e){if(!n(e)||d.call(e)!='[object Object]'||t(e))return!1;var r=l(e);if(null===r)return!0;var o=s.call(r,'constructor')&&r.constructor;return'function'==typeof o&&o instanceof o&&a.call(o)==i}},function(e,t,n){'use strict';Object.defineProperty(t,'__esModule',{value:!0});var r=n(1),o=n(0);class a extends r.IPreset{static checkParams({host:e,port:t}){if(!(0,o.isValidHostname)(e))throw Error('host is invalid');if(!(0,o.isValidPort)(t))throw Error('port is invalid')}constructor({host:e,port:t}){super(),this._host=null,this._port=null,this._isTunnelReady=!1,this._isBroadCasting=!1,this._staging=Buffer.alloc(0),this._host=e,this._port=t}handleTunnel({buffer:e,next:t,broadcast:n}){return this._isTunnelReady?e:void(this._isBroadCasting?this._staging=Buffer.concat([this._staging,e]):(this._isBroadCasting=!0,n({type:r.CONNECT_TO_REMOTE,payload:{host:this._host,port:this._port,onConnected:()=>{t(Buffer.concat([e,this._staging])),this._isTunnelReady=!0,this._isBroadCasting=!1,this._staging=null}}})))}clientOut(e){return this.handleTunnel(e)}serverIn(e){return this.handleTunnel(e)}}t.default=a},function(e,t,n){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}var o=Math.max;Object.defineProperty(t,'__esModule',{value:!0});var a=n(4),s=r(a),i=n(8),d=r(i),l=n(1);const u=()=>new Date().getTime(),c=30,p=60;class f extends l.IPresetStatic{static checkParams({save_to:e,sample_interval:t=c,save_interval:n=p}){var r=Number.isSafeInteger;if('string'!=typeof e||''===e)throw Error('\'save_to\' must be a non-empty string');if('undefined'==typeof t)throw Error('\'sample_interval\' must be provided as an integer');if('number'!=typeof t)throw Error('\'sample_interval\' must be a number');if(!r(t))throw Error('\'sample_interval\' must be an integer');if(1>t)throw Error('\'sample_interval\' must be greater than 0');if('undefined'==typeof n)throw Error('\'save_interval\' must be provided as an integer');if('number'!=typeof n)throw Error('\'save_interval\' must be a number');if(!r(n))throw Error('\'save_interval\' must be an integer');if(1>n)throw Error('\'save_interval\' must be greater than 0')}constructor({save_to:e,sample_interval:t=c,save_interval:n=p}){super(),this.sampleInterval=c,this.saveInterval=p,this.saveTo='',this.sampleTimer=null,this.saveTimer=null,this.startedAt=u(),this.totalOutBytes=0,this.totalInBytes=0,this.totalOutPackets=0,this.totalInPackets=0,this.totalErrors=0,this.totalConnections=0,this.instantOutSpeed=0,this.instantInSpeed=0,this.maxOutSpeed=0,this.maxInSpeed=0,this.maxConnections=0,this.tmpOut=0,this.tmpIn=0,this.onSave=this.onSave.bind(this),this.onSample=this.onSample.bind(this),this.saveTo=d.default.resolve(process.cwd(),e),this.sampleInterval=t,this.saveInterval=n,this.sampleTimer=setInterval(this.onSample,1e3*t),this.saveTimer=setInterval(this.onSave,1e3*n),process.on('SIGINT',this.onSave)}onSave(){const e=this.startedAt,t=u(),n=t-e,r=n/1e3,o=this.totalInPackets+this.totalOutPackets,a=this.totalInBytes+this.totalOutBytes,i={sample:{from:e,to:t,duration:n},summary:{maxOutSpeed:this.maxOutSpeed,maxInSpeed:this.maxInSpeed,maxConnections:this.maxConnections,totalOutBytes:this.totalOutBytes,totalOutPackets:this.totalOutPackets,totalInBytes:this.totalInBytes,totalInPackets:this.totalInPackets,totalBytes:a,totalPackets:o,totalErrors:this.totalErrors},instant:{outSpeed:this.instantOutSpeed,inSpeed:this.instantInSpeed,totalConnections:this.totalConnections,errorRate:0<o.length?this.totalErrors/o:0,outBytesPerSecond:this.totalOutBytes/r,outPacketsPerSecond:this.totalOutPackets/r,inBytesPerSecond:this.totalInBytes/r,inPacketsPerSecond:this.totalInPackets/r,totalBytesPerSecond:a/r,totalPacketsPerSecond:o/r},process:{upTime:process.uptime(),cpuUsage:process.cpuUsage(),memoryUsage:process.memoryUsage()}};s.default.writeFileSync(this.saveTo,JSON.stringify(i,null,'  '))}onSample(){this.instantOutSpeed=this.tmpOut/this.sampleInterval,this.instantInSpeed=this.tmpIn/this.sampleInterval,this.maxOutSpeed=o(this.maxOutSpeed,this.instantOutSpeed),this.maxInSpeed=o(this.maxInSpeed,this.instantInSpeed),this.tmpOut=0,this.tmpIn=0}onNotified(e){e.type===l.PRESET_FAILED&&(this.totalErrors+=1),e.type===l.CONNECTION_CREATED&&(this.totalConnections+=1,this.maxConnections=o(this.maxConnections,this.totalConnections)),e.type===l.CONNECTION_CLOSED&&(this.totalConnections-=1)}onDestroy(){clearInterval(this.sampleTimer),clearInterval(this.saveTimer)}beforeOut({buffer:e}){return this.totalOutBytes+=e.length,this.totalOutPackets+=1,this.tmpOut+=e.length,e}beforeIn({buffer:e}){return this.totalInBytes+=e.length,this.totalInPackets+=1,this.tmpIn+=e.length,e}}t.default=f},function(e,t,n){'use strict';function r(e){let t=[],n=0,r=0,o=0,l=0,u='';var c=!0,p=!1,f;try{for(var _=e[Symbol.iterator](),m;!(c=(m=_.next()).done);c=!0){const e=m.value;if(e===s||e===i){if(u===e)continue;u=e}Number.isInteger(e)&&(u===i&&(n+=1,r+=e),u===s&&(o+=1,l+=e)),t.push(e)}}catch(e){p=!0,f=e}finally{try{!c&&_.return&&_.return()}finally{if(p)throw f}}const g=20;t.length>d&&(t=t.slice(0,g).concat([' ... ']).concat(t.slice(-g)));const h=__IS_CLIENT__?`out/in = ${o}/${n}, ${l}b/${r}b`:`in/out = ${n}/${o}, ${r}b/${l}b`;a.logger.info(`[tracker] summary(${h}) abstract(${t.join(' ')})`)}Object.defineProperty(t,'__esModule',{value:!0});var o=n(1),a=n(0);const s='u',i='d',d=40;class l extends o.IPreset{constructor(...e){var t;return t=super(...e),this._tracks=[],t}onNotified({type:e,payload:t}){switch(e){case o.CONNECTION_CREATED:case o.CONNECT_TO_REMOTE:const n=t.host,a=t.port;this._tracks.push(`${n}:${a}`);break;case o.CONNECTION_CLOSED:r(this._tracks);break;default:}}onDestroy(){null!==this._tracks&&r(this._tracks),this._tracks=null}beforeOut({buffer:e}){return this._tracks.push(s),this._tracks.push(e.length),e}beforeIn({buffer:e}){return this._tracks.push(i),this._tracks.push(e.length),e}}t.default=l},function(e,t,n){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}function o(e,t){const n=this.host,r=this.port,o=n.indexOf('/');let a=!1;return a=-1===o?n===e:w.default.cidrSubnet(n).contains(e),('*'===n||a)&&('*'===r||t===r)}function a(){return`${this.host}:${this.port} ${this.isBan?1:0} ${this.upLimit} ${this.dlLimit}`}function s(e){const t=e.indexOf('/');if(0>t)return'*'===e||b.default.isIP(e)||(0,T.isValidHostname)(e)?e:null;if(7>t)return null;const n=e.split('/'),r=n[0],o=n[n.length-1];return b.default.isIP(r)?''===o||!c(+o)||0>+o||32<+o?null:e:null}function i(e){const t=/^(\d+)(b|k|kb|m|mb|g|gb)$/g,n=t.exec(e.toLowerCase());if(null!==n){var r=f(n,3);const e=r[1],t=r[2];return+e*{b:1,k:1024,kb:1024,m:1048576,mb:1048576,g:1073741824,gb:1073741824}[t]}return null}function d(e){if(300<e.length)return null;if(e=e.trim(),1>e.length)return null;if('#'===e[0])return null;var t=e.split(' ').filter((e)=>0<e.length),n=f(t,4);const r=n[0],d=n[1],l=n[2],u=n[3];let c=null,p=null,_=!1,m='-',g='-';if(0<r.indexOf(':')){const e=r.split(':'),t=e[0],n=e[e.length-1];if(c=s(t),'*'!==n){if(!(0,T.isValidPort)(+n))return null;p=+n}else p=n}else c=s(r),p='*';if(null===c)return null;if(void 0!==d){if('0'!==d&&'1'!==d)return null;_='0'!==d}return void 0!==l&&'-'!==l&&(m=i(l),!m)?null:void 0!==u&&'-'!==u&&(g=i(u),!g)?null:{host:c,port:p,isBan:_,upLimit:m,dlLimit:g,isMatch:o,toString:a}}function l(e){T.logger.verbose('[acl] (re)loading access list');const t=m.default.createReadStream(e,{encoding:'utf-8'});t.on('error',(e)=>{T.logger.warn(`[acl] fail to reload acl: ${e.message}, keep using previous rules`)});const n=E.default.createInterface({input:t}),r=[];n.on('line',(e)=>{const t=d(e);null!==t&&r.push(t)}),n.on('close',()=>{P=r.reverse(),O={},T.logger.info(`[acl] ${P.length} rules loaded`)})}function u(e,t){const n=`${e}:${t}`,r=O[n];if(r!==void 0)return r;var o=!0,a=!1,s;try{for(var i=P[Symbol.iterator](),d;!(o=(d=i.next()).done);o=!0){const r=d.value;if(r.isMatch(e,t))return O[n]=r}}catch(e){a=!0,s=e}finally{try{!o&&i.return&&i.return()}finally{if(a)throw s}}return O[n]=null}var c=Number.isInteger,p=Math.ceil;Object.defineProperty(t,'__esModule',{value:!0});var f=function(){function e(e,t){var n=[],r=!0,o=!1,a;try{for(var s=e[Symbol.iterator](),i;!(r=(i=s.next()).done)&&(n.push(i.value),!(t&&n.length===t));r=!0);}catch(e){o=!0,a=e}finally{try{!r&&s['return']&&s['return']()}finally{if(o)throw a}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError('Invalid attempt to destructure non-iterable instance')}}(),_=n(4),m=r(_),g=n(6),h=r(g),y=n(5),b=r(y),v=n(8),k=r(v),x=n(34),E=r(x),S=n(17),w=r(S),C=n(1),T=n(0);let P=[],O={};const B=60,I={};class R extends C.IPreset{static checkParams({acl:e,max_tries:t=B}){if('string'!=typeof e||''===e)throw Error('\'acl\' must be a non-empty string');const n=k.default.resolve(process.cwd(),e);if(!m.default.existsSync(n))throw Error(`"${n}" not found`);if(void 0!==t){if('number'!=typeof t||!c(t))throw Error('\'max_tries\' must be an integer');if(1>t)throw Error('\'max_tries\' must be greater than 0')}}static onInit({acl:e}){const t=k.default.resolve(process.cwd(),e);l(t),m.default.watchFile(t,(e,n)=>{e.mtime>n.mtime&&l(t)})}constructor({acl:e,max_tries:t=B}){super(),this._aclPath='',this._maxTries=0,this._hrTimeBegin=process.hrtime(),this._remoteHost=null,this._remotePort=null,this._dstHost=null,this._dstPort=null,this._totalOut=0,this._totalIn=0,this._isBlocking=!1,this._isDlPaused=!1,this._isUpPaused=!1,this._aclPath=k.default.resolve(process.cwd(),e),this._maxTries=t}applyRule(e){const t=e.host,n=e.port,r=e.isBan,o=e.upLimit,a=e.dlLimit;if(T.logger.debug(`[acl] [${this._remoteHost}:${this._remotePort}] apply rule: "${e}"`),r&&(T.logger.info(`[acl] [${t}:${n}] baned by rule: "${e}"`),this.broadcast({type:C.PRESET_CLOSE_CONNECTION}),this._isBlocking=!0),'-'!==o){var s=process.hrtime(this._hrTimeBegin),i=f(s,2);const e=i[0],t=i[1],n=p(this._totalIn/(e+t/1e9));if(T.logger.debug(`[acl] upload speed: ${n}b/s`),n>o&&!this._isUpPaused){this._isUpPaused=!0,this.broadcast({type:C.PRESET_PAUSE_RECV});const e=1.1*(n/o),t=`[${this._remoteHost}:${this._remotePort}] -> [${this._dstHost}:${this._dstPort}]`;T.logger.info(`[acl] ${t} upload speed exceed: ${n}b/s > ${o}b/s, pause for ${e}s...`),setTimeout(()=>{this.broadcast({type:C.PRESET_RESUME_RECV}),this._isUpPaused=!1},1e3*e)}}if('-'!==a){var d=process.hrtime(this._hrTimeBegin),l=f(d,2);const e=l[0],t=l[1],n=p(this._totalOut/(e+t/1e9));if(T.logger.debug(`[acl] download speed: ${n}b/s`),n>a&&!this._isDlPaused){this._isDlPaused=!0,this.broadcast({type:C.PRESET_PAUSE_SEND});const e=1.1*(n/a),t=`[${this._remoteHost}:${this._remotePort}] <- [${this._dstHost}:${this._dstPort}]`;T.logger.info(`[acl] ${t} download speed exceed: ${n}b/s > ${a}b/s, pause for ${e}s...`),setTimeout(()=>{this.broadcast({type:C.PRESET_RESUME_SEND}),this._isDlPaused=!1},1e3*e)}}}checkRule(e,t){const n=u(e,t);null!==n&&this.applyRule(n)}appendToAcl(e){T.logger.info(`[acl] append rule: "${e}" to acl`),m.default.appendFile(this._aclPath,`${h.default.EOL}${e}`,(t)=>{t&&T.logger.warn(`[acl] fail to update acl: ${t.message}`),P.push(d(e))})}onNotified({type:e,payload:t}){switch(e){case C.CONNECTION_CREATED:{const e=t.host,n=t.port;this._remoteHost=e,this._remotePort=n,this.checkRule(e,n);break}case C.CONNECT_TO_REMOTE:{const e=t.host,n=t.port;this._dstHost=e,this._dstPort=n,this.checkRule(e,n);break}case C.PRESET_FAILED:{const e=this._remoteHost,t=this._maxTries;return void 0===I[e]&&(I[e]=0),void(++I[e]>=t&&(T.logger.warn(`[acl] ${e} max tries(${t}) exceed`),this.broadcast({type:C.PRESET_CLOSE_CONNECTION}),this._isBlocking=!0,null===u(e,'*')&&this.appendToAcl(`${e}:* 1`)))}}}beforeOut({buffer:e}){if(this._totalOut+=e.length,!this._isBlocking)return this.checkRule(this._remoteHost,this._remotePort),this.checkRule(this._dstHost,this._dstPort),e}beforeIn({buffer:e}){if(this._totalIn+=e.length,!this._isBlocking)return this.checkRule(this._remoteHost,this._remotePort),this.checkRule(this._dstHost,this._dstPort),e}}t.default=R},function(e,t,n){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}function o(e){return s.default.isIPv4(e)?c:s.default.isIPv6(e)?p:f}Object.defineProperty(t,'__esModule',{value:!0});var a=n(5),s=r(a),i=n(17),d=r(i),l=n(0),u=n(1);const c=1,p=4,f=3;class _ extends u.IPreset{constructor(...e){var t;return t=super(...e),this._isHandshakeDone=!1,this._isBroadCasting=!1,this._staging=Buffer.alloc(0),this._atyp=c,this._host=null,this._port=null,t}onDestroy(){this._staging=null,this._host=null,this._port=null}onNotified(e){if(__IS_CLIENT__&&e.type===u.CONNECT_TO_REMOTE){var t=e.payload;const n=t.host,r=t.port,a=o(n);this._atyp=a,this._port=(0,l.numberToBuffer)(r),this._host=a===f?Buffer.from(n):d.default.toBuffer(n)}}clientOut({buffer:e}){return this._isHandshakeDone?e:(this._isHandshakeDone=!0,Buffer.from([this._atyp,...(this._atyp===f?(0,l.numberToBuffer)(this._host.length,1):[]),...this._host,...this._port,...e]))}serverIn({buffer:e,next:t,broadcast:n,fail:r}){if(!this._isHandshakeDone){if(this._isBroadCasting)return void(this._staging=Buffer.concat([this._staging,e]));if(7>e.length)return void r(`invalid length: ${e.length}`);const o=e[0];let a=3,s,i;switch(o){case c:s=d.default.toString(e.slice(1,5)),i=e.slice(5,7).readUInt16BE(0),a+=4;break;case p:if(19>e.length)return void r(`invalid length: ${e.length}`);s=d.default.toString(e.slice(1,17)),i=e.slice(17,19).readUInt16BE(0),a+=16;break;case f:const t=e[1];if(e.length<t+4)return void r(`invalid length: ${e.length}`);if(s=e.slice(2,2+t).toString(),!(0,l.isValidHostname)(s))return void r(`addr=${s} is an invalid hostname`);i=e.slice(2+t,4+t).readUInt16BE(0),a+=t+1;break;default:return void r(`invalid atyp: ${o}`);}const _=e.slice(a);this._isBroadCasting=!0,n({type:u.CONNECT_TO_REMOTE,payload:{host:s,port:i,onConnected:()=>{t(Buffer.concat([_,this._staging])),this._isHandshakeDone=!0,this._isBroadCasting=!1,this._staging=null}}})}else return e}}t.default=_},function(e,t,n){'use strict';Object.defineProperty(t,'__esModule',{value:!0});var r=n(2),o=function(e){return e&&e.__esModule?e:{default:e}}(r),a=n(0),s=n(1);const i=16,d=['aes-128-ctr','aes-192-ctr','aes-256-ctr','aes-128-cfb','aes-192-cfb','aes-256-cfb','camellia-128-cfb','camellia-192-cfb','camellia-256-cfb'];class l extends s.IPreset{constructor(...e){var t;return t=super(...e),this._cipher=null,this._decipher=null,t}static checkParams({method:e}){if('string'!=typeof e||''===e)throw Error('\'method\' must be set');if(!d.includes(e))throw Error(`'method' must be one of [${d}]`)}static onInit({method:e}){l.cipherName=e,l.key=(0,a.EVP_BytesToKey)(__KEY__,e.split('-')[1]/8,i)}onDestroy(){this._cipher=null,this._decipher=null}beforeOut({buffer:e}){if(!this._cipher){const t=o.default.randomBytes(i);return this._cipher=o.default.createCipheriv(l.cipherName,l.key,t),Buffer.concat([t,this.encrypt(e)])}return this.encrypt(e)}beforeIn({buffer:e,fail:t}){if(!this._decipher){if(e.length<i)return t(`buffer is too short ${e.length} bytes to get iv, dump=${e.toString('hex')}`);const n=e.slice(0,i);return this._decipher=o.default.createDecipheriv(l.cipherName,l.key,n),this.decrypt(e.slice(i))}return this.decrypt(e)}encrypt(e){return this._cipher.update(e)}decrypt(e){return this._decipher.update(e)}}t.default=l,l.cipherName='',l.key=null},function(e,t,n){'use strict';Object.defineProperty(t,'__esModule',{value:!0});var r=function(){function e(e,t){var n=[],r=!0,o=!1,a;try{for(var s=e[Symbol.iterator](),i;!(r=(i=s.next()).done)&&(n.push(i.value),!(t&&n.length===t));r=!0);}catch(e){o=!0,a=e}finally{try{!r&&s['return']&&s['return']()}finally{if(o)throw a}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError('Invalid attempt to destructure non-iterable instance')}}(),o=n(2),a=function(e){return e&&e.__esModule?e:{default:e}}(o),s=n(0),i=n(1);const d=12,l=16,u=16383,c={"aes-128-gcm":16,"aes-192-gcm":24,"aes-256-gcm":32},p='sha1';class f extends i.IPreset{static checkParams({method:e}){const t=Object.keys(c);if(!t.includes(e))throw Error(`'method' must be one of [${t}]`)}static onInit({method:e}){f.cipherName=e,f.keySaltSize=c[e],f.evpKey=(0,s.EVP_BytesToKey)(__KEY__,f.keySaltSize,16)}constructor(){super(),this._cipherKey=null,this._decipherKey=null,this._cipherNonce=0,this._decipherNonce=0,this._adBuf=null,this._adBuf=new s.AdvancedBuffer({getPacketLength:this.onReceiving.bind(this)}),this._adBuf.on('data',this.onChunkReceived.bind(this))}onDestroy(){this._adBuf.clear(),this._adBuf=null,this._cipherKey=null,this._decipherKey=null,this._cipherNonce=0,this._decipherNonce=0}beforeOut({buffer:e}){let t=null;if(null===this._cipherKey){const e=f.keySaltSize;t=a.default.randomBytes(e),this._cipherKey=(0,s.HKDF)(p,t,f.evpKey,f.info,e)}const n=(0,s.getRandomChunks)(e,2048,u).map((e)=>{const t=(0,s.numberToBuffer)(e.length);var n=this.encrypt(t),o=r(n,2);const a=o[0],i=o[1];var d=this.encrypt(e),l=r(d,2);const u=l[0],c=l[1];return Buffer.concat([a,i,u,c])});return t?Buffer.concat([t,...n]):Buffer.concat(n)}beforeIn({buffer:e,next:t,fail:n}){this._adBuf.put(e,{next:t,fail:n})}onReceiving(e,{fail:t}){if(null===this._decipherKey){const t=f.keySaltSize;if(e.length<t)return;const n=e.slice(0,t);return this._decipherKey=(0,s.HKDF)(p,n,f.evpKey,f.info,t),e.slice(t)}if(!(e.length<2*l+3)){var n=[e.slice(0,2),e.slice(2,2+l)];const r=n[0],o=n[1],a=this.decrypt(r,o);if(null===a)return t(`unexpected DataLen_TAG=${o.toString('hex')} when verify DataLen=${r.toString('hex')}, dump=${e.slice(0,60).toString('hex')}`),-1;const s=a.readUInt16BE(0);return s>u?(t(`invalid DataLen=${s} is over ${u}, dump=${e.slice(0,60).toString('hex')}`),-1):2+l+s+l}}onChunkReceived(e,{next:t,fail:n}){var r=[e.slice(2+l,-l),e.slice(-l)];const o=r[0],a=r[1],s=this.decrypt(o,a);return null===s?void n(`unexpected Data_TAG=${a.toString('hex')} when verify Data=${o.slice(0,60).toString('hex')}, dump=${e.slice(0,60).toString('hex')}`):void t(s)}encrypt(e){const t=a.default.createCipheriv(f.cipherName,this._cipherKey,(0,s.numberToBuffer)(this._cipherNonce,d,s.BYTE_ORDER_LE)),n=Buffer.concat([t.update(e),t.final()]),r=t.getAuthTag();return this._cipherNonce+=1,[n,r]}decrypt(e,t){const n=a.default.createDecipheriv(f.cipherName,this._decipherKey,(0,s.numberToBuffer)(this._decipherNonce,d,s.BYTE_ORDER_LE));n.setAuthTag(t);try{const t=Buffer.concat([n.update(e),n.final()]);return this._decipherNonce+=1,t}catch(e){return null}}}t.default=f,f.cipherName='',f.info=Buffer.from('ss-subkey'),f.keySaltSize=0,f.evpKey=null},function(e,t,n){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}function o(e){return s.default.isIPv4(e)?m:s.default.isIPv6(e)?h:g}Object.defineProperty(t,'__esModule',{value:!0});var a=n(5),s=r(a),i=n(2),d=r(i),l=n(17),u=r(l),c=n(18),p=n(1),_=n(0);const m=1,g=2,h=3,f=30,y=3,b={"aes-128-gcm":y,none:5};class v extends p.IPreset{static checkParams({id:e,security:t='aes-128-gcm'}){if(16!==Buffer.from(e.split('-').join(''),'hex').length)throw Error('id is not a valid uuid');const n=Object.keys(b);if(!n.includes(t))throw Error(`security must be one of ${n}`)}static onInit({id:e,security:t='aes-128-gcm'}){v.uuid=Buffer.from(e.split('-').join(''),'hex'),__IS_CLIENT__&&(v.security=b[t]),setInterval(()=>v.updateAuthCache(),1e3),v.updateAuthCache()}static updateAuthCache(){const e=this.userHashCache,t=(0,_.getCurrentTimestampInt)();let n=t-f;let r=[];if(0!==e.length){const o=e[e.length-1].timestamp;r=e.slice(t-o-f-1),n=o+1}for(let e=n;e<=t+f;++e){const t=this.uuid,n=(0,_.hmac)('md5',t,(0,_.numberToBuffer)(e,8));r.push({timestamp:e,authInfo:n})}this.userHashCache=r}constructor(){super(),this._atyp=null,this._host=null,this._port=null,this._isBroadCasting=!1,this._staging=Buffer.alloc(0),this._isHeaderSent=!1,this._isHeaderRecv=!1,this._v=null,this._opt=5,this._dataEncKey=null,this._dataEncIV=null,this._dataDecKey=null,this._dataDecIV=null,this._chunkLenEncMaskGenerator=null,this._chunkLenDecMaskGenerator=null,this._cipherNonce=0,this._decipherNonce=0,this._adBuf=new _.AdvancedBuffer({getPacketLength:this.onReceiving.bind(this)}),this._adBuf.on('data',this.onChunkReceived.bind(this))}onDestroy(){this._adBuf.clear(),this._adBuf=null,this._host=null,this._port=null,this._dataEncKey=null,this._dataEncIV=null,this._dataDecKey=null,this._dataDecIV=null,this._chunkLenEncMaskGenerator=null,this._chunkLenDecMaskGenerator=null}onNotified(e){if(__IS_CLIENT__&&e.type===p.CONNECT_TO_REMOTE){var t=e.payload;const n=t.host,r=t.port,a=o(n);this._atyp=a,this._port=(0,_.numberToBuffer)(r),this._host=a===g?Buffer.from(n):u.default.toBuffer(n)}e.type===p.CONNECTION_WILL_CLOSE&&this.next(c.MIDDLEWARE_DIRECTION_UPWARD,Buffer.alloc(2))}beforeOut({buffer:e}){if(!this._isHeaderSent){this._isHeaderSent=!0;const t=__IS_CLIENT__?this.createRequestHeader():this.createResponseHeader(),n=this.getBufferChunks(e);return Buffer.concat([t,...n])}else{const t=this.getBufferChunks(e);return Buffer.concat(t)}}clientIn({buffer:e,next:t,fail:n}){if(!this._isHeaderRecv){this._isHeaderRecv=!0;const r=d.default.createDecipheriv('aes-128-cfb',this._dataDecKey,this._dataDecIV),o=r.update(e.slice(0,4)),a=o[0],s=o[3];return this._v===a?this._adBuf.put(e.slice(4+s),{next:t,fail:n}):n(`server response v doesn't match, expect ${this._v} but got ${a}`)}this._adBuf.put(e,{next:t,fail:n})}serverIn({buffer:e,next:t,fail:n}){if(!this._isHeaderRecv){if(this._isBroadCasting)return void(this._staging=Buffer.concat([this._staging,e]));if(16>e.length)return n(`fail to parse request header: ${e.toString('hex')}`);const r=v.uuid,o=v.userHashCache,a=e.slice(0,16),s=o.find(({authInfo:e})=>e.equals(a));if(s===void 0)return n(`cannot find ${a.toString('hex')} in cache, maybe a wrong auth info`);const i=(0,_.numberToBuffer)(s.timestamp,8),l=d.default.createDecipheriv('aes-128-cfb',(0,_.hash)('md5',Buffer.concat([r,Buffer.from('c48619fe-8f02-49e0-b9e9-edf763e17e21')])),(0,_.hash)('md5',Buffer.concat([i,i,i,i]))),c=Buffer.from(e.slice(16));if(41>c.length)return n(`request command is too short: ${c.length}bytes, command=${c.toString('hex')}`);const y=l.update(c.slice(0,41)),b=y[0];if(1!==b)return n(`invalid version number: ${b}`);this._dataDecIV=y.slice(1,17),this._dataDecKey=y.slice(17,33),this._dataEncIV=(0,_.hash)('md5',this._dataDecIV),this._dataEncKey=(0,_.hash)('md5',this._dataDecKey),this._chunkLenDecMaskGenerator=(0,_.shake128)(this._dataDecIV),this._chunkLenEncMaskGenerator=(0,_.shake128)(this._dataEncIV),this._v=y[33],this._opt=y[34];const k=y[35]>>4,x=15&y[35],E=y[37];if(![1].includes(E))return n(`unsupported cmd: ${E}`);const S=y.readUInt16BE(38),w=y[40];let C=null,T=40;if(w===m){if(45>c.length)return n(`request command is too short ${c.length}bytes to get ipv4, command=${c.toString('hex')}`);C=l.update(c.slice(41,45)),T+=4}else if(w===h){if(57>c.length)return n(`request command is too short: ${c.length}bytes to get ipv6, command=${c.toString('hex')}`);C=l.update(c.slice(41,57)),T+=16}else if(w===g){if(42>c.length)return n(`request command is too short: ${c.length}bytes to get host name, command=${c.toString('hex')}`);const e=l.update(c.slice(41,42))[0];if(c.length<42+e)return n(`request command is too short: ${c.length}bytes, command=${c.toString('hex')}`);C=l.update(c.slice(42,42+e)),T+=1+e}else return n(`unknown address type: ${w}, command=${y.toString('hex')}`);if(c.length<T+k+4)return n(`request command is too short: ${c.length}bytes to get padding and f, command=${c.toString('hex')}`);const P=l.update(c.slice(T,T+k));T+=k;const O=l.update(c.slice(T,T+4)),f=Buffer.from([...y.slice(0,41),...(w===g?[C.length]:[]),...C,...P]);if((0,_.fnv1a)(f).equals(O))return n('fail to verify request command');const B=e.slice(16+f.length+4);v.security=x,this._isBroadCasting=!0,this.broadcast({type:p.CONNECT_TO_REMOTE,payload:{host:w===g?C.toString():u.default.toString(C),port:S,onConnected:()=>{this._adBuf.put(Buffer.concat([B,this._staging]),{next:t,fail:n}),this._isHeaderRecv=!0,this._isBroadCasting=!1,this._staging=null}}})}else this._adBuf.put(e,{next:t,fail:n})}createRequestHeader(){const e=d.default.randomBytes(33);this._dataEncIV=e.slice(0,16),this._dataEncKey=e.slice(16,32),this._dataDecKey=(0,_.hash)('md5',this._dataEncKey),this._dataDecIV=(0,_.hash)('md5',this._dataEncIV),this._chunkLenEncMaskGenerator=(0,_.shake128)(this._dataEncIV),this._chunkLenDecMaskGenerator=(0,_.shake128)(this._dataDecIV),this._v=e[32],this._opt=5;const t=v.userHashCache,n=v.uuid;var r=t[(0,_.getRandomInt)(0,t.length-1)];const o=r.timestamp,a=r.authInfo,s=(0,_.numberToBuffer)(o,8),i=(0,_.getRandomInt)(0,15),l=d.default.randomBytes(i);let u=Buffer.from([1,...this._dataEncIV,...this._dataEncKey,this._v,this._opt,i<<4|v.security,0,1,...this._port,this._atyp,...Buffer.concat([this._atyp===g?(0,_.numberToBuffer)(this._host.length,1):Buffer.alloc(0),this._host]),...l]);u=Buffer.concat([u,(0,_.fnv1a)(u)]);const c=d.default.createCipheriv('aes-128-cfb',(0,_.hash)('md5',Buffer.concat([n,Buffer.from('c48619fe-8f02-49e0-b9e9-edf763e17e21')])),(0,_.hash)('md5',Buffer.concat([s,s,s,s])));return u=c.update(u),Buffer.concat([a,u])}createResponseHeader(){const e=d.default.createCipheriv('aes-128-cfb',this._dataEncKey,this._dataEncIV);return e.update(Buffer.from([this._v,1,0,0]))}getBufferChunks(e){return(0,_.getChunks)(e,16383).map((e)=>{let t=e;v.security===y&&(t=Buffer.concat(this.encrypt(t)));let n=t.length;if(5===this._opt){const e=this._chunkLenEncMaskGenerator.nextBytes(2).readUInt16BE(0);n=e^n}return Buffer.concat([(0,_.numberToBuffer)(n),t])})}onReceiving(e){if(2>e.length)return;let t=e.readUInt16BE(0);if(5===this._opt){const e=this._chunkLenDecMaskGenerator.nextBytes(2).readUInt16BE(0);t=e^t}return 2+t}onChunkReceived(e,{next:t,fail:n}){if(v.security===y){const r=e.slice(-16),o=this.decrypt(e.slice(2,-16),r);return null===o?n(`fail to verify data chunk, dump=${e.slice(0,60).toString('hex')}`):t(o)}return t(e.slice(2))}encrypt(e){const t=Buffer.concat([(0,_.numberToBuffer)(this._cipherNonce),this._dataEncIV.slice(2,12)]),n=d.default.createCipheriv('aes-128-gcm',this._dataEncKey,t),r=Buffer.concat([n.update(e),n.final()]),o=n.getAuthTag();return this._cipherNonce+=1,[r,o]}decrypt(e,t){const n=Buffer.concat([(0,_.numberToBuffer)(this._decipherNonce),this._dataDecIV.slice(2,12)]),r=d.default.createDecipheriv('aes-128-gcm',this._dataDecKey,n);r.setAuthTag(t);try{const t=Buffer.concat([r.update(e),r.final()]);return this._decipherNonce+=1,t}catch(e){return null}}}t.default=v,v.uuid=null,v.security=null,v.userHashCache=[]},function(e,t,n){'use strict';Object.defineProperty(t,'__esModule',{value:!0});var r=n(2),o=function(e){return e&&e.__esModule?e:{default:e}}(r),a=n(1),s=n(0);class i extends a.IPreset{constructor(){super(),this._adBuf=null,this._adBuf=new s.AdvancedBuffer({getPacketLength:this.onReceiving.bind(this)}),this._adBuf.on('data',this.onChunkReceived.bind(this))}onDestroy(){this._adBuf.clear(),this._adBuf=null}beforeOut({buffer:e}){const t=(0,s.getRandomChunks)(e,0,65535).map((e)=>{const t=(0,s.getRandomInt)(0,255),n=o.default.randomBytes(t);return Buffer.concat([(0,s.numberToBuffer)(t,1),n,(0,s.numberToBuffer)(e.length),e])});return Buffer.concat(t)}beforeIn({buffer:e,next:t}){this._adBuf.put(e,{next:t})}onReceiving(e){if(!(3>e.length)){const t=e[0];if(!(e.length<1+t+2)){const n=e.readUInt16BE(1+t);return e.length<1+t+2+n?void 0:1+t+2+n}}}onChunkReceived(e,{next:t}){const n=e[0];t(e.slice(1+n+2))}}t.default=i},function(e,t,n){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,'__esModule',{value:!0});var o=n(4),a=r(o),s=n(34),i=r(s),d=n(2),l=r(d),u=n(1);class c{static _parse(e,t){if(0<this._fakes.length)return void t(this._fakes);const n=[];let r='';const o=i.default.createInterface({input:a.default.createReadStream(e)});o.on('line',function(e){switch(e[0]){case'=':case'-':''!=r&&(r+='\r\n',n.push(r),r='');break;default:r+=e,r+='\r\n';}}),o.on('close',()=>{for(let e=0;e<n.length;e+=2){const t=n[e],r=n[e+1];this._fakes.push({request:Buffer.from(t),response:Buffer.from(r)})}t(this._fakes)})}static get(e,t){this._parse(e,t)}}c._fakes=[];class p extends u.IPreset{static checkParams({file:e}){if('string'!=typeof e||''===e)throw Error('\'file\' must be a non-empty string')}constructor({file:e}){super(),this._isHandshakeDone=!1,this._file=null,this._response=null,this._file=e}clientOut({buffer:e,next:t}){return this._isHandshakeDone?e:void c.get(this._file,(n)=>{const r=l.default.randomBytes(1)[0]%n.length,o=n[r].request;t(Buffer.concat([o,e]))})}serverIn({buffer:e,next:t,fail:n}){return this._isHandshakeDone?e:void c.get(this._file,(r)=>{const o=r.find(({request:t})=>0===e.indexOf(t));'undefined'==typeof o?n('http header mismatch'):(this._response=o.response,t(e.slice(o.request.length)))})}serverOut({buffer:e}){return this._isHandshakeDone?e:(this._isHandshakeDone=!0,Buffer.concat([this._response,e]))}clientIn({buffer:e,next:t,fail:n}){return this._isHandshakeDone?e:void(c.get(this._file,(r)=>{const o=r.find(({response:t})=>0===e.indexOf(t));'undefined'==typeof o?n('http header mismatch'):t(e.slice(o.response.length))}),this._isHandshakeDone=!0)}}t.default=p},function(e,t,n){'use strict';function r(e){return Buffer.from(e,'hex')}function o(){return(0,d.numberToBuffer)((0,d.getCurrentTimestampInt)(),4)}function a(e){const t=(0,d.numberToBuffer)(e.length);return Buffer.concat([r('170303'),t,e])}Object.defineProperty(t,'__esModule',{value:!0});var s=n(2),i=function(e){return e&&e.__esModule?e:{default:e}}(s),d=n(0),l=n(1);const u=1,c=2,p=3,f=2048,_=16383;class m extends l.IPreset{static checkParams({sni:e}){if('undefined'==typeof e)throw Error('\'sni\' must be set');if(Array.isArray(e)||(e=[e]),e.some((e)=>'string'!=typeof e||1>e.length))throw Error('\'sni\' must be a non-empty string or an array without empty strings')}constructor({sni:e}){super(),this._sni=[],this._stage=u,this._staging=Buffer.alloc(0),this._adBuf=null,this.onReceiving=this.onReceiving.bind(this),this.onChunkReceived=this.onChunkReceived.bind(this),this._sni=Array.isArray(e)?e:[e],this._adBuf=new d.AdvancedBuffer({getPacketLength:this.onReceiving}),this._adBuf.on('data',this.onChunkReceived)}onDestroy(){this._adBuf.clear(),this._adBuf=null,this._staging=null,this._sni=null}getRandomSNI(){const e=i.default.randomBytes(1)[0]%this._sni.length;return Buffer.from(this._sni[e])}clientOut({buffer:e,next:t}){if(this._stage===u){this._stage=c,this._staging=e;const n=this.getRandomSNI(),a=[...o(),...i.default.randomBytes(28)],s=[...r('20'),...i.default.randomBytes(32)],l=[...r('001a'),...r('c02b'),...r('c02f'),...r('c02c'),...r('c030'),...r('cc14'),...r('cc13'),...r('c013'),...r('c014'),...r('009c'),...r('009d'),...r('002f'),...r('0035'),...r('000a')],u=[...r('0000'),...(0,d.numberToBuffer)(5+n.length),...(0,d.numberToBuffer)(3+n.length),...r('00'),...(0,d.numberToBuffer)(n.length),...n],p=(0,d.getRandomInt)(200,400),f=[...r('0023'),...(0,d.numberToBuffer)(p),...i.default.randomBytes(p)],_=[...r('ff01000100'),...u,...r('00170000'),...f,...r('000d00140012040308040401050308050501080606010201'),...r('000500050100000000'),...r('00120000'),...r('75500000'),...r('000b00020100'),...r('000a0006000400170018')],m=[...r('0303'),...a,...s,...l,...r('01'),...r('00'),...(0,d.numberToBuffer)(_.length),..._],g=[...r('16'),...r('0301'),...(0,d.numberToBuffer)(4+m.length),...r('01'),...(0,d.numberToBuffer)(m.length,3)];return t(Buffer.from([...g,...m]))}if(this._stage===c&&(this._staging=Buffer.concat([this._staging,e])),this._stage===p){const t=(0,d.getRandomChunks)(e,f,_).map((e)=>a(e));return Buffer.concat(t)}}serverIn({buffer:e,next:t,fail:n}){if(this._stage===u){if(this._stage=c,200>e.length)return void n(`TLS handshake header is too short, length=${e.length} dump=${e.slice(0,100).toString('hex')}`);if(!e.slice(0,3).equals(r('160301')))return void n(`invalid TLS handshake header=${e.slice(0,3).toString('hex')}, want=160301, dump=${e.slice(0,100).toString('hex')}`);const a=e.slice(3,5).readUInt16BE(0);if(a!==e.length-5)return void n(`unexpected TLS handshake body length=${e.length-5}, want=${a}, dump=${e.slice(0,100).toString('hex')}`);const s=[...o(),...i.default.randomBytes(28)],l=[...r('20'),...i.default.randomBytes(32)],u=[...r('ff01000100'),...r('00050000'),...r('00170000')],p=[...r('0303'),...s,...l,...r('c02f'),...r('00'),...(0,d.numberToBuffer)(u.length),...u],f=[...r('16'),...r('0303'),...(0,d.numberToBuffer)(4+p.length),...r('02'),...(0,d.numberToBuffer)(p.length,3)],_=[...f,...p],m=i.default.randomBytes((0,d.getRandomInt)(200,255)),g=[...r('000004b0'),...(0,d.numberToBuffer)(m.length),...m],h=[...r('04'),...(0,d.numberToBuffer)(g.length,3),...g],y=[...r('160303'),...(0,d.numberToBuffer)(h.length),...h],b=[...r('140303000101')],v=(0,d.getRandomInt)(32,40),k=[...r('16'),...r('0303'),...(0,d.numberToBuffer)(v),...i.default.randomBytes(v)];return t(Buffer.from([..._,...y,...b,...k]),!0)}let a=e;this._stage===c&&(this._stage=p,a=e.slice(43)),this._adBuf.put(a,{next:t,fail:n})}serverOut({buffer:e}){const t=(0,d.getRandomChunks)(e,f,_).map((e)=>a(e));return Buffer.concat(t)}clientIn({buffer:e,next:t,fail:n}){if(this._stage===c){this._stage=p;const e=[...r('140303000101')],n=[...r('16'),...r('0303'),...r('0020'),...i.default.randomBytes(32)],o=(0,d.getRandomChunks)(this._staging,f,_).map((e)=>a(e));return this._staging=null,t(Buffer.from([...e,...n,...Buffer.concat(o)]),!0)}this._adBuf.put(e,{next:t,fail:n})}onReceiving(e){return 5>e.length?void 0:5+e.readUInt16BE(3)}onChunkReceived(e,{next:t}){t(e.slice(5))}}t.default=m},function(e,t,n){'use strict';function r(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){function r(o,a){try{var s=t[o](a),i=s.value}catch(e){return void n(e)}return s.done?void e(i):Promise.resolve(i).then(function(e){r('next',e)},function(e){r('throw',e)})}return r('next')})}}function o(e){const t=/^(\d+)(b|k|kb|m|mb)$/g,n=t.exec(e.toLowerCase());if(null!==n){var r=a(n,3);const e=r[1],t=r[2];return+e*{b:1,k:1024,kb:1024,m:1048576,mb:1048576}[t]}return null}Object.defineProperty(t,'__esModule',{value:!0});var a=function(){function e(e,t){var n=[],r=!0,o=!1,a;try{for(var s=e[Symbol.iterator](),i;!(r=(i=s.next()).done)&&(n.push(i.value),!(t&&n.length===t));r=!0);}catch(e){o=!0,a=e}finally{try{!r&&s['return']&&s['return']()}finally{if(o)throw a}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError('Invalid attempt to destructure non-iterable instance')}}(),s=n(19),i=function(e){return e&&e.__esModule?e:{default:e}}(s),d=n(1),l=n(0);const u={gzip:[i.default.gzipSync,i.default.gunzipSync],deflate:[i.default.deflateSync,i.default.inflateSync]},c='deflate',p='5kb',f={};class _ extends d.IPreset{static checkParams({method:e=c,threshold:t=p}){const n=Object.keys(u);if(!n.includes(e))throw Error(`'method' must be one of [${n}]`);const r=o(t);if(null===r)throw Error(`'threshold': ${t} is invalid`);1024>r&&l.logger.warn('compress chunk less than 1kb can be inefficient')}constructor({method:e=c,threshold:t=p,options:n=f}){super(),this._method='',this._threshold=0,this._options={},this._adBuf=null,this._isTransferSSL=!1,this._outBytesA=0,this._outBytesB=0,this._method=e,this._threshold=o(t),this._options=n,this._adBuf=new l.AdvancedBuffer({getPacketLength:this.onReceiving.bind(this)}),this._adBuf.on('data',this.onReceived.bind(this))}onNotified(e){switch(e.type){case d.CONNECT_TO_REMOTE:this._isTransferSSL=[22,443].includes(e.payload.port);break;case d.CONNECTION_CLOSED:l.logger.debug(`overall compression ratio: ${this._outBytesB/this._outBytesA}`);break;default:}}beforeOut({buffer:e,fail:t}){const n=(0,l.getChunks)(e,32767).map((n)=>{this._outBytesA+=n.length+2;let r=n,o=n.length;if(n.length>this._threshold&&!this._isTransferSSL)try{const t=this.compress(e);32767>t.length&&(r=t,o=32768|r.length)}catch(e){t(`cannot compress chunk: ${e.message}`)}return Buffer.concat([(0,l.numberToBuffer)(o),r])}),r=Buffer.concat(n);return this._outBytesB+=r.length,r}beforeIn({buffer:e,next:t,fail:n}){this._adBuf.put(e,{next:t,fail:n})}onReceiving(e){return 2>e.length?void 0:2+(32767&e.readUInt16BE(0))}onReceived(e,{next:t,fail:n}){var o=this;return r(function*(){const r=e.readUInt16BE(0),a=e.slice(2);if(1==r>>15)try{t(o.decompress(a))}catch(e){n(`cannot decompress chunk: ${e.message}`)}else t(a)})()}compress(e){return u[this._method][0](e,this._options)}decompress(e){return u[this._method][1](e,this._options)}}t.default=_},function(e,t,n){'use strict';Object.defineProperty(t,'__esModule',{value:!0});var r=function(){function e(e,t){var n=[],r=!0,o=!1,a;try{for(var s=e[Symbol.iterator](),i;!(r=(i=s.next()).done)&&(n.push(i.value),!(t&&n.length===t));r=!0);}catch(e){o=!0,a=e}finally{try{!r&&s['return']&&s['return']()}finally{if(o)throw a}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError('Invalid attempt to destructure non-iterable instance')}}(),o=n(2),a=function(e){return e&&e.__esModule?e:{default:e}}(o),s=n(0),i=n(1);const d=12,l=16,u=16383,c='bs-subkey',p=2,f={"aes-128-gcm":16,"aes-192-gcm":24,"aes-256-gcm":32},_='sha1';class m extends i.IPreset{static checkParams({method:e,info:t=c,factor:n=p}){if(e===void 0||''===e)throw Error('\'method\' must be set');const r=Object.keys(f);if(!r.includes(e))throw Error(`'method' must be one of [${r}]`);if('string'!=typeof t||0>=t.length)throw Error('\'info\' must be a non-empty string');if(!Number.isInteger(n))throw Error('\'factor\' must be an integer');if(1>n||10<n)throw Error('\'factor\' must be in [1, 10]')}static onInit({method:e,info:t=c,factor:n=p}){m.cipherName=e,m.info=Buffer.from(t),m.factor=n,m.rawKey=Buffer.from(__KEY__),m.keySaltSize=f[e]}constructor(){super(),this._cipherKey=null,this._decipherKey=null,this._cipherNonce=0,this._decipherNonce=0,this._nextExpectDecipherNonce=0,this._adBuf=null,this._adBuf=new s.AdvancedBuffer({getPacketLength:this.onReceiving.bind(this)}),this._adBuf.on('data',this.onChunkReceived.bind(this))}onDestroy(){this._adBuf.clear(),this._adBuf=null,this._cipherKey=null,this._decipherKey=null,this._cipherNonce=0,this._decipherNonce=0,this._nextExpectDecipherNonce=0}beforeOut({buffer:e}){let t=null;if(null===this._cipherKey){const e=m.keySaltSize;t=a.default.randomBytes(e),this._cipherKey=(0,s.HKDF)(_,t,m.rawKey,m.info,e)}const n=(0,s.getRandomChunks)(e,2048,u).map((e)=>{const t=this.getPaddingLength(this._cipherKey,this._cipherNonce),n=a.default.randomBytes(t),o=(0,s.numberToBuffer)(e.length);var i=this.encrypt(o),d=r(i,2);const l=d[0],u=d[1];var c=this.encrypt(e),p=r(c,2);const f=p[0],_=p[1];return Buffer.concat([n,l,u,f,_])});return t?Buffer.concat([t,...n]):Buffer.concat(n)}beforeIn({buffer:e,next:t,fail:n}){this._adBuf.put(e,{next:t,fail:n})}onReceiving(e,{fail:t}){if(null===this._decipherKey){const t=m.keySaltSize;if(e.length<t)return;const n=e.slice(0,t);return this._decipherKey=(0,s.HKDF)(_,n,m.rawKey,m.info,t),e.slice(t)}if(this._decipherNonce===this._nextExpectDecipherNonce){const t=this.getPaddingLength(this._decipherKey,this._decipherNonce);return e.length<t?void 0:(this._nextExpectDecipherNonce+=2,e.slice(t))}if(!(e.length<2*l+3)){var n=[e.slice(0,2),e.slice(2,2+l)];const r=n[0],o=n[1],a=this.decrypt(r,o);if(null===a)return t(`unexpected DataLen_TAG=${o.toString('hex')} when verify DataLen=${r.toString('hex')}, dump=${e.slice(0,60).toString('hex')}`),-1;const s=a.readUInt16BE(0);return s>u?(t(`invalid DataLen=${s} is over ${u}, dump=${e.slice(0,60).toString('hex')}`),-1):2+l+s+l}}onChunkReceived(e,{next:t,fail:n}){var r=[e.slice(2+l,-l),e.slice(-l)];const o=r[0],a=r[1],s=this.decrypt(o,a);return null===s?void n(`unexpected Data_TAG=${a.toString('hex')} when verify Data=${o.slice(0,60).toString('hex')}, dump=${e.slice(0,60).toString('hex')}`):void t(s)}getPaddingLength(e,t){const n=(0,s.numberToBuffer)(t,d,s.BYTE_ORDER_LE),r=a.default.createCipheriv(m.cipherName,e,n);return r.update(n),r.final(),r.getAuthTag()[0]*m.factor}encrypt(e){const t=a.default.createCipheriv(m.cipherName,this._cipherKey,(0,s.numberToBuffer)(this._cipherNonce,d,s.BYTE_ORDER_LE)),n=Buffer.concat([t.update(e),t.final()]),r=t.getAuthTag();return this._cipherNonce+=1,[n,r]}decrypt(e,t){const n=a.default.createDecipheriv(m.cipherName,this._decipherKey,(0,s.numberToBuffer)(this._decipherNonce,d,s.BYTE_ORDER_LE));n.setAuthTag(t);try{const t=Buffer.concat([n.update(e),n.final()]);return this._decipherNonce+=1,t}catch(e){return null}}}t.default=m,m.cipherName='',m.info=null,m.factor=p,m.rawKey=null,m.keySaltSize=0},function(e,t,n){'use strict';Object.defineProperty(t,'__esModule',{value:!0});var r=n(36),o=function(e){return e&&e.__esModule?e:{default:e}}(r);class a extends o.default{}t.default=a},function(e,t,n){'use strict';Object.defineProperty(t,'__esModule',{value:!0});var r=n(37),o=function(e){return e&&e.__esModule?e:{default:e}}(r);class a extends o.default{}t.default=a},function(e,t,n){'use strict';var r=n(4),o=n(8),a=n(7),s=n(9),i=n(10).Transport,d=n(11).Stream,l=n(6),u=n(10),c=n(117),p=n(19),f=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],_=e.exports=function(e){function t(t){Array.prototype.slice.call(arguments,1).forEach(function(n){if(e[n])throw new Error('Cannot set '+n+' and '+t+'together')})}if(i.call(this,e),e.filename||e.dirname)t('filename or dirname','stream'),this._basename=this.filename=e.filename?o.basename(e.filename):'winston.log',this.dirname=e.dirname||o.dirname(e.filename),this.options=e.options||{flags:'a'},this.options.highWaterMark=this.options.highWaterMark||24;else if(e.stream){t('stream','filename','maxsize'),this._stream=e.stream;var n=this;this._stream.on('error',function(e){n.emit('error',e)}),this._stream.setMaxListeners(Infinity)}else throw new Error('Cannot log to file without filename or stream.');this.json=!1!==e.json,this.colorize=e.colorize||!1,this.maxsize=e.maxsize||null,this.logstash=e.logstash||null,this.maxFiles=e.maxFiles||null,this.label=e.label||null,this.prettyPrint=e.prettyPrint||!1,this.showLevel=void 0===e.showLevel||e.showLevel,this.timestamp=void 0===e.timestamp||e.timestamp,this.datePattern=e.datePattern?e.datePattern:'.yyyy-MM-dd',this.depth=e.depth||null,this.eol=e.eol||l.EOL,this.maxRetries=e.maxRetries||2,this.prepend=e.prepend||!1,this.createTree=e.createTree||!1,this.localTime=e.localTime||!1,this.zippedArchive=e.zippedArchive||!1,this.maxDays=e.maxDays||0,this.json&&(this.stringify=e.stringify),this._size=0,this._created=0,this._buffer=[],this._draining=!1,this._failures=0,this._archive=!1,this._currentFiles=function(){if(!this.maxsize)try{return r.readdirSync(this.dirname).filter(function(e){return e.includes(this._basename)}.bind(this)).map(function(e){return{name:e,time:r.statSync(o.join(this.dirname,e)).mtime.getTime()}}.bind(this)).sort(function(e,t){return e.time-t.time}).map(function(e){return e.name})}catch(t){}return[]}.bind(this)(),this._year=this._getTime('year'),this._month=this._getTime('month'),this._date=this._getTime('date'),this._hour=this._getTime('hour'),this._minute=this._getTime('minute'),this._weekday=f[this._getTime('day')];var a=/d{1,4}|m{1,4}|yy(?:yy)?|([HhM])\1?/g,s=function(e,t){for(e+='',t=t||2;e.length<t;)e='0'+e;return e};this.getFormattedDate=function(){this._year=this._getTime('year'),this._month=this._getTime('month'),this._date=this._getTime('date'),this._hour=this._getTime('hour'),this._minute=this._getTime('minute'),this._weekday=f[this._getTime('day')];var e={yy:(this._year+'').slice(2),yyyy:this._year,M:this._month+1,MM:s(this._month+1),d:this._date,dd:s(this._date),H:this._hour,HH:s(this._hour),m:this._minute,mm:s(this._minute),ddd:this._weekday};return this.datePattern.replace(a,function(t){return t in e?e[t]:t.slice(1,t.length-1)})}};a.inherits(_,i),u.transports.DailyRotateFile=_,_.prototype.name='dailyRotateFile',_.prototype.log=function(e,t,n,r){if(this.silent)return r(null,!0);if(this._failures>=this.maxRetries)return r(new Error('Transport is in a failed state.'));var o=this,a=s.log({level:e,message:t,meta:n,json:this.json,colorize:this.colorize,logstash:this.logstash,prettyPrint:this.prettyPrint,timestamp:this.timestamp,label:this.label,stringify:this.stringify,showLevel:this.showLevel,depth:this.depth,formatter:this.formatter,humanReadableUnhandledException:this.humanReadableUnhandledException})+this.eol;this._size+=a.length,this.filename?this.open(function(e){return e?o._buffer.push([a,r]):void(o._write(a,r),o._lazyDrain())}):(this._write(a,r),this._lazyDrain())},_.prototype._write=function(e,t){var n=this._stream.write(e);return t?!1===n?this._stream.once('drain',function(){t(null,!0)}):void t(null,!0):void 0},_.prototype.query=function(e,t){'function'==typeof e&&(t=e,e={});var n=this,a=n._currentFiles.slice(0),s=[],d=0;e=n.normalizeQuery(e),0===a.length&&t&&t(null,s),function i(l){function u(e,t){try{var n=JSON.parse(e);p(n)&&c(n)}catch(n){t||m.emit('error',n)}}function c(t){if(e.rows&&s.length>=e.rows&&'desc'!==e.order)return void(m.readable&&m.destroy());if(e.fields){var n={};e.fields.forEach(function(e){n[e]=t[e]}),t=n}'desc'===e.order&&s.length>=e.rows&&s.shift(),s.push(t)}function p(t){if(t&&'object'==typeof t){var n=new Date(t.timestamp);return e.from&&n<e.from||e.until&&n>e.until?void 0:!0}}if(l){var f=o.join(n.dirname,l),_='',m=r.createReadStream(f,{encoding:'utf8'});m.on('error',function(e){return m.readable&&m.destroy(),t?'ENOENT'===e.code?t(null,s):t(e):void 0}),m.on('data',function(t){t=(_+t).split(/\n+/);for(var n=t.length-1,r=0;r<n;r++)(!e.start||d>=e.start)&&u(t[r]),d++;_=t[n]}),m.on('close',function(){_&&u(_,!0),'desc'===e.order&&(s=s.reverse()),a.length?i(a.shift()):t&&t(null,s)})}}(a.shift())},_.prototype.stream=function(e){var t=o.join(this.dirname,this._getFilename());e=e||{};var n=new d,r={file:t,start:e.start};return n.destroy=s.tailFile(r,function(e,t){if(e)return n.emit('error',e);try{n.emit('data',t),t=JSON.parse(t),n.emit('log',t)}catch(t){n.emit('error',t)}}),n.resume&&n.resume(),n},_.prototype.open=function(e){if(this.opening)return e(!0);return!this._stream||this.maxsize&&this._size>=this.maxsize||this._filenameHasExpired()?(this._cleanOldFiles(),e(!0),this._createStream()):void e()},_.prototype.close=function(){var e=this;this._stream&&(this._stream.end(),this._stream.destroySoon(),this._stream.once('drain',function(){e.emit('flush'),e.emit('closed')}))},_.prototype.flush=function(){var e=this;this._buffer.forEach(function(t){var n=t[0],r=t[1];process.nextTick(function(){e._write(n,r),e._size+=n.length})}),e._buffer.length=0,e._stream.once('drain',function(){e.emit('flush'),e.emit('logged')})},_.prototype._createStream=function(){var e=this;this.opening=!0,function t(n){function a(t){e._stream&&(e._archive=!!e.zippedArchive&&e._stream.path,e._stream.end(),e._stream.destroySoon()),e.createTree&&c.sync(o.dirname(i)),e._size=t,e.filename=n,e._stream=r.createWriteStream(i,e.options),e._stream.on('error',function(t){e._failures<e.maxRetries?(e._createStream(),e._failures++):e.emit('error',t)}),e._stream.setMaxListeners(Infinity),e.once('flush',function(){e.flush(),e.opening=!1,e.emit('open',i)}),e.flush(),s()}function s(){var t=e._archive;if(e._archive=!1,t&&r.existsSync(t+'')){var n=p.createGzip(),o=r.createReadStream(t+''),a=r.createWriteStream(t+'.gz');o.pipe(n).pipe(a),r.unlinkSync(t+'')}}var i=o.join(e.dirname,n);r.stat(i,function(n,r){return n?'ENOENT'===n.code?a(0):e.emit('error',n):!r||e.maxsize&&r.size>=e.maxsize?t(e._getFile(!0)):e._filenameHasExpired()?(e._year=e._getTime('year'),e._month=e._getTime('month'),e._date=e._getTime('date'),e._hour=e._getTime('hour'),e._minute=e._getTime('minute'),e._weekday=f[e._getTime('day')],e._created=0,t(e._getFile())):void a(r.size)})}(this._getFile())},_.prototype._getFile=function(e){var t=this._getFilename(),n;if(e){if(this.maxFiles&&this._created>=this.maxFiles-1)if(n=this._created-(this.maxFiles-1),0===n)try{r.unlinkSync(o.join(this.dirname,t))}catch(t){}else try{r.unlinkSync(o.join(this.dirname,t+'.'+n))}catch(t){}this._created+=1}else if(!this.maxsize)for(-1===this._currentFiles.indexOf(t)&&this._currentFiles.push(t);this.maxFiles&&this._currentFiles.length>this.maxFiles;){try{r.unlinkSync(o.join(this.dirname,this._currentFiles[0]))}catch(t){}this._currentFiles=this._currentFiles.slice(1)}return this._created?t+'.'+this._created:t},_.prototype._getFilename=function(){var e=this.getFormattedDate();return this.prepend?('.yyyy-MM-dd'===this.datePattern&&(this.datePattern='yyyy-MM-dd.',e=this.getFormattedDate()),e+this._basename):this._basename+e},_.prototype._lazyDrain=function(){var e=this;!this._draining&&this._stream&&(this._draining=!0,this._stream.once('drain',function(){this._draining=!1,e.emit('logged')}))},_.prototype._filenameHasExpired=function(){if(this.datePattern.match(/m/))return this._year<this._getTime('year')||this._month<this._getTime('month')||this._date<this._getTime('date')||this._hour<this._getTime('hour')||this._minute<this._getTime('minute');return this.datePattern.match(/H/)?this._year<this._getTime('year')||this._month<this._getTime('month')||this._date<this._getTime('date')||this._hour<this._getTime('hour'):this.datePattern.match(/d/)?this._year<this._getTime('year')||this._month<this._getTime('month')||this._date<this._getTime('date'):this.datePattern.match(/M/)?this._year<this._getTime('year')||this._month<this._getTime('month'):!!this.datePattern.match(/yy/)&&this._year<this._getTime('year')},_.prototype._getTime=function(e){var t=new Date;if(this.localTime){if('year'===e)return t.getFullYear();if('month'===e)return t.getMonth();if('date'===e)return t.getDate();if('hour'===e)return t.getHours();if('minute'===e)return t.getMinutes();if('day'===e)return t.getDay()}return'year'===e?t.getUTCFullYear():'month'===e?t.getUTCMonth():'date'===e?t.getUTCDate():'hour'===e?t.getUTCHours():'minute'===e?t.getUTCMinutes():'day'===e?t.getUTCDay():void 0},_.prototype._cleanOldFiles=function(){function e(e){r.unlink(n.dirname+o.sep+e,function(t){t&&console.error('Error removing file ',e)})}function t(t){var i=n.dirname+o.sep+t;r.stat(i,function(r,o){if(r)return void console.error('Error stats file ',t,r);var i=o.mtime&&o.mtime.getTime()||0;o.isFile()&&s-i>a*n.maxDays&&e(t)})}var n=this,a=8.64e7,s=Date.now();n.maxDays&&r.readdir(n.dirname,function(e,r){if(e)return void console.error('Error reading directory ',n.dirname,e);var o=new RegExp(n._basename,'g');r.forEach(function(e){/.log/.test(e)&&o.test(e)&&t(e)})})}},function(e,t,n){'use strict';function r(e,t,n,i){'function'==typeof t?(n=t,t={}):(!t||'object'!=typeof t)&&(t={mode:t});var d=t.mode,l=t.fs||a;d===void 0&&(d=s&~process.umask()),i||(i=null);var u=n||function(){};e=o.resolve(e),l.mkdir(e,d,function(n){if(!n)return i=i||e,u(null,i);switch(n.code){case'ENOENT':r(o.dirname(e),t,function(n,o){n?u(n,o):r(e,t,u,o)});break;default:l.stat(e,function(e,t){e||!t.isDirectory()?u(n,i):u(null,i)});}})}var o=n(8),a=n(4),s=parseInt('0777',8);e.exports=r.mkdirp=r.mkdirP=r,r.sync=function e(t,n,r){n&&'object'==typeof n||(n={mode:n});var i=n.mode,d=n.fs||a;i===void 0&&(i=s&~process.umask()),r||(r=null),t=o.resolve(t);try{d.mkdirSync(t,i),r=r||t}catch(a){switch(a.code){case'ENOENT':r=e(o.dirname(t),n,r),e(t,n,r);break;default:var l;try{l=d.statSync(t)}catch(e){throw a}if(!l.isDirectory())throw a;}}return r}},function(e,t,n){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}function o(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){function r(o,a){try{var s=t[o](a),i=s.value}catch(e){return void n(e)}return s.done?void e(i):Promise.resolve(i).then(function(e){r('next',e)},function(e){r('throw',e)})}return r('next')})}}Object.defineProperty(t,'__esModule',{value:!0}),t.Hub=void 0;var a=Object.assign||function(e){for(var t=1,n;t<arguments.length;t++)for(var r in n=arguments[t],n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r]);return e},s=n(27),i=r(s),d=n(3),l=r(d),u=n(5),c=r(u),p=n(39),f=r(p),_=n(40),m=r(_),g=n(28),h=n(32),y=n(18),b=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(y),v=n(47),k=n(0),x=n(50),E=n(16);class S extends l.default{constructor(e){super(),this._isFirstWorker=!i.default.worker||1>=i.default.worker.id,this._server=null,this._fastestServer=null,this._relays=[],this._onConnection=this._onConnection.bind(this),this._onClose=this._onClose.bind(this),e!==void 0&&h.Config.init(e)}run(){var e=this;return o(function*(){null!==e._server&&e.terminate(),e._server=yield e._createServer(),e._isFirstWorker&&k.logger.info(`[hub] blinksocks running at ${__LOCAL_PROTOCOL__}://${__LOCAL_HOST__}:${__LOCAL_PORT__}`),__IS_CLIENT__&&(e._isFirstWorker&&k.logger.info('[balancer] started'),g.Balancer.start(__SERVERS__))})()}terminate(){this._onClose()}_createServer(){var e=this;return o(function*(){const t={host:__LOCAL_HOST__,port:__LOCAL_PORT__};return new Promise(function(n){switch(__LOCAL_PROTOCOL__){case'tcp':{const r=c.default.createServer();r.on('connection',e._onConnection),r.on('close',e._onClose),r.listen(t,function(){return n(r)});break}case'socks':case'socks4':case'socks4a':case'socks5':{const r=x.socks.createServer();r.on('proxyConnection',e._onConnection),r.on('close',e._onClose),r.listen(t,function(){return n(r)});break}case'http':case'https':{const r=x.http.createServer();r.on('proxyConnection',e._onConnection),r.on('close',e._onClose),r.listen(t,function(){return n(r)});break}case'ws':{const r=new m.default.Server(a({},t,{perMessageDeflate:!1}));r.on('connection',function(t,n){t.remoteAddress=n.connection.remoteAddress,t.remotePort=n.connection.remotePort,e._onConnection(t)}),r.on('listening',function(){return n(r)});break}case'tls':{const r=f.default.createServer({key:[__TLS_KEY__],cert:[__TLS_CERT__]});r.on('secureConnection',e._onConnection),r.on('close',e._onClose),r.listen(t,function(){return n(r)});break}default:}})})()}_selectServer(){const e=g.Balancer.getFastest();(null===this._fastestServer||e.id!==this._fastestServer.id)&&(this._fastestServer=e,h.Config.initServer(e),b.reset(),k.logger.info(`[balancer] use server: ${__SERVER_HOST__}:${__SERVER_PORT__}`))}_onConnection(e,t){__IS_CLIENT__&&this._selectServer(),k.logger.verbose(`[hub] [${e.remoteAddress}:${e.remotePort}] connected`);const n=(0,v.createRelay)(__TRANSPORT__,e);n.on('close',()=>this._onRelayClose(n.id)),__IS_CLIENT__&&n.pipe.broadcast('client',{type:E.CONNECT_TO_REMOTE,payload:t}),this._relays.push(n)}_onRelayClose(e){this._relays=this._relays.filter((t)=>t.id!==e)}_onClose(){null!==this._server&&(this._relays.forEach((e)=>e.destroy()),this._relays=null,b.cleanup(),__IS_CLIENT__&&(g.Balancer.destroy(),this._isFirstWorker&&k.logger.info('[balancer] stopped')),this._server.close(),this._server=null,this._isFirstWorker&&k.logger.info('[hub] shutdown'),this.emit('close'))}}t.Hub=S},function(e){'use strict';function t(e){return this instanceof t?void(e=e||{},this.concurrency=e.concurrency||Infinity,this.pending=0,this.jobs=[],this.cbs=[],this._done=n.bind(this)):new t(e)}function n(){this.pending--,this._run()}['push','unshift','splice'].forEach(function(e){t.prototype[e]=function(){var t=Array.prototype[e].apply(this.jobs,arguments);return this._run(),t}}),Object.defineProperty(t.prototype,'length',{get:function(){return this.pending+this.jobs.length}}),t.prototype._run=function(){if(this.pending!==this.concurrency){if(this.jobs.length){var e=this.jobs.shift();this.pending++,e(this._done),this._run()}if(0===this.pending)for(;0!==this.cbs.length;){var t=this.cbs.pop();process.nextTick(t)}}},t.prototype.onDone=function(e){'function'==typeof e&&(this.cbs.push(e),this._run())},e.exports=t},function(e){'use strict';class t{constructor(e,t){this.target=t,this.type=e}}class n extends t{constructor(e,t){super('message',t),this.data=e}}class r extends t{constructor(e,t,n){super('close',n),this.wasClean=e===void 0||1e3===e||3e3<=e&&4999>=e,this.reason=t,this.code=e}}class o extends t{constructor(e){super('open',e)}}const a={addEventListener(e,t){function a(e){t.call(this,new n(e,this))}function s(e,n){t.call(this,new r(e,n,this))}function i(e){e.type='error',e.target=this,t.call(this,e)}function d(){t.call(this,new o(this))}'function'!=typeof t||('message'===e?(a._listener=t,this.on(e,a)):'close'===e?(s._listener=t,this.on(e,s)):'error'===e?(i._listener=t,this.on(e,i)):'open'===e?(d._listener=t,this.on(e,d)):this.on(e,t))},removeEventListener(e,t){const n=this.listeners(e);for(var r=0;r<n.length;r++)(n[r]===t||n[r]._listener===t)&&this.removeListener(e,n[r])}};e.exports=a},function(e,t,n){'use strict';try{const t=n(!function(){var t=new Error('Cannot find module "utf-8-validate"');throw t.code='MODULE_NOT_FOUND',t}());e.exports='object'==typeof t?t.Validation.isValidUTF8:t}catch(t){e.exports=()=>!0}},function(e,t,n){'use strict';function r(){this.destroy()}function o(e,t){const n=e.perMessageDeflate,r={};if(n&&t[p.extensionName]){const o=new p(!0===n?{}:n,!0,e.maxPayload);o.accept(t[p.extensionName]),r[p.extensionName]=o}return r}function a(e,t,n){e.writable&&(n=n||u.STATUS_CODES[t],e.write(`HTTP/1.1 ${t} ${u.STATUS_CODES[t]}\r\n`+'Connection: close\r\nContent-type: text/html\r\n'+`Content-Length: ${g.byteLength(n)}\r\n`+'\r\n'+n)),e.removeListener('error',r),e.destroy()}const s=n(12),i=n(3),d=n(2),l=n(42),u=n(20),c=n(21),p=n(22),f=n(43),_=n(25),m=n(41),g=s.Buffer;e.exports=class extends i{constructor(e,t){if(super(),e=Object.assign({maxPayload:104857600,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null},e),null==e.port&&!e.server&&!e.noServer)throw new TypeError('missing or invalid options');null==e.port?e.server&&(this._server=e.server):(this._server=u.createServer((e,t)=>{const n=u.STATUS_CODES[426];t.writeHead(426,{"Content-Length":n.length,"Content-Type":'text/plain'}),t.end(n)}),this._server.allowHalfOpen=!1,this._server.listen(e.port,e.host,e.backlog,t)),this._server&&(this._ultron=new l(this._server),this._ultron.on('listening',()=>this.emit('listening')),this._ultron.on('error',(e)=>this.emit('error',e)),this._ultron.on('upgrade',(e,t,n)=>{this.handleUpgrade(e,t,n,(t)=>{this.emit('connection',t,e)})})),e.clientTracking&&(this.clients=new Set),this.options=e}close(e){if(this.clients){var t=!0,n=!1,r;try{for(var o=this.clients[Symbol.iterator](),a;!(t=(a=o.next()).done);t=!0){const e=a.value;e.terminate()}}catch(e){n=!0,r=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw r}}}const s=this._server;return s&&(this._ultron.destroy(),this._ultron=this._server=null,null!=this.options.port)?s.close(e):void(e&&e())}shouldHandle(e){return this.options.path&&c.parse(e.url).pathname!==this.options.path?!1:!0}handleUpgrade(e,t,n,o){t.on('error',r);const s=+e.headers['sec-websocket-version'];if('GET'!==e.method||'websocket'!==e.headers.upgrade.toLowerCase()||!e.headers['sec-websocket-key']||8!=s&&13!=s||!this.shouldHandle(e))return a(t,400);var i=(e.headers['sec-websocket-protocol']||'').split(/, */);if(!this.options.handleProtocols)i=i[0];else if(i=this.options.handleProtocols(i,e),!1===i)return a(t,401);if(this.options.verifyClient){const r={origin:e.headers[`${8==s?'sec-websocket-origin':'origin'}`],secure:!!(e.connection.authorized||e.connection.encrypted),req:e};if(2===this.options.verifyClient.length)return void this.options.verifyClient(r,(r,d,l)=>r?void this.completeUpgrade(i,s,e,t,n,o):a(t,d||401,l));if(!this.options.verifyClient(r))return a(t,401)}this.completeUpgrade(i,s,e,t,n,o)}completeUpgrade(e,t,n,s,i,l){if(!s.readable||!s.writable)return s.destroy();const u=d.createHash('sha1').update(n.headers['sec-websocket-key']+_.GUID,'binary').digest('base64'),c=['HTTP/1.1 101 Switching Protocols','Upgrade: websocket','Connection: Upgrade',`Sec-WebSocket-Accept: ${u}`];e&&c.push(`Sec-WebSocket-Protocol: ${e}`);const p=f.parse(n.headers['sec-websocket-extensions']);var g;try{g=o(this.options,p)}catch(e){return a(s,400)}const h=Object.keys(g);if(h.length){const e=h.reduce((e,t)=>(e[t]=[g[t].params],e),{});c.push(`Sec-WebSocket-Extensions: ${f.format(e)}`)}this.emit('headers',c,n),s.write(c.concat('','').join('\r\n'));const y=new m([s,i],null,{maxPayload:this.options.maxPayload,protocolVersion:t,extensions:g,protocol:e});this.clients&&(this.clients.add(y),y.on('close',()=>this.clients.delete(y))),s.removeListener('error',r),l(y)}}},function(e){'use strict';function t(e){if('string'==typeof e)return e;if(r(e))return m?m.call(e):'';var t=e+'';return'0'==t&&1/e==-a?'-0':t}function n(e){return!!e&&'object'==typeof e}function r(e){return'symbol'==typeof e||n(e)&&p.call(e)==s}function o(e){return null==e?'':t(e)}var a=1/0,s='[object Symbol]',i='object'==typeof global&&global&&global.Object===Object&&global,d='object'==typeof self&&self&&self.Object===Object&&self,l=i||d||Function('return this')(),u=Object.prototype,c=0,p=u.toString,f=l.Symbol,_=f?f.prototype:void 0,m=_?_.toString:void 0;e.exports=function(e){var t=++c;return o(e)+t}},function(e,t,n){'use strict';function r(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){function r(o,a){try{var s=t[o](a),i=s.value}catch(e){return void n(e)}return s.done?void e(i):Promise.resolve(i).then(function(e){r('next',e)},function(e){r('throw',e)})}return r('next')})}}Object.defineProperty(t,'__esModule',{value:!0}),t.TlsOutbound=t.TlsInbound=void 0;var o=n(39),a=function(e){return e&&e.__esModule?e:{default:e}}(o),s=n(48),i=n(0);class d extends s.TcpInbound{get bufferSize(){return super.bufferSize-1}}t.TlsInbound=d;class l extends s.TcpOutbound{get bufferSize(){return super.bufferSize-1}_connect({host:e,port:t}){var n=this;return r(function*(){return i.logger.info(`[tls:outbound] [${n.remote}] connecting to: ${e}:${t}`),a.default.connect({host:e,port:t,ca:[__TLS_CERT__]})})()}}t.TlsOutbound=l},function(e,t,n){'use strict';function r(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){function r(o,a){try{var s=t[o](a),i=s.value}catch(e){return void n(e)}return s.done?void e(i):Promise.resolve(i).then(function(e){r('next',e)},function(e){r('throw',e)})}return r('next')})}}Object.defineProperty(t,'__esModule',{value:!0}),t.WsOutbound=t.WsInbound=void 0;var o=function(){function e(e,t){var n=[],r=!0,o=!1,a;try{for(var s=e[Symbol.iterator](),i;!(r=(i=s.next()).done)&&(n.push(i.value),!(t&&n.length===t));r=!0);}catch(e){o=!0,a=e}finally{try{!r&&s['return']&&s['return']()}finally{if(o)throw a}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError('Invalid attempt to destructure non-iterable instance')}}(),a=n(40),s=function(e){return e&&e.__esModule?e:{default:e}}(a),i=n(49),d=n(13),l=n(0),u=n(1);class c extends i.Inbound{constructor(e){super(e),this._ws=null;const t=e.context;this.destroy=this.destroy.bind(this),this.onError=this.onError.bind(this),this.onReceive=this.onReceive.bind(this),this._ws=t,this._ws.on('message',this.onReceive),this._ws.on('error',this.onError),this._ws.on('close',this.destroy)}onError(e){l.logger.warn(`[ws:inbound] [${this.remote}] ${e.code||''} - ${e.message}`)}onReceive(e){const t=__IS_CLIENT__?d.MIDDLEWARE_DIRECTION_UPWARD:d.MIDDLEWARE_DIRECTION_DOWNWARD;this._pipe.feed(t,e)}get bufferSize(){return this._ws?this._ws.bufferedAmount:0}get writable(){return this._ws&&1===this._ws.readyState}onBroadcast(e){switch(e.type){case u.PRESET_FAILED:this.onPresetFailed(e);break;case u.PRESET_CLOSE_CONNECTION:this.onPresetCloseConnection();break;case u.PRESET_PAUSE_RECV:this.onPresetPauseRecv();break;case u.PRESET_RESUME_RECV:this.onPresetResumeRecv();break;default:}}onPresetFailed(e){var t=this;return r(function*(){var n=e.payload;const r=n.name,a=n.message;if(l.logger.error(`[ws:inbound] [${t.remote}] preset "${r}" fail to process: ${a}`),__IS_CLIENT__&&(l.logger.warn(`[ws:inbound] [${t.remote}] connection closed`),t.destroy()),__IS_SERVER__)if(__REDIRECT__){const n=e.payload.orgData;var s=__REDIRECT__.split(':'),i=o(s,2);const r=i[0],a=i[1];l.logger.warn(`[ws:inbound] [${t.remote}] connection is redirecting to: ${r}:${a}`),t.setPresets(function(){return[{name:'tracker'}]}),yield t._outbound.connect({host:r,port:+a}),t._outbound.writable&&t._outbound.write(n)}else{t._ws&&t._ws.pause();const e=(0,l.getRandomInt)(10,40);l.logger.warn(`[ws:inbound] [${t.remote}] connection will be closed in ${e}s...`),setTimeout(t.destroy,1e3*e)}})()}onPresetCloseConnection(){l.logger.info(`[ws:inbound] [${this.remote}] preset request to close connection`),this.destroy()}onPresetPauseRecv(){__IS_SERVER__&&this._ws&&this._ws.pause()}onPresetResumeRecv(){__IS_SERVER__&&this._ws&&this._ws.resume()}write(e){this.writable&&this._ws.send(e)}destroy(){if(this._ws){const e={host:this.remoteHost,port:this.remotePort};this.broadcast({type:u.CONNECTION_WILL_CLOSE,payload:e}),this._ws.close(1e3),this._ws=null,this.emit('close'),this.broadcast({type:u.CONNECTION_CLOSED,payload:e})}if(this._outbound&&!this._outbound.destroying){this._outbound.destroying=!0;const e=this._outbound.bufferSize;0<e?this._outbound.once('drain',()=>this._outbound.destroy()):(this._outbound.destroy(),this._outbound=null)}}}t.WsInbound=c;class p extends i.Outbound{constructor(e){super(e),this._ws=null,this.destroy=this.destroy.bind(this),this.onError=this.onError.bind(this),this.onReceive=this.onReceive.bind(this)}onError(e){l.logger.warn(`[ws:outbound] [${this.remote}] ${e.code||''} - ${e.message}`)}onReceive(e){const t=__IS_CLIENT__?d.MIDDLEWARE_DIRECTION_DOWNWARD:d.MIDDLEWARE_DIRECTION_UPWARD;this._pipe.feed(t,e)}get bufferSize(){return this._ws?this._ws.bufferedAmount:0}get writable(){return this._ws&&1===this._ws.readyState}write(e){this.writable&&this._ws.send(e)}destroy(){if(this._ws&&(this._ws.close(1e3),this._ws=null),this._inbound&&!this._inbound.destroying){this._inbound.destroying=!0;const e=this._inbound.bufferSize;0<e?this._inbound.once('drain',()=>this._inbound.destroy()):(this._inbound.destroy(),this._inbound=null)}}onBroadcast(e){switch(e.type){case u.CONNECT_TO_REMOTE:this.onConnectToRemote(e);break;case u.PRESET_PAUSE_SEND:this.onPresetPauseSend();break;case u.PRESET_RESUME_SEND:this.onPresetResumeSend();break;default:}}onConnectToRemote(e){var t=this;return r(function*(){var n=e.payload;const r=n.host,o=n.port,a=n.onConnected;__IS_SERVER__&&(yield t.connect({host:r,port:o})),__IS_CLIENT__&&(l.logger.info(`[ws:outbound] [${t.remote}] request: ${r}:${o}`),yield t.connect({host:__SERVER_HOST__,port:__SERVER_PORT__})),t._inbound._isConnectedToRemote=!0,'function'==typeof a&&a(t._inbound.onReceive)})()}onPresetPauseSend(){__IS_SERVER__&&this._ws&&this._ws.pause()}onPresetResumeSend(){__IS_SERVER__&&this._ws&&this._ws.resume()}connect({host:e,port:t}){var n=this;return r(function*(){let r=null;try{r=yield n._dnsCache.get(e)}catch(t){l.logger.error(`[ws:outbound] [${n.remote}] fail to resolve host ${e}: ${t.message}`)}return l.logger.info(`[ws:outbound] [${n.remote}] connecting to: ws://${r}:${t}`),new Promise(function(r){n._ws=new s.default(`ws://${e}:${t}`,{perMessageDeflate:!1}),n._ws.on('open',function(){return r(n._ws)}),n._ws.on('message',n.onReceive),n._ws.on('close',n.destroy),n._ws.on('error',n.onError)})})()}}t.WsOutbound=p},function(e,t,n){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,'__esModule',{value:!0}),t.createServer=function(){const e=i.default.createServer();return e.on('request',(t,n)=>{var r=a.default.parse(t.url);const o=r.hostname,s=r.port,i=r.path,l=t.socket,u=t.method,c=t.httpVersion,p=t.headers,f=+s||80;if(null===o||null===f){const e=`${l.remoteAddress}:${l.remotePort}`;return d.logger.warn(`[http] drop invalid http request sent from ${e}`),n.end()}l.pause(),e.emit('proxyConnection',l,{host:o,port:f,onConnected:(e)=>{delete p['proxy-connection'],p.connection='close';const t=Object.keys(p),n=[];var r=!0,o=!1,a;try{for(var s=t[Symbol.iterator](),d;!(r=(d=s.next()).done);r=!0){const e=d.value,t=p[e];n.push(`${e}: ${t}\r\n`)}}catch(e){o=!0,a=e}finally{try{!r&&s.return&&s.return()}finally{if(o)throw a}}const f=`${u} ${i} HTTP/${c}\r\n`+n.join('')+'\r\n';e(Buffer.from(f)),l.resume()}})}),e.on('connect',(t,n)=>{var r=a.default.parse(`http://${t.url}`);const o=r.hostname,s=r.port,i=+s||443;if(null===o||null===i){const e=`${n.remoteAddress}:${n.remotePort}`;return d.logger.warn(`[http] drop invalid http CONNECT request sent from ${e}`),n.destroy()}e.emit('proxyConnection',n,{host:o,port:i,onConnected:()=>{n.write('HTTP/1.1 200 Connection Established\r\n\r\n')}})}),e};var o=n(21),a=r(o),s=n(20),i=r(s),d=n(0)},function(e,t,n){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}function o(e){return 3>e.length?null:e[0]===f?1>e[1]?null:!(e.slice(2).length!==e[1])||null:null}function a(e){if(9>e.length)return null;if(e[0]!==f)return null;if(![m,g,h].includes(e[1]))return null;if(e[2]!==c)return null;if(![y,b,v].includes(e[3]))return null;let t=null;switch(e[3]){case y:t=u.default.toString(e.slice(4,8));break;case b:t=Buffer.from(e.slice(5,5+e[4]));break;case v:t=u.default.toString(e.slice(4,20));break;default:}const n=e.slice(-2).readUInt16BE(0);return{host:t,port:n}}function s(e){if(9>e.length)return null;if(e[0]!==p)return null;if(![m,g].includes(e[1]))return null;if(e[e.length-1]!==c)return null;const t=e.slice(4,8),n=e.slice(2,4);let r=[];const o=t[0]===c&&t[1]===c&&t[2]===c&&t[3]!==c;if(o){const t=e.slice(8),n=[];let o=[];var a=!0,s=!1,i;try{for(var d=t[Symbol.iterator](),l;!(a=(l=d.next()).done);a=!0){const e=l.value;e===c?(n.push(o),o=[]):o.push(e)}}catch(e){s=!0,i=e}finally{try{!a&&d.return&&d.return()}finally{if(s)throw i}}if(2!==n.length||1>n[1].length)return null;r=Buffer.from(n[1])}return{host:o?Buffer.from(r):u.default.toString(t),port:n.readUInt16BE(0)}}Object.defineProperty(t,'__esModule',{value:!0}),t.createServer=function(){const e=d.default.createServer();return e.on('connection',(t)=>{let n=S;t.on('data',function r(i){let d;if(n==S){if(d=o(i),null!==d)return n=w,void t.write(Buffer.from([f,_]));if(d=s(i),null!==d){n=C;var l=d;const o=l.host,a=l.port;e.emit('proxyConnection',t,{host:o,port:a,onConnected:()=>{t.write(Buffer.from([c,k,c,c,c,c,c,c]))}}),t.removeListener('data',r)}}else if(n==w&&(d=a(i),null!==d)){n=C;const o=i[1];switch(o){case h:case m:{var u=d;const n=u.host,o=u.port;e.emit('proxyConnection',t,{host:n,port:o,onConnected:()=>{t.write(Buffer.from([f,x,c,y,c,c,c,c,c,c]))}}),t.removeListener('data',r);break}default:{t.write(Buffer.from([f,E,c,y,c,c,c,c,c,c]));break}}}})}),e};var i=n(5),d=r(i),l=n(17),u=r(l);const c=0,p=4,f=5,_=0,m=1,g=2,h=3,y=1,b=3,v=4,k=90,x=0,E=7,S=0,w=1,C=2},function(e,t,n){'use strict';function r(){let e=__PRESETS__;return'tracker'!==e[e.length-1].name&&(e=e.concat([{name:'tracker'}])),e}Object.defineProperty(t,'__esModule',{value:!0}),t.Relay=void 0;var o=n(3),a=function(e){return e&&e.__esModule?e:{default:e}}(o),s=n(51),i=n(18),d=n(16);class l extends a.default{constructor({context:e,Inbound:t,Outbound:n}){super(),this._inbound=null,this._outbound=null,this._pipe=null,this._presets=[],this.setPresets=this.setPresets.bind(this),this.onBroadcast=this.onBroadcast.bind(this),this.postPipeForward=this.postPipeForward.bind(this),this.postPipeBackward=this.postPipeBackward.bind(this),this._presets=r(),this._pipe=this.createPipe(this._presets),this._inbound=new t({context:e,pipe:this._pipe}),this._outbound=new n({inbound:this._inbound,pipe:this._pipe}),this._outbound.setPresets=this.setPresets,this._inbound.setPresets=this.setPresets,this._inbound.setOutbound(this._outbound),this._inbound.on('close',()=>this.emit('close')),this._pipe.broadcast('pipe',{type:d.CONNECTION_CREATED,payload:{host:e.remoteAddress,port:e.remotePort}})}get pipe(){return this._pipe}onBroadcast(e){this._inbound.onBroadcast(e),this._outbound.onBroadcast(e)}postPipeForward(e){__IS_CLIENT__?this._outbound.write(e):this._inbound.write(e)}postPipeBackward(e){__IS_CLIENT__?this._inbound.write(e):this._outbound.write(e)}setPresets(e){this._presets=e(this._presets),this._pipe.destroy(),this._pipe=this.createPipe(this._presets),this._inbound._pipe=this._pipe,this._outbound._pipe=this._pipe}createPipe(e){const t=e.map((e)=>(0,i.createMiddleware)(e.name,e.params||{})),n=new s.Pipe;return n.on('broadcast',this.onBroadcast.bind(this)),n.on(`post_${i.MIDDLEWARE_DIRECTION_UPWARD}`,this.postPipeForward),n.on(`post_${i.MIDDLEWARE_DIRECTION_DOWNWARD}`,this.postPipeBackward),n.setMiddlewares(t),n}destroy(){this._pipe.destroy(),this._inbound.destroy(),this._outbound.destroy(),this._pipe=null,this._inbound=null,this._outbound=null,this._presets=null}}t.Relay=l}]);
//# sourceMappingURL=blinksocks.js.map