'use strict';Object.defineProperty(exports,'__esModule',{value:true});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}return target};var _fs=require('fs');var _fs2=_interopRequireDefault(_fs);var _defs=require('./defs');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}const now=()=>new Date().getTime();const DEFAULT_SAMPLE_INTERVAL=30;const DEFAULT_SAVE_INTERVAL=60;class StatsPreset extends _defs.IPreset{constructor(params){super();this.sampleInterval=DEFAULT_SAMPLE_INTERVAL;this.saveInterval=DEFAULT_SAVE_INTERVAL;const props=_extends({sample_interval:DEFAULT_SAMPLE_INTERVAL,save_interval:DEFAULT_SAVE_INTERVAL},params);if(typeof props.save_to!=='string'||props.save_to.length<1){throw Error('\'save_to\' must be provided as a non-empty string')}if(typeof props.sample_interval==='undefined'){throw Error('\'sample_interval\' must be provided as an integer')}if(typeof props.sample_interval!=='number'){throw Error('\'sample_interval\' must be a number')}if(!Number.isSafeInteger(props.sample_interval)){throw Error('\'sample_interval\' must be an integer')}if(props.sample_interval<1){throw Error('\'sample_interval\' must be greater than 0')}if(typeof props.save_interval==='undefined'){throw Error('\'save_interval\' must be provided as an integer')}if(typeof props.save_interval!=='number'){throw Error('\'save_interval\' must be a number')}if(!Number.isSafeInteger(props.save_interval)){throw Error('\'save_interval\' must be an integer')}if(props.save_interval<1){throw Error('\'save_interval\' must be greater than 0')}StatsPreset.saveTo=props.save_to;this.sampleInterval=props.sample_interval;this.saveInterval=props.save_interval;if(StatsPreset.sampleTimer===null){StatsPreset.sampleTimer=setInterval(this.sample.bind(this),props.sample_interval*1e3)}if(StatsPreset.saveTimer===null){StatsPreset.saveTimer=setInterval(StatsPreset.save,props.save_interval*1e3)}if(!StatsPreset.isHookExit){process.on('SIGINT',StatsPreset.save);StatsPreset.isHookExit=true}StatsPreset.maxConnections+=1}static save(){const startedAt=StatsPreset.startedAt;const endAt=now();const durationMilliSec=endAt-startedAt;const durationSec=durationMilliSec/1e3;const totalPackets=StatsPreset.totalInPackets+StatsPreset.totalOutPackets;const totalBytes=StatsPreset.totalIn+StatsPreset.totalOut;const json={sample:{from:startedAt,to:endAt,duration:durationMilliSec},summary:{totalErrors:StatsPreset.totalErrors,totalOut:StatsPreset.totalOut,totalIn:StatsPreset.totalIn,totalOutPackets:StatsPreset.totalOutPackets,totalInPackets:StatsPreset.totalInPackets,totalBytes:totalBytes,totalPackets:totalPackets,maxOutSpeed:StatsPreset.maxOutSpeed,maxInSpeed:StatsPreset.maxInSpeed,maxConnections:StatsPreset.maxConnections-2},instant:{outSpeed:StatsPreset.instantOutSpeed,inSpeed:StatsPreset.instantInSpeed,errorRate:totalPackets.length>0?StatsPreset.totalErrors/totalPackets:0,outBytesRate:StatsPreset.totalOut/durationSec,outPacketsRate:StatsPreset.totalOutPackets/durationSec,inBytesRate:StatsPreset.totalIn/durationSec,inPacketsRate:StatsPreset.totalInPackets/durationSec,totalBytesRate:totalBytes/durationSec,totalPacketsRate:totalPackets/durationSec},process:{upTime:process.uptime(),cpuUsage:process.cpuUsage(),memoryUsage:process.memoryUsage()}};_fs2.default.writeFileSync(StatsPreset.saveTo,JSON.stringify(json,null,'  '))}sample(){StatsPreset.instantOutSpeed=StatsPreset.tmpOut/this.sampleInterval;StatsPreset.instantInSpeed=StatsPreset.tmpIn/this.sampleInterval;StatsPreset.maxOutSpeed=Math.max(StatsPreset.maxOutSpeed,StatsPreset.instantOutSpeed);StatsPreset.maxInSpeed=Math.max(StatsPreset.maxInSpeed,StatsPreset.instantInSpeed);StatsPreset.tmpOut=0;StatsPreset.tmpIn=0}onNotified(action){if(action.type===_defs.PROCESSING_FAILED){StatsPreset.totalErrors+=1}}beforeOut({buffer}){StatsPreset.totalOut+=buffer.length;StatsPreset.totalOutPackets+=1;StatsPreset.tmpOut+=buffer.length;return buffer}beforeIn({buffer}){StatsPreset.totalIn+=buffer.length;StatsPreset.totalInPackets+=1;StatsPreset.tmpIn+=buffer.length;return buffer}}exports.default=StatsPreset;StatsPreset.saveTo='';StatsPreset.sampleTimer=null;StatsPreset.saveTimer=null;StatsPreset.isHookExit=false;StatsPreset.startedAt=now();StatsPreset.totalOut=0;StatsPreset.totalIn=0;StatsPreset.totalOutPackets=0;StatsPreset.totalInPackets=0;StatsPreset.totalErrors=0;StatsPreset.maxConnections=0;StatsPreset.instantOutSpeed=0;StatsPreset.instantInSpeed=0;StatsPreset.maxOutSpeed=0;StatsPreset.maxInSpeed=0;StatsPreset.tmpOut=0;StatsPreset.tmpIn=0;