'use strict';Object.defineProperty(exports,'__esModule',{value:true});var _net=require('net');var _net2=_interopRequireDefault(_net);var _ip=require('ip');var _ip2=_interopRequireDefault(_ip);var _utils=require('../utils');var _defs=require('./defs');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}const ATYP_V4=1;const ATYP_V6=4;class ExpBaseWithPaddingPreset extends _defs.IPreset{constructor({salt}){super();this._isHandshakeDone=false;this._isAddressReceived=false;this._host=null;this._port=null;this._padding=null;this._staging=Buffer.alloc(0);if(typeof salt!=='string'||salt===''){throw Error('\'salt\' must be set to a non-empty string')}this._padding=(0,_utils.hash)('sha256',salt).slice(0,15)}onNotified(action){if(__IS_CLIENT__&&action.type===_defs.PROXY_HANDSHAKE_DONE){var _action$payload$targe=action.payload.targetAddress;const type=_action$payload$targe.type,host=_action$payload$targe.host,port=_action$payload$targe.port;if(type===ATYP_V4||type===ATYP_V6){this._host=Buffer.from(_ip2.default.toString(host))}else{this._host=Buffer.from(host)}this._port=(0,_utils.numberToBuffer)(port)}}clientOut({buffer}){if(!this._isHandshakeDone){this._isHandshakeDone=true;return Buffer.concat([(0,_utils.numberToBuffer)(this._host.length,1),this._padding,this._host,this._port,buffer])}else{return buffer}}serverIn({buffer,next,broadcast,fail}){if(!this._isHandshakeDone){if(this._isAddressReceived){this._staging=Buffer.concat([this._staging,buffer]);return}if(buffer.length<20){return fail(`unexpected buffer length: ${buffer.length}, buffer=${buffer.toString('hex')}`)}if(!buffer.slice(1,16).equals(this._padding)){return fail(`unexpected padding=${this._padding.toString('hex')}`)}const alen=buffer[0];if(buffer.length<=alen+18){return fail(`unexpected buffer length: ${buffer.length}, buffer=${buffer.toString('hex')}`)}let addr=buffer.slice(16,16+alen);if((0,_utils.isValidHostname)(addr)){addr=addr.toString()}else if(_net2.default.isIP(addr)){addr=_ip2.default.toString(addr)}else{return fail(`invalid addr: (${addr.toString()})`)}const port=buffer.slice(alen+16,alen+18).readUInt16BE(0);const data=buffer.slice(alen+18);broadcast({type:_defs.SOCKET_CONNECT_TO_DST,payload:{targetAddress:{host:addr,port},onConnected:()=>{next(Buffer.concat([this._staging,data]));this._isHandshakeDone=true;this._staging=null}}});this._isAddressReceived=true}else{return buffer}}}exports.default=ExpBaseWithPaddingPreset;