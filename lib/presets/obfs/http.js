'use strict';Object.defineProperty(exports,'__esModule',{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _fs=require('fs');var _fs2=_interopRequireDefault(_fs);var _readline=require('readline');var _readline2=_interopRequireDefault(_readline);var _crypto=require('crypto');var _crypto2=_interopRequireDefault(_crypto);var _winston=require('winston');var _winston2=_interopRequireDefault(_winston);var _interface=require('../interface');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called')}return call&&(typeof call==='object'||typeof call==='function')?call:self}function _inherits(subClass,superClass){if(typeof superClass!=='function'&&superClass!==null){throw new TypeError('Super expression must either be null or a function, not '+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}var Faker=function(){function Faker(){_classCallCheck(this,Faker)}_createClass(Faker,null,[{key:'_parse',value:function _parse(file,callback){var _this=this;if(this._fakes.length>0){callback(this._fakes);return}var parts=[];var part='';var rl=_readline2.default.createInterface({input:_fs2.default.createReadStream(file)});rl.on('line',function(line){switch(line[0]){case'=':case'-':if(part!==''){part+='\r\n';parts.push(part);part=''}break;default:part+=line;part+='\r\n';break;}});rl.on('close',function(){for(var i=0;i<parts.length;i+=2){var prev=parts[i];var next=parts[i+1];_this._fakes.push({request:Buffer.from(prev),response:Buffer.from(next)})}callback(_this._fakes)})}},{key:'get',value:function get(file,callback){this._parse(file,callback)}}]);return Faker}();Faker._fakes=[];var HttpObfs=function(_IPreset){_inherits(HttpObfs,_IPreset);function HttpObfs(file){_classCallCheck(this,HttpObfs);var _this2=_possibleConstructorReturn(this,(HttpObfs.__proto__||Object.getPrototypeOf(HttpObfs)).call(this));_this2._isHandshakeDone=false;_this2._file=null;_this2._response=null;if(typeof file==='undefined'){throw Error('\'obfs_params\' requires at least one parameter.')}_this2._file=file;return _this2}_createClass(HttpObfs,[{key:'clientOut',value:function clientOut(_ref){var buffer=_ref.buffer,next=_ref.next;if(this._isHandshakeDone){return buffer}else{Faker.get(this._file,function(fakes){var index=_crypto2.default.randomBytes(1)[0]%fakes.length;var request=fakes[index].request;next(Buffer.concat([request,buffer]))})}}},{key:'serverIn',value:function serverIn(_ref2){var _this3=this;var buffer=_ref2.buffer,next=_ref2.next;if(this._isHandshakeDone){return buffer}else{Faker.get(this._file,function(fakes){var found=fakes.find(function(_ref3){var request=_ref3.request;return buffer.indexOf(request)===0});if(typeof found!=='undefined'){_this3._response=found.response;next(buffer.slice(found.request.length))}else{_winston2.default.error('dropped unrecognized obfs header: \''+buffer.slice(0,100).toString()+'...\'')}})}}},{key:'serverOut',value:function serverOut(_ref4){var buffer=_ref4.buffer;if(this._isHandshakeDone){return buffer}else{this._isHandshakeDone=true;return Buffer.concat([this._response,buffer])}}},{key:'clientIn',value:function clientIn(_ref5){var buffer=_ref5.buffer,next=_ref5.next;if(this._isHandshakeDone){return buffer}else{Faker.get(this._file,function(fakes){var found=fakes.find(function(_ref6){var response=_ref6.response;return buffer.indexOf(response)===0});if(typeof found!=='undefined'){next(buffer.slice(found.response.length))}else{_winston2.default.error('dropped unrecognized obfs header: \''+buffer.slice(0,100).toString()+'...\'')}});this._isHandshakeDone=true}}}]);return HttpObfs}(_interface.IPreset);exports.default=HttpObfs;