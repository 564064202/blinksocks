'use strict';Object.defineProperty(exports,'__esModule',{value:true});var _net=require('net');var _net2=_interopRequireDefault(_net);var _ip=require('ip');var _ip2=_interopRequireDefault(_ip);var _defs=require('./defs');var _utils=require('../utils');var _common=require('../proxies/common');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}class SSBasePreset extends _defs.IPreset{constructor(addr){super();this._isHandshakeDone=false;this._atyp=_common.ATYP_V4;this._addr=null;this._port=null;if(__IS_CLIENT__){const type=addr.type,host=addr.host,port=addr.port;this._atyp=type;this._addr=_net2.default.isIP(host)?_ip2.default.toBuffer(host):Buffer.from(host);this._port=port instanceof Buffer?port:_utils.Utils.numberToUInt(port)}}clientOut({buffer}){if(!this._isHandshakeDone){this._isHandshakeDone=true;return Buffer.from([this._atyp,...(this._atyp===_common.ATYP_DOMAIN?_utils.Utils.numberToUInt(this._addr.length,1):[]),...this._addr,...this._port,...buffer])}else{return buffer}}serverIn({buffer,next,broadcast,fail}){if(!this._isHandshakeDone){if(buffer.length<7){fail(`invalid length: ${buffer.length}`);return}const atyp=buffer[0];let addr,port;let offset=3;switch(atyp){case _common.ATYP_V4:addr=_ip2.default.toString(buffer.slice(1,5));port=buffer.slice(5,7).readUInt16BE(0);offset+=4;break;case _common.ATYP_V6:if(buffer.length<19){fail(`invalid length: ${buffer.length}`);return}addr=_ip2.default.toString(buffer.slice(1,16));port=buffer.slice(16,18).readUInt16BE(0);offset+=16;break;case _common.ATYP_DOMAIN:const domainLen=buffer[1];if(buffer.length<domainLen+4){fail(`invalid length: ${buffer.length}`);return}addr=buffer.slice(2,2+domainLen).toString();port=buffer.slice(2+domainLen,4+domainLen).readUInt16BE(0);offset+=domainLen+1;break;default:fail(`invalid atyp: ${atyp}`);return;}broadcast({type:_defs.SOCKET_CONNECT_TO_DST,payload:[{type:atyp,host:addr,port},()=>{next(buffer.slice(offset));this._isHandshakeDone=true}]})}else{return buffer}}serverOut({buffer}){return buffer}clientIn({buffer}){return buffer}}exports.default=SSBasePreset;