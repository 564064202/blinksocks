'use strict';Object.defineProperty(exports,'__esModule',{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _crypto=require('crypto');var _crypto2=_interopRequireDefault(_crypto);var _winston=require('winston');var _winston2=_interopRequireDefault(_winston);var _aead=require('./aead');var _aead2=_interopRequireDefault(_aead);var _utils=require('../../utils');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called')}return call&&(typeof call==='object'||typeof call==='function')?call:self}function _inherits(subClass,superClass){if(typeof superClass!=='function'&&superClass!==null){throw new TypeError('Super expression must either be null or a function, not '+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var PADDING_LEN=6;var SEQ_LEN=6;var Aead2Protocol=function(_AeadProtocol){_inherits(Aead2Protocol,_AeadProtocol);function Aead2Protocol(){var _ref;_classCallCheck(this,Aead2Protocol);for(var _len=arguments.length,params=Array(_len),_key=0;_key<_len;_key++){params[_key]=arguments[_key]}var _this=_possibleConstructorReturn(this,(_ref=Aead2Protocol.__proto__||Object.getPrototypeOf(Aead2Protocol)).call.apply(_ref,[this].concat(params)));_this._isHandshakeDone=false;if(__IS_SERVER__){_this._seq=_crypto2.default.randomBytes(SEQ_LEN).readUIntBE(0,SEQ_LEN)}else{_this._seq=0}return _this}_createClass(Aead2Protocol,[{key:'_out',value:function _out(_ref2){var buffer=_ref2.buffer;var encBuffer=this.encrypt(buffer);var encHeader=this.encrypt(Buffer.concat([_crypto2.default.randomBytes(PADDING_LEN),_utils.Utils.numberToUIntBE(this._seq,SEQ_LEN),_utils.Utils.numberToUIntBE(16+this._hmacLen+encBuffer.length+this._hmacLen,4)]),false);var hmacA=this.createHmac(encHeader);var hmacB=this.createHmac(encBuffer);var out=Buffer.concat([encHeader,hmacA,encBuffer,hmacB]);if(__IS_CLIENT__){_winston2.default.info('ClientOut(LEN='+out.length+', SEQ='+this._seq+'): '+out.slice(0,60).toString('hex'))}else{_winston2.default.info('ServerOut(LEN='+out.length+', SEQ='+this._seq+'): '+out.slice(0,60).toString('hex'))}this._seq+=1;return out}},{key:'onGetLength',value:function onGetLength(buffer){if(buffer.length<16+2*this._hmacLen){return 0}var encLen=buffer.slice(0,16);var expHmacA=this.createHmac(encLen);var hmacA=buffer.slice(16,16+this._hmacLen);if(!hmacA.equals(expHmacA)){_winston2.default.error('dropped unexpected packet ('+buffer.length+' bytes) received from server: wrong HMAC-A '+buffer.slice(0,60).toString('hex'));return-1}var header=this.decrypt(encLen,false);var len=header.readUIntBE(PADDING_LEN+SEQ_LEN,4);var seq=header.readUIntBE(PADDING_LEN,SEQ_LEN);if(!this._isHandshakeDone){if(__IS_CLIENT__){this._seq=seq}this._isHandshakeDone=true;return len}if(this._seq!==seq){_winston2.default.error('dropped unexpected packet ('+buffer.length+' bytes) received from server: wrong SEQ='+seq+' expect='+this._seq);return-1}return len}},{key:'onReceived',value:function onReceived(packet){if(__IS_CLIENT__){_winston2.default.info('ClientIn(LEN='+packet.length+', SEQ='+this._seq+'): '+packet.slice(0,60).toString('hex'))}else{_winston2.default.info('ServerIn(LEN='+packet.length+', SEQ='+this._seq+'): '+packet.slice(0,60).toString('hex'))}var _packet=packet.slice(16+this._hmacLen);var hmacB=_packet.slice(-this._hmacLen);var expHmacB=this.createHmac(_packet.slice(0,-this._hmacLen));if(!hmacB.equals(expHmacB)){_winston2.default.error('dropped unexpected packet ('+packet.length+' bytes) received from '+(__IS_CLIENT__?'server':'client')+': wrong HMAC-B '+packet.slice(0,60).toString('hex'));return}var next=__IS_CLIENT__?this._bNext:this._fNext;next(this.decrypt(_packet.slice(0,-this._hmacLen)));this._seq+=1}}]);return Aead2Protocol}(_aead2.default);exports.default=Aead2Protocol;