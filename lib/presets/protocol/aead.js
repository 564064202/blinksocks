'use strict';Object.defineProperty(exports,'__esModule',{value:true});var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i['return'])_i['return']()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr)){return arr}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i)}else{throw new TypeError('Invalid attempt to destructure non-iterable instance')}}}();var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _crypto=require('crypto');var _crypto2=_interopRequireDefault(_crypto);var _interface=require('../interface');var _utils=require('../../utils');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i]}return arr2}else{return Array.from(arr)}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called')}return call&&(typeof call==='object'||typeof call==='function')?call:self}function _inherits(subClass,superClass){if(typeof superClass!=='function'&&superClass!==null){throw new TypeError('Super expression must either be null or a function, not '+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var NONCE_LEN=12;var TAG_LEN=16;var MIN_CHUNK_LEN=TAG_LEN*2+3;var MAX_DATA_LEN=16383;var ciphers=['aes-128-gcm','aes-192-gcm','aes-256-gcm'];var HKDF_HASH_ALGORITHM='sha1';function getChunks(buffer,size){var totalLen=buffer.length;var bufs=[];var ptr=0;while(ptr<totalLen-1){bufs.push(buffer.slice(ptr,ptr+size));ptr+=size}if(ptr<totalLen){bufs.push(buffer.slice(ptr))}return bufs}function hmac(key,buffer){var hmac=_crypto2.default.createHmac(HKDF_HASH_ALGORITHM,key);return hmac.update(buffer).digest()}function HKDF(salt,ikm,info,length){var prk=hmac(salt,ikm);var t=Buffer.alloc(0);var okm=Buffer.alloc(0);for(var i=0;i<Math.ceil(length/prk.length);++i){t=hmac(prk,Buffer.concat([t,info,Buffer.alloc(1,i+1)]));okm=Buffer.concat([okm,t])}return okm.slice(0,length)}var AeadProtocol=function(_IPreset){_inherits(AeadProtocol,_IPreset);function AeadProtocol(cipher,info){_classCallCheck(this,AeadProtocol);var _this=_possibleConstructorReturn(this,(AeadProtocol.__proto__||Object.getPrototypeOf(AeadProtocol)).call(this));_this._cipherName='';_this._info=null;_this._cipherKey=null;_this._decipherKey=null;_this._cipherNonce=0;_this._decipherNonce=0;_this._adBuf=null;if(typeof cipher==='undefined'||cipher===''){throw Error('\'protocol_params\' requires [cipher] parameter.')}if(!ciphers.includes(cipher)){throw Error('cipher \''+cipher+'\' is not supported.')}_this._cipherName=cipher;_this._info=Buffer.from(info);_this._adBuf=new _utils.AdvancedBuffer({getPacketLength:_this.onReceiving.bind(_this)});_this._adBuf.on('data',_this.onChunkReceived.bind(_this));return _this}_createClass(AeadProtocol,[{key:'beforeOut',value:function beforeOut(_ref){var _this2=this;var buffer=_ref.buffer;var salt=null;if(this._cipherKey===null){var size=this._cipherName.split('-')[1]/8;salt=_crypto2.default.randomBytes(size);this._cipherKey=HKDF(salt,_utils.Utils.EVP_BytesToKey(__KEY__,size,16),this._info,size)}var chunks=getChunks(buffer,MAX_DATA_LEN).map(function(chunk){var dataLen=_utils.Utils.numberToUInt(chunk.length);var _encrypt=_this2.encrypt(dataLen),_encrypt2=_slicedToArray(_encrypt,2),encLen=_encrypt2[0],lenTag=_encrypt2[1];var _encrypt3=_this2.encrypt(chunk),_encrypt4=_slicedToArray(_encrypt3,2),encData=_encrypt4[0],dataTag=_encrypt4[1];return Buffer.concat([encLen,lenTag,encData,dataTag])});if(salt){return Buffer.concat([salt].concat(_toConsumableArray(chunks)))}else{return Buffer.concat(chunks)}}},{key:'beforeIn',value:function beforeIn(_ref2){var buffer=_ref2.buffer,next=_ref2.next,fail=_ref2.fail;this._adBuf.put(buffer,{next:next,fail:fail})}},{key:'onReceiving',value:function onReceiving(buffer,_ref3){var fail=_ref3.fail;if(this._decipherKey===null){var size=this._cipherName.split('-')[1]/8;if(buffer.length<size){return}var salt=buffer.slice(0,size);this._decipherKey=HKDF(salt,_utils.Utils.EVP_BytesToKey(__KEY__,size,16),this._info,size);return buffer.slice(size)}if(buffer.length<MIN_CHUNK_LEN){return}var _ref4=[buffer.slice(0,2),buffer.slice(2,2+TAG_LEN)],encLen=_ref4[0],lenTag=_ref4[1];var dataLen=this.decrypt(encLen,lenTag);if(dataLen===null){fail('unexpected DataLen_TAG='+lenTag.toString('hex')+' when verify DataLen='+encLen.toString('hex'));return-1}return 2+TAG_LEN+dataLen.readUInt16BE(0)+TAG_LEN}},{key:'onChunkReceived',value:function onChunkReceived(chunk,_ref5){var next=_ref5.next,fail=_ref5.fail;var _ref6=[chunk.slice(2+TAG_LEN,-TAG_LEN),chunk.slice(-TAG_LEN)],encData=_ref6[0],dataTag=_ref6[1];var data=this.decrypt(encData,dataTag);if(data===null){fail('unexpected Data_TAG='+dataTag.toString('hex')+' when verify Data='+encData.slice(0,60).toString('hex'));return}next(data)}},{key:'encrypt',value:function encrypt(message){var cipher=_crypto2.default.createCipheriv(this._cipherName,this._cipherKey,_utils.Utils.numberToUInt(this._cipherNonce,NONCE_LEN,_utils.BYTE_ORDER_LE));var encrypted=Buffer.concat([cipher.update(message),cipher.final()]);var tag=cipher.getAuthTag();this._cipherNonce+=1;return[encrypted,tag]}},{key:'decrypt',value:function decrypt(ciphertext,tag){var decipher=_crypto2.default.createDecipheriv(this._cipherName,this._decipherKey,_utils.Utils.numberToUInt(this._decipherNonce,NONCE_LEN,_utils.BYTE_ORDER_LE));decipher.setAuthTag(tag);try{var decrypted=Buffer.concat([decipher.update(ciphertext),decipher.final()]);this._decipherNonce+=1;return decrypted}catch(err){return null}}}]);return AeadProtocol}(_interface.IPreset);exports.default=AeadProtocol;