'use strict';Object.defineProperty(exports,'__esModule',{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _winston=require('winston');var _winston2=_interopRequireDefault(_winston);var _interface=require('../interface');var _actions=require('../actions');var _address=require('../../core/address');var _common=require('../../proxies/common');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i]}return arr2}else{return Array.from(arr)}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called')}return call&&(typeof call==='object'||typeof call==='function')?call:self}function _inherits(subClass,superClass){if(typeof superClass!=='function'&&superClass!==null){throw new TypeError('Super expression must either be null or a function, not '+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var OriginFrame=function(_IPreset){_inherits(OriginFrame,_IPreset);function OriginFrame(address){_classCallCheck(this,OriginFrame);var _this=_possibleConstructorReturn(this,(OriginFrame.__proto__||Object.getPrototypeOf(OriginFrame)).call(this));_this._targetAddress=null;_this._isHandshakeDone=false;_this._targetAddress=address;return _this}_createClass(OriginFrame,[{key:'clientOut',value:function clientOut(_ref){var buffer=_ref.buffer;if(!this._isHandshakeDone){this._isHandshakeDone=true;return this.pack(this._targetAddress,buffer)}else{return buffer}}},{key:'serverIn',value:function serverIn(_ref2){var _this2=this;var buffer=_ref2.buffer,next=_ref2.next,broadcast=_ref2.broadcast;if(!this._isHandshakeDone){(function(){var frame=_this2.unpack(buffer);if(frame===null){throw Error('dropped unidentified packet '+buffer.length+' bytes: '+buffer.toString('hex').substr(0,60))}var ATYP=frame.ATYP,DSTADDR=frame.DSTADDR,DSTPORT=frame.DSTPORT,DATA=frame.DATA;broadcast({type:_actions.SOCKET_CONNECT_TO_DST,payload:[new _address.Address({ATYP:ATYP,DSTADDR:DSTADDR,DSTPORT:DSTPORT}),function(){next(DATA);_this2._isHandshakeDone=true}]})})()}else{return buffer}}},{key:'serverOut',value:function serverOut(_ref3){var buffer=_ref3.buffer;return buffer}},{key:'clientIn',value:function clientIn(_ref4){var buffer=_ref4.buffer;return buffer}},{key:'pack',value:function pack(address,data){var ATYP=address.ATYP,DSTADDR=address.DSTADDR,DSTPORT=address.DSTPORT;var addr=null;if(ATYP===_common.ATYP_DOMAIN){addr=[DSTADDR.length].concat(_toConsumableArray(DSTADDR))}else{addr=DSTADDR}return Buffer.from([ATYP].concat(_toConsumableArray(addr),_toConsumableArray(DSTPORT),_toConsumableArray(data)))}},{key:'unpack',value:function unpack(buffer){var _buffer=Buffer.from(buffer);if(_buffer.length<7){_winston2.default.debug('invalid length: '+_buffer.length);return null}var DSTADDR=null;var DSTPORT=null;switch(_buffer[0]){case _common.ATYP_V4:{DSTADDR=_buffer.slice(1,5);DSTPORT=_buffer.slice(5,7);break}case _common.ATYP_DOMAIN:{var domainLen=_buffer[1];if(_buffer.length<4+domainLen){_winston2.default.debug('invalid length: '+_buffer.length);return null}DSTADDR=_buffer.slice(2,2+domainLen);DSTPORT=_buffer.slice(2+domainLen,4+domainLen);break}default:_winston2.default.debug('unknown ATYP: '+_buffer[0]);return null;}return{ATYP:_buffer[0],DSTADDR:DSTADDR,DSTPORT:DSTPORT,DATA:_buffer.slice(DSTADDR.length+(_buffer[0]===_common.ATYP_DOMAIN?4:3)),toBuffer:function toBuffer(){return Buffer.from([this.ATYP].concat(_toConsumableArray(this.DSTADDR),_toConsumableArray(this.DSTPORT),_toConsumableArray(this.DATA)))}}}}]);return OriginFrame}(_interface.IPreset);exports.default=OriginFrame;