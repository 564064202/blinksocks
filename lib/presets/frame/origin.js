'use strict';Object.defineProperty(exports,'__esModule',{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _net=require('net');var _net2=_interopRequireDefault(_net);var _ip=require('ip');var _ip2=_interopRequireDefault(_ip);var _winston=require('winston');var _winston2=_interopRequireDefault(_winston);var _interface=require('../interface');var _actions=require('../actions');var _utils=require('../../utils');var _common=require('../../proxies/common');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i]}return arr2}else{return Array.from(arr)}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called')}return call&&(typeof call==='object'||typeof call==='function')?call:self}function _inherits(subClass,superClass){if(typeof superClass!=='function'&&superClass!==null){throw new TypeError('Super expression must either be null or a function, not '+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var OriginFrame=function(_IPreset){_inherits(OriginFrame,_IPreset);function OriginFrame(addr){_classCallCheck(this,OriginFrame);var _this=_possibleConstructorReturn(this,(OriginFrame.__proto__||Object.getPrototypeOf(OriginFrame)).call(this));_this._isHandshakeDone=false;_this._atyp=_common.ATYP_V4;_this._addr=null;_this._port=null;if(__IS_CLIENT__){var type=addr.type,host=addr.host,port=addr.port;_this._atyp=type;_this._addr=_net2.default.isIP(host)?_ip2.default.toBuffer(host):Buffer.from(host);_this._port=port instanceof Buffer?port:_utils.Utils.numberToUIntBE(port)}return _this}_createClass(OriginFrame,[{key:'clientOut',value:function clientOut(_ref){var buffer=_ref.buffer;if(!this._isHandshakeDone){this._isHandshakeDone=true;return Buffer.from([this._atyp].concat(_toConsumableArray(this._atyp===_common.ATYP_DOMAIN?_utils.Utils.numberToUIntBE(this._addr.length,1):[]),_toConsumableArray(this._addr),_toConsumableArray(this._port),_toConsumableArray(buffer)))}else{return buffer}}},{key:'serverIn',value:function serverIn(_ref2){var _this2=this;var buffer=_ref2.buffer,next=_ref2.next,broadcast=_ref2.broadcast;if(!this._isHandshakeDone){if(buffer.length<7){_winston2.default.error('invalid length: '+buffer.length);return}var atyp=buffer[0];if(![_common.ATYP_DOMAIN,_common.ATYP_V4,_common.ATYP_V6].includes(atyp)){_winston2.default.error('invalid atyp: '+atyp);return}var addr=void 0,port=void 0;var offset=3;switch(atyp){case _common.ATYP_V4:addr=_ip2.default.toString(buffer.slice(1,5));port=buffer.slice(5,7).readUInt16BE(0);offset+=4;break;case _common.ATYP_V6:if(buffer.length<19){_winston2.default.error('invalid length: '+buffer.length);return}addr=_ip2.default.toString(buffer.slice(1,16));port=buffer.slice(16,18).readUInt16BE(0);offset+=16;break;case _common.ATYP_DOMAIN:var domainLen=buffer[1];if(buffer.length<domainLen+4){_winston2.default.error('invalid length: '+buffer.length);return}addr=buffer.slice(2,2+domainLen).toString();port=buffer.slice(2+domainLen,4+domainLen).readUInt16BE(0);offset+=domainLen+1;break;default:_winston2.default.error('invalid atyp: '+atyp);return;}broadcast({type:_actions.SOCKET_CONNECT_TO_DST,payload:[{type:atyp,host:addr,port:port},function(){next(buffer.slice(offset));_this2._isHandshakeDone=true}]})}else{return buffer}}},{key:'serverOut',value:function serverOut(_ref3){var buffer=_ref3.buffer;return buffer}},{key:'clientIn',value:function clientIn(_ref4){var buffer=_ref4.buffer;return buffer}}]);return OriginFrame}(_interface.IPreset);exports.default=OriginFrame;