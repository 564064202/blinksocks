'use strict';Object.defineProperty(exports,'__esModule',{value:true});exports.Hub=undefined;var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _net=require('net');var _net2=_interopRequireDefault(_net);var _log4js=require('log4js');var _log4js2=_interopRequireDefault(_log4js);var _Config=require('../Config');var _Socket=require('../Socket');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}var Logger=_log4js2.default.getLogger('Hub');var nextId=function(){var i=0;return function(){return++i}}();var Hub=exports.Hub=function(){// instances of class Socket
function Hub(config){_classCallCheck(this,Hub);this._hub=null;this._sockets=[];try{_Config.Config.init(config)}catch(err){Logger.fatal(err);process.exit(-1)}Logger.setLevel(_Config.Config.log_level);this._hub=_net2.default.createServer();this._hub.on('error',this.onError.bind(this));this._hub.on('close',this.onClose.bind(this));this._hub.on('connection',this.onConnect.bind(this))}// instance of class net.Server
_createClass(Hub,[{key:'onError',value:function onError(err){Logger.error(err)}},{key:'onClose',value:function onClose(){Logger.info('server shutdown');this.cleanUp()}},{key:'onConnect',value:function onConnect(socket){var _socket=new _Socket.Socket({id:nextId(),socket:socket});this._sockets.push(_socket)}},{key:'cleanUp',value:function cleanUp(){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this._sockets[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var socket=_step.value;if(!socket.destroy&&typeof socket.end==='function'){socket.end()}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}}},{key:'run',value:function run(){var _this=this;var _ref=[_Config.Config.host,_Config.Config.port],host=_ref[0],port=_ref[1];var options={host:host,port:port,backlog:511};this._hub.listen(options,function(){Logger.info('opened hub on:',_this._hub.address())})}},{key:'stop',value:function stop(){var _this2=this;return new Promise(function(resolve){_this2._hub.close(resolve)})}}]);return Hub}();