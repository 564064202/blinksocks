'use strict';Object.defineProperty(exports,'__esModule',{value:true});exports.Frame=undefined;var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}return target};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _log4js=require('log4js');var _log4js2=_interopRequireDefault(_log4js);var _Config=require('../Config');var _Constants=require('../../socks5/Constants');var _Message2=require('../../socks5/Message');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i]}return arr2}else{return Array.from(arr)}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called')}return call&&(typeof call==='object'||typeof call==='function')?call:self}function _inherits(subClass,superClass){if(typeof superClass!=='function'&&superClass!==null){throw new TypeError('Super expression must either be null or a function, not '+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var Logger=_log4js2.default.getLogger('Frame');// +------+------+----------+----------+----------+
// | LEN  | ATYP | DST.ADDR | DST.PORT |   DATA   |
// +------+------+----------+----------+----------+
// |  2   |  1   | Variable |    2     | Variable |
// +------+------+----------+----------+----------+
var Frame=exports.Frame=function(_Message){_inherits(Frame,_Message);function Frame(){var options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};_classCallCheck(this,Frame);var _this=_possibleConstructorReturn(this,(Frame.__proto__||Object.getPrototypeOf(Frame)).call(this));var fields=_extends({LEN:[_Constants.NOOP,_Constants.NOOP],ATYP:_Constants.ATYP_V4,DSTADDR:[_Constants.NOOP,_Constants.NOOP,_Constants.NOOP,_Constants.NOOP],DSTPORT:[_Constants.NOOP,_Constants.NOOP],DATA:[]},options);_this.LEN=fields.LEN;_this.ATYP=fields.ATYP;_this.DSTADDR=fields.DSTADDR;_this.DSTPORT=fields.DSTPORT;_this.DATA=fields.DATA;return _this}// TODO: strict check the received buffer, for security
_createClass(Frame,[{key:'toBuffer',value:function toBuffer(){return Buffer.from([].concat(_toConsumableArray(this.LEN),[this.ATYP],_toConsumableArray(this.DSTADDR),_toConsumableArray(this.DSTPORT),_toConsumableArray(this.DATA)))}}],[{key:'parse',value:function parse(buffer){Logger.setLevel(_Config.Config.log_level);var _buffer=Buffer.from(buffer);if(_buffer.length<9){Logger.debug('invalid length: '+_buffer.length);return null}if(_buffer.length!==_buffer.readUInt16BE(0)){Logger.debug('invalid length: '+_buffer.length+', expect: '+_buffer.readUInt16BE(0));return null}var DSTADDR=null;var DSTPORT=null;switch(_buffer[2]){case _Constants.ATYP_V4:{DSTADDR=_buffer.slice(3,7);DSTPORT=_buffer.slice(7,9);break}case _Constants.ATYP_V6:{if(_buffer.length<21){Logger.debug('invalid length: '+_buffer.length);return null}DSTADDR=_buffer.slice(2,19);DSTPORT=_buffer.slice(19,21);break}case _Constants.ATYP_DOMAIN:{var domainLen=_buffer[3];if(_buffer.length<6+domainLen){Logger.debug('invalid length: '+_buffer.length);return null}DSTADDR=_buffer.slice(4,4+_buffer[3]);DSTPORT=_buffer.slice(4+_buffer[3],6+_buffer[3]);break}default:Logger.debug('unknown ATYP: '+_buffer[2]);return null;}return new Frame({LEN:_buffer.readUInt16BE(0),ATYP:_buffer[2],DSTADDR:DSTADDR,DSTPORT:DSTPORT,DATA:_buffer.slice(DSTADDR.length+(_buffer[2]===_Constants.ATYP_DOMAIN?6:5))})}}]);return Frame}(_Message2.Message);