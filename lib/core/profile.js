'use strict';Object.defineProperty(exports,'__esModule',{value:true});exports.Profile=undefined;var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _fs=require('fs');var _fs2=_interopRequireDefault(_fs);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}var PROFILE_SAMPLE_INTERVAL=1;var now=function now(){return new Date().getTime()};var Profile=exports.Profile=function(){function Profile(){_classCallCheck(this,Profile)}_createClass(Profile,null,[{key:'start',value:function start(){var _this=this;this._timer=setInterval(function(){_this._outSpeed=_this._tmpOut/PROFILE_SAMPLE_INTERVAL;_this._inSpeed=_this._tmpIn/PROFILE_SAMPLE_INTERVAL;_this._maxOutSpeed=Math.max(_this._maxOutSpeed,_this._outSpeed);_this._maxInSpeed=Math.max(_this._maxInSpeed,_this._inSpeed);_this._tmpOut=0;_this._tmpIn=0},PROFILE_SAMPLE_INTERVAL*1e3)}},{key:'stop',value:function stop(){clearInterval(this._timer)}},{key:'snapshot',value:function snapshot(){var endTime=now();var duration=(endTime-this._startTime)/1e3;var totalPackets=this._totalInPackets+this._totalOutPackets;var totalBytes=this._totalIn+this._totalOut;return{sample:{from:this._startTime,to:endTime,duration:endTime-this._startTime},instance:{outSpeed:this._outSpeed,inSpeed:this._inSpeed,connections:this._connections,errors:this._errors,fatals:this._fatals,totalOut:this._totalOut,totalIn:this._totalIn,totalOutPackets:this._totalOutPackets,totalInPackets:this._totalInPackets,totalBytes:totalBytes,totalPackets:totalPackets,errorRate:this._errors?this._errors/totalPackets:0,fatalRate:this._fatals?this._fatals/totalPackets:0,outBytesRate:this._totalOut/duration,outPacketsRate:this._totalOutPackets/duration,inBytesRate:this._totalIn/duration,inPacketsRate:this._totalInPackets/duration,totalBytesRate:totalBytes/duration,totalPacketsRate:totalPackets/duration},summary:{maxOutSpeed:this._maxOutSpeed,maxInSpeed:this._maxInSpeed,maxConnections:this._maxConnections},node:{upTime:process.uptime(),cpu:process.cpuUsage(),memory:process.memoryUsage()}}}},{key:'save',value:function save(){var dt=new Date;var postfix=dt.getFullYear()+'-'+(dt.getMonth()+1)+'-'+dt.getDate();var data=JSON.stringify(this.snapshot(),null,'  ');_fs2.default.writeFileSync('blinksocks.profile-'+postfix+'.log',data)}},{key:'connections',set:function set(value){this._connections=value;this._maxConnections=Math.max(this._maxConnections,this._connections)},get:function get(){return this._connections}},{key:'fatals',set:function set(value){this._fatals=value},get:function get(){return this._fatals}},{key:'errors',set:function set(value){this._errors=value},get:function get(){return this._errors}},{key:'totalOut',set:function set(value){this._totalOut=value;this._totalOutPackets+=1;this._tmpOut+=value},get:function get(){return this._totalOut}},{key:'totalIn',set:function set(value){this._totalIn=value;this._totalInPackets+=1;this._tmpIn+=value},get:function get(){return this._totalIn}}]);return Profile}();Profile._startTime=now();Profile._timer=null;Profile._tmpOut=0;Profile._outSpeed=0;Profile._maxOutSpeed=0;Profile._tmpIn=0;Profile._inSpeed=0;Profile._maxInSpeed=0;Profile._connections=0;Profile._maxConnections=0;Profile._fatals=0;Profile._errors=0;Profile._totalOut=0;Profile._totalOutPackets=0;Profile._totalIn=0;Profile._totalInPackets=0;