'use strict';Object.defineProperty(exports,'__esModule',{value:true});exports.Middleware=undefined;var _events=require('events');var _events2=_interopRequireDefault(_events);var _presets=require('../presets');var _constants=require('../constants');var _utils=require('../utils');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}const staticPresetCache=new Map;function createPreset(name,params={}){const ImplClass=(0,_presets.getPresetClassByName)(name);const createOne=()=>{ImplClass.checkParams(params);ImplClass.onInit(params);return new ImplClass(params)};let preset=null;if(_presets.IPresetStatic.isPrototypeOf(ImplClass)){preset=staticPresetCache.get(ImplClass.name);if(preset===undefined){preset=createOne();staticPresetCache.set(ImplClass.name,preset)}}else{preset=createOne()}return preset}class Middleware extends _events2.default{constructor(preset){super();this._impl=null;this.onPresetNext=this.onPresetNext.bind(this);this.onPresetBroadcast=this.onPresetBroadcast.bind(this);this.onPresetFail=this.onPresetFail.bind(this);this._impl=createPreset(preset.name,preset.params||{});this._impl.next=this.onPresetNext;this._impl.broadcast=this.onPresetBroadcast;this._impl.fail=this.onPresetFail}get name(){return this._impl.getName()||(0,_utils.kebabCase)(this._impl.constructor.name).replace(/(.*)-preset/i,'$1')}getImplement(){return this._impl}hasListener(event){return this.listenerCount(event)>0}notify(action){return this._impl.onNotified(action)}onPresetNext(direction,buffer){this.emit(`next_${direction}`,buffer)}onPresetBroadcast(action){this.emit('broadcast',this.name,action)}onPresetFail(message){this.emit('fail',this.name,message)}onDestroy(){if(!(this._impl instanceof _presets.IPresetStatic)){this._impl.onDestroy()}this.removeAllListeners()}write({direction,buffer,direct,isUdp},extraArgs){const type=(direction===_constants.PIPE_ENCODE?'Out':'In')+(isUdp?'Udp':'');const broadcast=this.onPresetBroadcast;const fail=this.onPresetFail;const next=(processed,isReverse=false)=>{const hasListener=this.emit(`next_${isReverse?-direction:direction}`,processed);if(!hasListener){direct(processed,isReverse)}};const nextLifeCycleHook=(buf)=>{const args={buffer:buf,next,broadcast,direct,fail};const ret=__IS_CLIENT__?this._impl[`client${type}`](args,extraArgs):this._impl[`server${type}`](args,extraArgs);if(ret instanceof Buffer){next(ret)}};const args={buffer,next:nextLifeCycleHook,broadcast,direct,fail};const ret=this._impl[`before${type}`](args,extraArgs);if(ret instanceof Buffer){nextLifeCycleHook(ret)}}}exports.Middleware=Middleware;