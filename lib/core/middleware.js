'use strict';Object.defineProperty(exports,'__esModule',{value:true});exports.Middleware=exports.MIDDLEWARE_DIRECTION_DOWNWARD=exports.MIDDLEWARE_DIRECTION_UPWARD=undefined;exports.createMiddleware=createMiddleware;var _events=require('events');var _events2=_interopRequireDefault(_events);var _winston=require('winston');var _winston2=_interopRequireDefault(_winston);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}const MIDDLEWARE_DIRECTION_UPWARD=exports.MIDDLEWARE_DIRECTION_UPWARD=1;const MIDDLEWARE_DIRECTION_DOWNWARD=exports.MIDDLEWARE_DIRECTION_DOWNWARD=-1;class Middleware extends _events2.default{constructor(impl){super();this._broadcast=null;this._impl=null;this._impl=impl}subscribe(receiver){this._broadcast=receiver}onNotified(action){return this._impl.onNotified(action)}write(direction,{buffer,direct,fail}){const type={[MIDDLEWARE_DIRECTION_UPWARD]:'Out',[MIDDLEWARE_DIRECTION_DOWNWARD]:'In'}[direction];const broadcast=this._broadcast;const next=buf=>{const args={buffer:buf,next:processed=>this.emit(`next_${direction}`,processed),broadcast,direct,fail};const ret=__IS_CLIENT__?this._impl[`client${type}`](args):this._impl[`server${type}`](args);if(typeof ret!=='undefined'){args.next(ret)}};const r=this._impl[`before${type}`]({buffer,next,broadcast,direct,fail});if(typeof r!=='undefined'){next(r)}}}exports.Middleware=Middleware;function createMiddleware(name,params={}){try{const ImplClass=require(`../presets/${name}`).default;const impl=new ImplClass(params);checkMiddleware(ImplClass.name,impl);return new Middleware(impl)}catch(err){_winston2.default.error(err.message);process.exit(-1)}return null}function checkMiddleware(name,impl){const requiredMethods=['clientOut','serverIn','serverOut','clientIn'];if(requiredMethods.some(method=>typeof impl[method]!=='function')){throw Error(`all methods [${requiredMethods.toString()}] in ${name} must be implemented`)}return true}