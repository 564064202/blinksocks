'use strict';Object.defineProperty(exports,'__esModule',{value:true});exports.Middleware=exports.PIPE_DECODE=exports.PIPE_ENCODE=undefined;exports.cleanup=cleanup;exports.reset=reset;var _events=require('events');var _events2=_interopRequireDefault(_events);var _presets=require('../presets');var _utils=require('../utils');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}let presetCache={};function getInstanceFromCache(ImplClass,params){let impl=presetCache[ImplClass.name];if(impl===undefined){ImplClass.checkParams(params);ImplClass.onInit(params);impl=new ImplClass(params);presetCache[ImplClass.name]=impl}return impl}function createPreset(name,params={}){const ImplClass=(0,_presets.getPresetClassByName)(name);let preset=null;if(ImplClass.__proto__.name===_presets.IPresetStatic.name){preset=getInstanceFromCache(ImplClass,params)}else{if(!ImplClass.initialized){ImplClass.checkParams(params);ImplClass.onInit(params);ImplClass.initialized=true}preset=new ImplClass(params)}return preset}const PIPE_ENCODE=exports.PIPE_ENCODE=1;const PIPE_DECODE=exports.PIPE_DECODE=-1;class Middleware extends _events2.default{constructor(preset){super();this._impl=null;this.onPresetNext=this.onPresetNext.bind(this);this.onPresetBroadcast=this.onPresetBroadcast.bind(this);this.onPresetFail=this.onPresetFail.bind(this);this._impl=createPreset(preset.name,preset.params||{});this._impl.next=this.onPresetNext;this._impl.broadcast=this.onPresetBroadcast;this._impl.fail=this.onPresetFail}get name(){return this._impl.getName()||(0,_utils.kebabCase)(this._impl.constructor.name).replace(/(.*)-preset/i,'$1')}getImplement(){return this._impl}hasListener(event){return this.listenerCount(event)>0}notify(action){return this._impl.onNotified(action)}onPresetNext(direction,buffer){this.emit(`next_${direction}`,buffer)}onPresetBroadcast(action){this.emit('broadcast',this.name,action)}onPresetFail(message){this.emit('fail',this.name,message)}onDestroy(){if(!(this._impl instanceof _presets.IPresetStatic)){this._impl.onDestroy()}this.removeAllListeners()}write({direction,buffer,direct,isUdp}){const type=(direction===PIPE_ENCODE?'Out':'In')+(isUdp?'Udp':'');const broadcast=this.onPresetBroadcast;const fail=this.onPresetFail;const next=(processed,isReverse=false)=>{const hasListener=this.emit(`next_${isReverse?-direction:direction}`,processed);if(!hasListener){direct(processed,isReverse)}};const nextLifeCycleHook=(buf)=>{const args={buffer:buf,next,broadcast,direct,fail};const ret=__IS_CLIENT__?this._impl[`client${type}`](args):this._impl[`server${type}`](args);if(ret instanceof Buffer){next(ret)}};const args={buffer,next:nextLifeCycleHook,broadcast,direct,fail};const ret=this._impl[`before${type}`](args);if(ret instanceof Buffer){nextLifeCycleHook(ret)}}}exports.Middleware=Middleware;function cleanup(){const classNames=Object.keys(presetCache);var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=classNames[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){const className=_step.value;presetCache[className].onDestroy()}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}}function reset(){presetCache={};__PRESETS__.map(({name})=>(0,_presets.getPresetClassByName)(name)).forEach(ImplClass=>ImplClass.initialized=false)}