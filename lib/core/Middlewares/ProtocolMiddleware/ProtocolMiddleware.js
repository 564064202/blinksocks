'use strict';Object.defineProperty(exports,'__esModule',{value:true});exports.ProtocolMiddleware=undefined;var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _Interface=require('../Interface');var _utils=require('../../../utils');function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called')}return call&&(typeof call==='object'||typeof call==='function')?call:self}function _inherits(subClass,superClass){if(typeof superClass!=='function'&&superClass!==null){throw new TypeError('Super expression must either be null or a function, not '+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}/* eslint-disable no-undef */var Logger=require('../../../utils/logger')(__filename);// NOTE: This middleware will add two bytes (indicates the total length of the packet)
// at the beginning of payload when upstream.
//
// +-----+----------------+
// | LEN |    PAYLOAD     |
// +-----+----------------+
// |  2  |    Variable    |
// +-----+----------------+
var ProtocolMiddleware=exports.ProtocolMiddleware=function(_IMiddleware){_inherits(ProtocolMiddleware,_IMiddleware);function ProtocolMiddleware(props){_classCallCheck(this,ProtocolMiddleware);var _this=_possibleConstructorReturn(this,(ProtocolMiddleware.__proto__||Object.getPrototypeOf(ProtocolMiddleware)).call(this,props));_this._impl=null;_this._direction=null;_this._onNotify=null;_this._direction=props.direction;try{var ProtocolImplClass=require('../../../presets/protocols/'+__PROTOCOL__).default;var impl=new ProtocolImplClass;if((0,_Interface.checkMiddleware)(__PROTOCOL__,impl)){_this._impl=impl}}catch(err){Logger.fatal(err.message);process.exit(-1)}return _this}_createClass(ProtocolMiddleware,[{key:'subscribe',value:function subscribe(notifier){this._onNotify=notifier}},{key:'write',value:function write(buffer){var _this2=this;return new Promise(function(next){var direction=_this2._direction;var onNotify=_this2._onNotify;var args=[buffer,next,onNotify];var ret=null;if(__IS_CLIENT__&&direction===_Interface.MIDDLEWARE_DIRECTION_UPWARD){var _impl;ret=(_impl=_this2._impl).forwardToServer.apply(_impl,args)}if(__IS_CLIENT__&&direction===_Interface.MIDDLEWARE_DIRECTION_DOWNWARD){var _impl2;args[0]=args[0].slice(2);ret=(_impl2=_this2._impl).backwardToApplication.apply(_impl2,args)}if(__IS_SERVER__&&direction===_Interface.MIDDLEWARE_DIRECTION_UPWARD){var _impl3;ret=(_impl3=_this2._impl).backwardToClient.apply(_impl3,args)}if(__IS_SERVER__&&direction===_Interface.MIDDLEWARE_DIRECTION_DOWNWARD){var _impl4;args[0]=args[0].slice(2);ret=(_impl4=_this2._impl).forwardToDst.apply(_impl4,args)}if(ret!==null&&typeof ret!=='undefined'){if(direction===_Interface.MIDDLEWARE_DIRECTION_UPWARD){next(Buffer.concat([/* LEN: */Buffer.from(_utils.Utils.numberToArray(2+ret.length)),ret]))}else{next(ret)}}})}}]);return ProtocolMiddleware}(_Interface.IMiddleware);