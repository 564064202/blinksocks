'use strict';Object.defineProperty(exports,'__esModule',{value:true});exports.Relay=undefined;var _events=require('events');var _events2=_interopRequireDefault(_events);var _core=require('../core');var _presets=require('../presets');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}class Relay extends _events2.default{constructor({context,Inbound,Outbound}){super();this._inbound=null;this._outbound=null;this._pipe=null;this._presets=[];this.setPresets=this.setPresets.bind(this);this.onBroadcast=this.onBroadcast.bind(this);this.sendForward=this.sendForward.bind(this);this.sendBackward=this.sendBackward.bind(this);let presets=__PRESETS__;if(__IS_CLIENT__&&!['proxy','tunnel'].includes(presets[0].name)){presets=[{name:'proxy'}].concat(presets)}if(presets[presets.length-1].name!=='tracker'){presets=presets.concat([{name:'tracker'}])}this._presets=presets;this._pipe=this.createPipe(presets);this._inbound=new Inbound({context:context,pipe:this._pipe});this._outbound=new Outbound({inbound:this._inbound,pipe:this._pipe});this._outbound.setPresets=this.setPresets;this._inbound.setPresets=this.setPresets;this._inbound.setOutbound(this._outbound);this._inbound.on('close',()=>this.emit('close'));this._pipe.broadcast('pipe',{type:_presets.CONNECTION_CREATED,payload:{host:context.remoteAddress,port:context.remotePort}})}onBroadcast(action){this._inbound.onBroadcast(action);this._outbound.onBroadcast(action)}sendForward(buffer){if(__IS_CLIENT__){this._outbound.write(buffer)}else{this._inbound.write(buffer)}}sendBackward(buffer){if(__IS_CLIENT__){this._inbound.write(buffer)}else{this._outbound.write(buffer)}}setPresets(callback){this._presets=callback(this._presets);this._pipe.destroy();this._pipe=this.createPipe(this._presets);this._inbound._pipe=this._pipe;this._outbound._pipe=this._pipe}createPipe(presets){const middlewares=presets.map(preset=>(0,_core.createMiddleware)(preset.name,preset.params||{}));const pipe=new _core.Pipe;pipe.on('broadcast',this.onBroadcast.bind(this));pipe.on(`next_${_core.MIDDLEWARE_DIRECTION_UPWARD}`,this.sendForward);pipe.on(`next_${_core.MIDDLEWARE_DIRECTION_DOWNWARD}`,this.sendBackward);pipe.setMiddlewares(middlewares);return pipe}destroy(){this._pipe.destroy();this._inbound.destroy();this._outbound.destroy();this._pipe=null;this._inbound=null;this._outbound=null;this._presets=null}}exports.Relay=Relay;