'use strict';Object.defineProperty(exports,'__esModule',{value:true});exports.Relay=undefined;var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i['return'])_i['return']()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr)){return arr}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i)}else{throw new TypeError('Invalid attempt to destructure non-iterable instance')}}}();exports.createRelay=createRelay;var _events=require('events');var _events2=_interopRequireDefault(_events);var _lodash=require('lodash.uniqueid');var _lodash2=_interopRequireDefault(_lodash);var _pipe=require('./pipe');var _middleware=require('./middleware');var _presets=require('../presets');var _transports=require('../transports');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function preparePresets(){let presets=__PRESETS__;if(presets[presets.length-1].name!=='tracker'){presets=presets.concat([{'name':'tracker'}])}return presets}class Relay extends _events2.default{constructor({transport,context,Inbound,Outbound,proxyRequest=null}){super();this._inbound=null;this._outbound=null;this._transport=null;this._pipe=null;this._presets=[];this.setPresets=this.setPresets.bind(this);this.onBroadcast=this.onBroadcast.bind(this);this.postPipeForward=this.postPipeForward.bind(this);this.postPipeBackward=this.postPipeBackward.bind(this);this._transport=transport;this._presets=preparePresets();this._pipe=this.createPipe(this._presets);this._inbound=new Inbound({context:context,pipe:this._pipe});this._outbound=new Outbound({inbound:this._inbound,pipe:this._pipe});this._outbound.setPresets=this.setPresets;this._inbound.setPresets=this.setPresets;this._inbound.setOutbound(this._outbound);this._inbound.on('close',()=>this.emit('close'));this._pipe.broadcast('pipe',{type:_presets.CONNECTION_CREATED,payload:{host:context.remoteAddress,port:context.remotePort}});if(__IS_CLIENT__&&proxyRequest!==null){this._pipe.broadcast(null,{type:_presets.CONNECT_TO_REMOTE,payload:proxyRequest})}}onBroadcast(action){this._inbound.onBroadcast(action);this._outbound.onBroadcast(action)}postPipeForward(buffer){if(__IS_CLIENT__){this._outbound.write(buffer)}else{this._inbound.write(buffer)}}postPipeBackward(buffer){if(__IS_CLIENT__){this._inbound.write(buffer)}else{this._outbound.write(buffer)}}setPresets(callback){this._presets=callback(this._presets);this._pipe.destroy();this._pipe=this.createPipe(this._presets);this._inbound._pipe=this._pipe;this._outbound._pipe=this._pipe}createPipe(presets){const pipe=new _pipe.Pipe({presets,isUdp:this._transport==='udp'});pipe.on('broadcast',this.onBroadcast.bind(this));pipe.on(`post_${_middleware.PIPE_ENCODE}`,this.postPipeForward);pipe.on(`post_${_middleware.PIPE_DECODE}`,this.postPipeBackward);return pipe}destroy(){this._pipe&&this._pipe.destroy();this._inbound&&this._inbound.destroy();this._outbound&&this._outbound.destroy();this._pipe=null;this._inbound=null;this._outbound=null;this._presets=null}}exports.Relay=Relay;const mapping={'tcp':[_transports.TcpInbound,_transports.TcpOutbound],'udp':[_transports.UdpInbound,_transports.UdpOutbound],'tls':[_transports.TlsInbound,_transports.TlsOutbound],'ws':[_transports.WsInbound,_transports.WsOutbound]};function createRelay(transport,context,proxyRequest=null){let Inbound=null;let Outbound=null;if(transport==='udp'){Inbound=_transports.UdpInbound;Outbound=_transports.UdpOutbound}else{var _ref=__IS_CLIENT__?[_transports.TcpInbound,mapping[transport][1]]:[mapping[transport][0],_transports.TcpOutbound];var _ref2=_slicedToArray(_ref,2);Inbound=_ref2[0];Outbound=_ref2[1]}const props={transport,context,Inbound,Outbound,proxyRequest};const relay=new Relay(props);relay.id=(0,_lodash2.default)(`${transport}_`);return relay}