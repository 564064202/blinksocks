'use strict';Object.defineProperty(exports,'__esModule',{value:true});exports.Pipe=undefined;var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _events=require('events');var _events2=_interopRequireDefault(_events);var _middleware=require('./middleware');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called')}return call&&(typeof call==='object'||typeof call==='function')?call:self}function _inherits(subClass,superClass){if(typeof superClass!=='function'&&superClass!==null){throw new TypeError('Super expression must either be null or a function, not '+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var Pipe=exports.Pipe=function(_EventEmitter){_inherits(Pipe,_EventEmitter);function Pipe(){var props=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};_classCallCheck(this,Pipe);var _this=_possibleConstructorReturn(this,(Pipe.__proto__||Object.getPrototypeOf(Pipe)).call(this));_this._upstream_middlewares=[];_this._downstream_middlewares=[];_this._onNotified=function(){return 0};_this._onNotified=typeof props.onNotified==='undefined'?function(){return 0}:props.onNotified;_this.onBroadcast=_this.onBroadcast.bind(_this);return _this}_createClass(Pipe,[{key:'onBroadcast',value:function onBroadcast(direction,action){var middlewares=this._getMiddlewares(direction);var results=[];var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=middlewares[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var middleware=_step.value;results.push(middleware.onNotified(action))}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}if(results.every(function(result){return!!result===false})){this._onNotified(action)}}},{key:'setMiddlewares',value:function setMiddlewares(direction,middlewares){var _this2=this;var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=middlewares[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var middleware=_step2.value;middleware.setMaxListeners(2);middleware.subscribe(function(action){return _this2.onBroadcast(direction,action)})}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}if(direction===_middleware.MIDDLEWARE_DIRECTION_UPWARD){this._upstream_middlewares=middlewares;this._downstream_middlewares=[].concat(middlewares).reverse()}else{this._downstream_middlewares=middlewares;this._upstream_middlewares=[].concat(middlewares).reverse()}}},{key:'feed',value:function feed(direction,buffer){var _this3=this;var eventName='next_'+direction;var middlewares=this._getMiddlewares(direction);var last=middlewares.reduce(function(prev,next){if(prev.listenerCount(eventName)<1){prev.on(eventName,function(buf){return next.write(direction,buf)})}return next});if(last.listenerCount(eventName)<1){last.on(eventName,function(buf){return _this3.emit(eventName,buf)})}middlewares[0].write(direction,buffer)}},{key:'_getMiddlewares',value:function _getMiddlewares(direction){var _MIDDLEWARE_DIRECTION;return(_MIDDLEWARE_DIRECTION={},_defineProperty(_MIDDLEWARE_DIRECTION,_middleware.MIDDLEWARE_DIRECTION_UPWARD,this._upstream_middlewares),_defineProperty(_MIDDLEWARE_DIRECTION,_middleware.MIDDLEWARE_DIRECTION_DOWNWARD,this._downstream_middlewares),_MIDDLEWARE_DIRECTION)[direction]}}]);return Pipe}(_events2.default);