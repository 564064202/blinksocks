'use strict';Object.defineProperty(exports,'__esModule',{value:true});exports.Pipe=undefined;var _events=require('events');var _events2=_interopRequireDefault(_events);var _middleware=require('./middleware');var _constants=require('../constants');var _defs=require('../presets/defs');var _utils=require('../utils');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}class Pipe extends _events2.default{get destroyed(){return this._destroyed}get presets(){return this._presets}constructor({config,presets,isUdp=false}){super();this._upstream_middlewares=[];this._downstream_middlewares=[];this._isPipingUdp=false;this._cacheBuffer=null;this._destroyed=false;this._presets=null;this._config=null;this.broadcast=this.broadcast.bind(this);this.onReadProperty=this.onReadProperty.bind(this);this._config=config;this._isPipingUdp=isUdp;this.createMiddlewares(presets)}broadcast(name,action){const middlewares=this.getMiddlewares();const results=[];var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=middlewares[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){const middleware=_step.value;if(middleware.name!==name){results.push(middleware.notify(action))}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}if(name!=='pipe'&&results.every(result=>!!result===false)){this.emit('broadcast',action)}}onReadProperty(name,presetName,propertyName){const middlewares=this.getMiddlewares();const ms=middlewares.find(m=>m.name===presetName);if(ms){const impl=ms.getImplement();const value=impl[propertyName];return value!==undefined?value:impl.constructor[propertyName]}else{_utils.logger.warn(`[preset] "${name}" cannot read property from nonexistent preset "${presetName}".`)}}createMiddlewares(presets){const middlewares=presets.map((preset,i)=>this._createMiddleware(preset,i));this._upstream_middlewares=middlewares;this._downstream_middlewares=[].concat(middlewares).reverse();this._presets=presets}getMiddlewares(direction=_constants.PIPE_ENCODE){if(direction===_constants.PIPE_ENCODE){return this._upstream_middlewares||[]}else{return this._downstream_middlewares||[]}}updateMiddlewares(presets){const mdIndex={};var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=this.getMiddlewares()[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){const md=_step2.value;mdIndex[md.name]=md}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}const middlewares=[];for(let i=0;i<presets.length;i++){const preset=presets[i];let md=mdIndex[preset.name];if(md){md.removeAllListeners();this._attachEvents(md);delete mdIndex[preset.name]}else{md=this._createMiddleware(preset,i)}middlewares.push(md)}Object.keys(mdIndex).forEach(key=>mdIndex[key].onDestroy());this._upstream_middlewares=middlewares;this._downstream_middlewares=[].concat(middlewares).reverse();this._presets=presets}feed(direction,buffer,extraArgs){try{this._cacheBuffer=buffer;const preEventName=`pre_${direction}`;if(this.listenerCount(preEventName)>0){this.emit(preEventName,buffer,buf=>this._feed(direction,buf,extraArgs))}else{this._feed(direction,buffer,extraArgs)}}catch(err){_utils.logger.error('[pipe] error occurred while piping:',err)}}destroy(){if(this._destroyed){return}const middlewares=this.getMiddlewares();var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=middlewares[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){const middleware=_step3.value;middleware.onDestroy()}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally{if(_didIteratorError3){throw _iteratorError3}}}this._upstream_middlewares=null;this._downstream_middlewares=null;this._presets=null;this._cacheBuffer=null;this._destroyed=true;this.removeAllListeners()}_createMiddleware(preset,index){const middleware=new _middleware.Middleware({config:this._config,preset});this._attachEvents(middleware);const impl=middleware.getImplement();impl.readProperty=(...args)=>this.onReadProperty(middleware.name,...args);impl.getStore=()=>this._config.stores[index];return middleware}_attachEvents(middleware){middleware.setMaxListeners(4);middleware.on('broadcast',this.broadcast);middleware.on('fail',(name,message)=>void this.broadcast(name,{type:_defs.PRESET_FAILED,payload:{name,message,orgData:this._cacheBuffer}}))}_feed(direction,buffer,extraArgs){const middlewares=this.getMiddlewares(direction);const isUdp=this._isPipingUdp;const direct=(buf,isReverse=false)=>this.emit(isReverse?`post_${-direction}`:`post_${direction}`,buf);const event=`next_${direction}`;const first=middlewares[0];if(!first.hasListener(event)){const last=middlewares.reduce((prev,next)=>{prev.on(event,buf=>next.write({direction,buffer:buf,direct,isUdp},extraArgs));return next});last.on(event,direct)}first.write({direction,buffer,direct,isUdp},extraArgs)}}exports.Pipe=Pipe;