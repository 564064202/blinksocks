'use strict';Object.defineProperty(exports,'__esModule',{value:true});exports.Balancer=undefined;var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _net=require('net');var _net2=_interopRequireDefault(_net);var _winston=require('winston');var _winston2=_interopRequireDefault(_winston);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}var QUERY_INTERVAL=12e4;var now=function now(){return new Date().getTime()};var Balancer=exports.Balancer=function(){function Balancer(){_classCallCheck(this,Balancer)}_createClass(Balancer,null,[{key:'init',value:function init(servers){var interval=arguments.length>1&&arguments[1]!==undefined?arguments[1]:QUERY_INTERVAL;this._servers=servers;this._pings=this._servers.map(function(){return 0});this._startQuery(interval)}},{key:'destroy',value:function destroy(){this._stopQuery()}},{key:'getFastest',value:function getFastest(){var index=0;var pings=this._pings;for(var i=0;i<pings.length;++i){var ping=pings[i];if(ping>0&&ping<pings[index]||pings[index]<=0){index=i}}return this._servers[index]}},{key:'_startQuery',value:function _startQuery(interval){var _this=this;if(this._servers.length>1){this._timer=setInterval(function(){return _this._query()},interval);this._query()}}},{key:'_stopQuery',value:function _stopQuery(){clearInterval(this._timer)}},{key:'_query',value:function _query(){var _this2=this;this._servers.map(function(server,i){var _server=JSON.stringify(server);_winston2.default.verbose('[balancer]: querying '+_server);var startTime=now();var socket=_net2.default.connect(server,function(){var ping=now()-startTime;_this2._pings[i]=ping;_winston2.default.verbose('[balancer]: '+_server+' = '+ping+'ms');socket.end()});socket.on('error',function(){_this2._pings[i]=-1;_winston2.default.warn('[balancer]: '+_server+' lost connection')})})}}]);return Balancer}();Balancer._servers=[];Balancer._pings=[];Balancer._timer=null;