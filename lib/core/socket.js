'use strict';Object.defineProperty(exports,'__esModule',{value:true});exports.Socket=undefined;var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i['return'])_i['return']()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr)){return arr}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i)}else{throw new TypeError('Invalid attempt to destructure non-iterable instance')}}}();var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _net=require('net');var _net2=_interopRequireDefault(_net);var _winston=require('winston');var _winston2=_interopRequireDefault(_winston);var _dnsCache=require('./dns-cache');var _balancer=require('./balancer');var _pipe=require('./pipe');var _middleware=require('./middleware');var _utils=require('../utils');var _actions=require('../presets/actions');var _socks=require('../proxies/socks5');var _socks2=require('../proxies/socks4');var _http=require('../proxies/http');var _common=require('../proxies/common');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _asyncToGenerator(fn){return function(){var gen=fn.apply(this,arguments);return new Promise(function(resolve,reject){function step(key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{return Promise.resolve(value).then(function(value){step('next',value)},function(err){step('throw',err)})}}return step('next')})}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}var dnsCache=_dnsCache.DNSCache.create();var lastEndPoint=null;var Socket=exports.Socket=function(){function Socket(_ref){var _this=this;var id=_ref.id,socket=_ref.socket;_classCallCheck(this,Socket);this._id=null;this._bsocket=null;this._fsocket=null;this._socksTcpReady=false;this._socksUdpReady=false;this._httpReady=false;this._pipe=null;this._id=id;this._bsocket=socket;this._bsocket.on('error',function(err){return _this.onError(err)});this._bsocket.on('close',function(had_error){return _this.onClose(had_error)});this._bsocket.on('data',function(buffer){return _this.onForward(buffer)});this.onError=this.onError.bind(this);this.onClose=this.onClose.bind(this);this.onForward=this.onForward.bind(this);this.onBackward=this.onBackward.bind(this);if(__IS_SERVER__){this.createPipe()}}_createClass(Socket,[{key:'isHandshakeDone',value:function isHandshakeDone(){return[this._socksTcpReady,this._socksUdpReady,this._httpReady].some(function(v){return!!v})}},{key:'onForward',value:function onForward(buffer){if(__IS_CLIENT__&&!this.isHandshakeDone()){this.onHandshake(buffer);return}var _buffer=buffer;if(__IS_CLIENT__&&this._socksUdpReady){var request=_socks.UdpRequestMessage.parse(buffer);if(request!==null){_buffer=request.DATA}else{_winston2.default.warn('['+this._id+'] -x-> dropped unidentified packet '+buffer.length+' bytes');return}}try{this._pipe.feed(__IS_CLIENT__?_middleware.MIDDLEWARE_DIRECTION_UPWARD:_middleware.MIDDLEWARE_DIRECTION_DOWNWARD,_buffer)}catch(err){_winston2.default.error('['+this._id+']',err)}}},{key:'onBackward',value:function onBackward(buffer){try{this._pipe.feed(__IS_CLIENT__?_middleware.MIDDLEWARE_DIRECTION_DOWNWARD:_middleware.MIDDLEWARE_DIRECTION_UPWARD,buffer)}catch(err){_winston2.default.error('['+this._id+']',err)}}},{key:'onError',value:function onError(err){switch(err.code){case'ECONNREFUSED':case'EADDRNOTAVAIL':case'ENETDOWN':case'ECONNRESET':case'ETIMEDOUT':case'EAI_AGAIN':case'EPIPE':_winston2.default.warn('['+this._id+'] '+err.message);return;default:_winston2.default.error(err);break;}}},{key:'onClose',value:function onClose(){if(this._bsocket!==null&&!this._bsocket.destroyed){this._bsocket.end();this._bsocket=null;_winston2.default.info('['+this._id+'] downstream closed')}if(this._fsocket!==null&&!this._fsocket.destroyed){this._fsocket.end();this._fsocket=null;_winston2.default.info('['+this._id+'] upstream closed')}}},{key:'send',value:function send(buffer,flag){if(flag){this._fsocket&&this._fsocket.write(buffer)}else{this._bsocket&&this._bsocket.write(buffer)}}},{key:'connectTo',value:function(){var _ref3=_asyncToGenerator(regeneratorRuntime.mark(function _callee(_ref2,callback){var host=_ref2.host,port=_ref2.port;var ip;return regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_winston2.default.info('['+this._id+'] connecting to:',{host:host,port:port});_context.prev=1;_context.next=4;return dnsCache.get(host);case 4:ip=_context.sent;this._fsocket=_net2.default.connect({host:ip,port:port},callback);this._fsocket.on('error',this.onError);this._fsocket.on('close',this.onClose);this._fsocket.on('data',this.onBackward);_context.next=14;break;case 11:_context.prev=11;_context.t0=_context['catch'](1);_winston2.default.error(_context.t0.message);case 14:case'end':return _context.stop();}}},_callee,this,[[1,11]])}));function connectTo(_x,_x2){return _ref3.apply(this,arguments)}return connectTo}()},{key:'createPipe',value:function createPipe(addr){var _this2=this;var pipeProps={onNotified:function onNotified(action){if(__IS_SERVER__&&action.type===_actions.SOCKET_CONNECT_TO_DST){var _action$payload=_slicedToArray(action.payload,2),_addr=_action$payload[0],callback=_action$payload[1];return _this2.connectTo(_addr,callback)}if(action.type===_actions.PROCESSING_FAILED){var message=action.payload;var timeout=_utils.Utils.getRandomInt(10,40);_winston2.default.error('connection will be closed in '+timeout+'s due to: '+message);setTimeout(function(){return _this2.onClose()},timeout*1e3)}}};this._pipe=new _pipe.Pipe(pipeProps);this._pipe.setMiddlewares(_middleware.MIDDLEWARE_DIRECTION_UPWARD,[(0,_middleware.createMiddleware)(_middleware.MIDDLEWARE_TYPE_FRAME,[addr]),(0,_middleware.createMiddleware)(_middleware.MIDDLEWARE_TYPE_CRYPTO),(0,_middleware.createMiddleware)(_middleware.MIDDLEWARE_TYPE_PROTOCOL),(0,_middleware.createMiddleware)(_middleware.MIDDLEWARE_TYPE_OBFS)]);this._pipe.on('next_'+_middleware.MIDDLEWARE_DIRECTION_UPWARD,function(buf){return _this2.send(buf,__IS_CLIENT__)});this._pipe.on('next_'+_middleware.MIDDLEWARE_DIRECTION_DOWNWARD,function(buf){return _this2.send(buf,__IS_SERVER__)})}},{key:'onHandshake',value:function onHandshake(buffer){this.trySocksHandshake(this._bsocket,buffer);if(!this.isHandshakeDone()){this.tryHttpHandshake(this._bsocket,buffer)}}},{key:'onHandshakeDone',value:function onHandshakeDone(addr,callback){var _this3=this;var ep=_balancer.Balancer.getFastest();if(lastEndPoint!==null&&(ep.host!==lastEndPoint.host||ep.port!==lastEndPoint.port)){_winston2.default.info('balancer switch to use:',ep)}lastEndPoint=ep;return this.connectTo(ep,function(){_this3.createPipe(addr);callback()})}},{key:'trySocksHandshake',value:function trySocksHandshake(socket,buffer){if(!this.isHandshakeDone()){this.trySocks5Handshake(socket,buffer)}if(!this.isHandshakeDone()){this.trySocks4Handshake(socket,buffer)}}},{key:'trySocks4Handshake',value:function trySocks4Handshake(socket,buffer){var _this4=this;var request=_socks2.RequestMessage.parse(buffer);if(request!==null){var CMD=request.CMD,DSTIP=request.DSTIP,DSTADDR=request.DSTADDR,DSTPORT=request.DSTPORT;if(CMD===_common.REQUEST_COMMAND_CONNECT){var addr={type:DSTADDR.length>0?_common.ATYP_DOMAIN:_common.ATYP_V4,host:DSTADDR.length>0?DSTADDR:DSTIP,port:DSTPORT};this.onHandshakeDone(addr,function(){var message=new _socks2.ReplyMessage({CMD:_common.REPLY_GRANTED});socket.write(message.toBuffer());_this4._socksTcpReady=true})}}}},{key:'trySocks5Handshake',value:function trySocks5Handshake(socket,buffer){var _this5=this;var identifier=_socks.IdentifierMessage.parse(buffer);if(identifier!==null){var message=new _socks.SelectMessage;socket.write(message.toBuffer());return}var request=_socks.RequestMessage.parse(buffer);if(request!==null){var type=request.CMD;switch(type){case _common.REQUEST_COMMAND_UDP:case _common.REQUEST_COMMAND_CONNECT:{var addr={type:request.ATYP,host:request.DSTADDR,port:request.DSTPORT};this.onHandshakeDone(addr,function(){var message=new _socks.ReplyMessage({REP:_common.REPLY_SUCCEEDED});socket.write(message.toBuffer());if(type===_common.REQUEST_COMMAND_CONNECT){_this5._socksTcpReady=true}else{_this5._socksUdpReady=true}});break}default:{var _message=new _socks.ReplyMessage({REP:_common.REPLY_COMMAND_NOT_SUPPORTED});socket.write(_message.toBuffer());break}}}}},{key:'tryHttpHandshake',value:function tryHttpHandshake(socket,buffer){var _this6=this;var request=_http.HttpRequestMessage.parse(buffer);if(request!==null){var METHOD=request.METHOD,HOST=request.HOST;var addr=_utils.Utils.parseURI(HOST.toString());this.onHandshakeDone(addr,function(){if(METHOD.toString()==='CONNECT'){var message=new _http.ConnectReplyMessage;socket.write(message.toBuffer())}else{_this6.onForward(buffer)}_this6._httpReady=true})}}}]);return Socket}();